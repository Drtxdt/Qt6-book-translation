---
prev:
  text: '17. æ¨¡å‹è§†å›¾æ¶æ„ â€”â€” æ¨¡å‹è§†å›¾æ§åˆ¶å™¨'
  link: '/ModelViewArchitecture/17'
next:
  text: '19. ä½¿ç”¨numpyå’Œpandaså¤„ç†æ¨¡å‹è§†å›¾ä¸­çš„è¡¨æ ¼æ•°æ®'
  link: '/ModelViewArchitecture/19'
---

## 18. ä¸€ä¸ªç®€å•çš„æ¨¡å‹è§†å›¾â€”â€”å¾…åŠäº‹é¡¹åˆ—è¡¨

ä¸ºäº†æ¼”ç¤ºå¦‚ä½•åœ¨å®é™…ä¸­ä½¿ç”¨ ModelViews ï¼Œæˆ‘ä»¬å°†å®ç°ä¸€ä¸ªéå¸¸ç®€å•çš„æ¡Œé¢å¾…åŠäº‹é¡¹åˆ—è¡¨ã€‚è¯¥åˆ—è¡¨å°†åŒ…å«ä¸€ä¸ª `QListView` ç”¨äºæ˜¾ç¤ºå¾…åŠäº‹é¡¹åˆ—è¡¨ï¼Œä¸€ä¸ª `QLineEdit` ç”¨äºè¾“å…¥æ–°äº‹é¡¹ï¼Œä»¥åŠä¸€ç»„æŒ‰é’®ç”¨äºæ·»åŠ ã€åˆ é™¤æˆ–æ ‡è®°äº‹é¡¹ä¸ºå·²å®Œæˆã€‚

![tips](tips.png)

> æœ¬ç¤ºä¾‹çš„æ–‡ä»¶ä½äºæºä»£ç ä¸­ã€‚

## ç”¨æˆ·ç•Œé¢

è¯¥ç®€æ´çš„ç”¨æˆ·ç•Œé¢ä½¿ç”¨Qt Creatorè¿›è¡Œå¸ƒå±€ï¼Œå¹¶ä¿å­˜ä¸º `mainwindow.ui` æ–‡ä»¶ã€‚è¯¥ `.ui` æ–‡ä»¶å·²åŒ…å«åœ¨æœ¬ä¹¦çš„ä¸‹è½½å†…å®¹ä¸­ã€‚

![Figure134](Figure134.png)

> å›¾134ï¼šåœ¨Qt Creatorä¸­è®¾è®¡ç”¨æˆ·ç•Œé¢

è¯·æ‚¨æŒ‰ç…§ä¹‹å‰æ‰€è¿°ï¼Œä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·å°† `.ui` æ–‡ä»¶è½¬æ¢ä¸º Python æ–‡ä»¶ã€‚

è¿™å°†ç”Ÿæˆä¸€ä¸ªåä¸º `MainWindow.py` çš„æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«æˆ‘ä»¬åœ¨ Qt Designer ä¸­è®¾è®¡çš„è‡ªå®šä¹‰çª—å£ç±»ã€‚è¯¥æ–‡ä»¶å¯åƒæ™®é€šæ–‡ä»¶ä¸€æ ·å¯¼å…¥åˆ°æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä»£ç ä¸­â€”â€”ä¸€ä¸ªç”¨äºæ˜¾ç¤ºç”¨æˆ·ç•Œé¢çš„åŸºæœ¬éª¨æ¶åº”ç”¨ç¨‹åºç¤ºä¾‹å¦‚ä¸‹æ‰€ç¤ºï¼š

*Listing 95. model-views/todo_skeleton.py*

```python
import sys

from PyQt6 import QtCore, QtGui, QtWidgets
from PyQt6.QtCore import Qt

from MainWindow import Ui_MainWindow


class MainWindow(QtWidgets.QMainWindow, Ui_MainWindow):
    def __init__(self):
        super().__init__()
        self.setupUi(self)
        
        
app = QtWidgets.QApplication(sys.argv)
window = MainWindow()
window.show()
app.exec()
```

> ğŸš€ **è¿è¡Œå®ƒå§ï¼** æ‚¨ä¼šçœ‹åˆ°çª—å£å¼¹å‡ºï¼Œä¸è¿‡ç›®å‰è¿˜æ— æ³•ä½¿ç”¨ä»»ä½•åŠŸèƒ½

![Figure135](Figure135.png)

> å›¾135ï¼šä¸»çª—å£

ç•Œé¢ä¸­çš„æ§ä»¶è¢«èµ‹äºˆäº†ä¸‹è¡¨ä¸­æ‰€ç¤ºçš„ IDï¼š

| å¯¹è±¡åç§°         | ç±»å‹          | æè¿°                                             |
| ---------------- | ------------- | ------------------------------------------------ |
| `todoView`       | `QListView`   | å½“å‰å¾…åŠäº‹é¡¹åˆ—è¡¨                                 |
| `todoEdit`       | `QLineEdit`   | åˆ›å»ºæ–°å¾…åŠäº‹é¡¹çš„æ–‡æœ¬è¾“å…¥æ¡†                       |
| `addButton`      | `QPushButton` | åˆ›å»ºæ–°çš„å¾…åŠäº‹é¡¹ï¼Œå°†å…¶æ·»åŠ åˆ°å¾…åŠäº‹é¡¹åˆ—è¡¨ä¸­       |
| `deleteButton`   | `QPushButton` | åˆ é™¤å½“å‰é€‰ä¸­çš„å¾…åŠäº‹é¡¹ï¼Œå°†å…¶ä»å¾…åŠäº‹é¡¹åˆ—è¡¨ä¸­ç§»é™¤ |
| `completeButton` | `QPushButton` | å°†å½“å‰é€‰ä¸­çš„å¾…åŠäº‹é¡¹æ ‡è®°ä¸ºå·²å®Œæˆ                 |

æˆ‘ä»¬å°†ä½¿ç”¨è¿™äº›æ ‡è¯†ç¬¦åœ¨åç»­æ­¥éª¤ä¸­ä¸åº”ç”¨ç¨‹åºé€»è¾‘è¿›è¡Œå…³è”ã€‚

## æ¨¡å‹

æˆ‘ä»¬é€šè¿‡ä»åŸºç¡€å®ç°ç±»ç»§æ‰¿æ¥å®šä¹‰è‡ªå®šä¹‰æ¨¡å‹ï¼Œä»è€Œèƒ½å¤Ÿä¸“æ³¨äºæ¨¡å‹ä¸­ç‹¬ç‰¹çš„éƒ¨åˆ†ã€‚Qt æä¾›äº†å¤šç§ä¸åŒçš„æ¨¡å‹åŸºç¡€ç±»ï¼ŒåŒ…æ‹¬åˆ—è¡¨ã€æ ‘å’Œè¡¨æ ¼ï¼ˆé€‚ç”¨äºç”µå­è¡¨æ ¼ï¼‰ã€‚

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†ç»“æœæ˜¾ç¤ºåˆ° `QListView` ä¸­ã€‚ä¸æ­¤å¯¹åº”çš„åŸºç¡€æ¨¡å‹æ˜¯  `QAbstractListModel`ã€‚æˆ‘ä»¬çš„æ¨¡å‹è½®å»“å®šä¹‰å¦‚ä¸‹ï¼š

*Listing 96. model-views/todo_1.py*

```python
class TodoModel(QAbstractListModel):
    def __init__(self, todos=None):
        super().__init__()
        self.todos = todos or []
        
    def data(self, index, role):
        if role == Qt.ItemDataRole.DisplayRole:
            status, text = self.todos[index.row()]
            return text
        
    def rowCount(self, index):
        return len(self.todos)
```

`.todos` å˜é‡æ˜¯æˆ‘ä»¬çš„æ•°æ®å­˜å‚¨ã€‚`rowcount()` å’Œ `data()` æ–¹æ³•æ˜¯åˆ—è¡¨æ¨¡å‹å¿…é¡»å®ç°çš„æ ‡å‡†æ¨¡å‹æ–¹æ³•ã€‚æˆ‘ä»¬å°†åœ¨ä¸‹é¢ä¾æ¬¡ä»‹ç»è¿™äº›æ–¹æ³•ã€‚

### .todos list

æˆ‘ä»¬çš„æ¨¡å‹æ•°æ®å­˜å‚¨ä¸º `.todos`ï¼Œè¿™æ˜¯ä¸€ä¸ªç®€å•çš„ Python åˆ—è¡¨ï¼Œå…¶ä¸­æˆ‘ä»¬å°†å­˜å‚¨ä¸€ä¸ªå…ƒç»„ï¼Œæ ¼å¼ä¸º `[(bool, str), (bool, str), (bool, str)]`ï¼Œå…¶ä¸­ `bool` è¡¨ç¤ºæ¡ç›®çš„å®ŒæˆçŠ¶æ€ï¼Œ`str` è¡¨ç¤ºå¾…åŠäº‹é¡¹çš„æ–‡æœ¬å†…å®¹ã€‚

æˆ‘ä»¬åœ¨å¯åŠ¨æ—¶å°† `self.todo` åˆå§‹åŒ–ä¸ºç©ºåˆ—è¡¨ï¼Œé™¤éé€šè¿‡ `todos` å…³é”®å­—å‚æ•°ä¼ å…¥äº†ä¸€ä¸ªåˆ—è¡¨ã€‚

![tips](tips.png)

> å¦‚æœæä¾›çš„ `todos` ä¸ºçœŸï¼ˆå³é™¤ç©ºåˆ—è¡¨ã€å¸ƒå°”å€¼ `False` æˆ–é»˜è®¤å€¼ None ä»¥å¤–çš„ä»»ä½•å€¼ï¼‰ï¼Œ`self.todos = todos or []` å°±ä¼šå°† `self.todos` è®¾ç½®ä¸ºè¿™ä¸ªå€¼ï¼Œå¦åˆ™ä¼šå°†å…¶è®¾ç½®ä¸ºç©ºåˆ—è¡¨ `[]`ã€‚

è¦åˆ›å»ºæ­¤æ¨¡å‹çš„å®ä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

```python
model = TodoModel() #åˆ›å»ºä¸€ä¸ªç©ºçš„å¾…åŠäº‹é¡¹åˆ—è¡¨
```

æˆ–è€…ä¼ é€’ä¸€ä¸ªç°æœ‰çš„åˆ—è¡¨ï¼š

```python
todos = [(False, 'an item'), (False, 'another item')]
model = TodoModel(todos)
```

### .rowcount()

`.rowcount()` æ–¹æ³•ç”±è§†å›¾è°ƒç”¨ï¼Œç”¨äºè·å–å½“å‰æ•°æ®ä¸­çš„è¡Œæ•°ã€‚è§†å›¾éœ€è¦æ­¤ä¿¡æ¯ä»¥ç¡®å®šå…¶å¯ä»æ•°æ®å­˜å‚¨ä¸­è¯·æ±‚çš„æœ€å¤§ç´¢å¼•ï¼ˆ`rowcount - 1`ï¼‰ã€‚ç”±äºæˆ‘ä»¬ä½¿ç”¨ Python åˆ—è¡¨ä½œä¸ºæ•°æ®å­˜å‚¨ï¼Œè¯¥æ–¹æ³•çš„è¿”å›å€¼å³ä¸ºåˆ—è¡¨çš„ `len()` å€¼ã€‚

### .data()

è¿™æ˜¯æ¨¡å‹çš„æ ¸å¿ƒï¼Œå®ƒå¤„ç†æ¥è‡ªè§†å›¾çš„æ•°æ®è¯·æ±‚ï¼Œå¹¶è¿”å›ç›¸åº”çš„ç»“æœã€‚å®ƒæ¥æ”¶ä¸¤ä¸ªå‚æ•° `index` å’Œ `role`ã€‚

`index` æ˜¯è§†å›¾è¯·æ±‚çš„æ•°æ®çš„ä½ç½®/åæ ‡ï¼Œå¯é€šè¿‡ä¸¤ç§æ–¹æ³• `.row()` å’Œ `.column()` è·å–æ¯ä¸ªç»´åº¦ä¸­çš„ä½ç½®ã€‚å¯¹äºåˆ—è¡¨è§†å›¾ï¼Œåˆ—å¯ä»¥å¿½ç•¥ã€‚

![tips](tips.png)

> å¯¹äºæˆ‘ä»¬çš„ `QListView`ï¼Œåˆ—å§‹ç»ˆä¸º0ï¼Œå¯ä»¥å¿½ç•¥ã€‚ä½†æ˜¯ï¼Œå¯¹äº2Dæ•°æ®ï¼Œä¾‹å¦‚åœ¨ç”µå­è¡¨æ ¼è§†å›¾ä¸­ï¼Œæ‚¨éœ€è¦ä½¿ç”¨æ­¤åˆ—ã€‚

`role` æ˜¯ä¸€ä¸ªæ ‡å¿—ï¼ŒæŒ‡ç¤ºè§†å›¾è¯·æ±‚çš„æ•°æ®ç±»å‹ã€‚è¿™æ˜¯å› ä¸º `.data()` æ–¹æ³•å®é™…ä¸Šæ‰¿æ‹…çš„è´£ä»»ä¸ä»…ä»…æ˜¯æ ¸å¿ƒæ•°æ®ã€‚å®ƒè¿˜å¤„ç†æ ·å¼ä¿¡æ¯ã€å·¥å…·æç¤ºã€çŠ¶æ€æ ç­‰è¯·æ±‚â€”â€”åŸºæœ¬ä¸Šæ˜¯ä»»ä½•å¯ä»¥ç”±æ•°æ®æœ¬èº«æä¾›çš„ä¿¡æ¯ã€‚

`Qt.ItemDataRole.DisplayRole` çš„å‘½åæœ‰äº›å¥‡æ€ªï¼Œä½†è¿™è¡¨æ˜è§†å›¾æ­£åœ¨å‘æˆ‘ä»¬è¯·æ±‚â€œè¯·æä¾›è¦æ˜¾ç¤ºçš„æ•°æ®â€ã€‚`data` è¿˜å¯ä»¥æ¥æ”¶å…¶ä»–è§’è‰²ï¼Œä»¥è¿›è¡Œæ ·å¼è®¾ç½®æˆ–è¯·æ±‚â€œå¯ç¼–è¾‘â€æ ¼å¼çš„æ•°æ®ã€‚

| è§’è‰²                             | å€¼   | æè¿°                                                         |
| -------------------------------- | ---- | ------------------------------------------------------------ |
| `Qt.ItemDataRole.DisplayRole`    | `0`  | ä»¥æ–‡æœ¬å½¢å¼æ¸²æŸ“çš„å…³é”®æ•°æ®ã€‚ [QString](https://doc.qt.io/qt-5/qstring.html) |
| `Qt.ItemDataRole.DecorationRole` | `1`  | è¦ä»¥å›¾æ ‡å½¢å¼æ¸²æŸ“ä¸ºè£…é¥°çš„æ•°æ®ã€‚[QColor](https://doc.qt.io/qt-5/qcolor.html)ã€[QIcon](https://doc.qt.io/qt-5/qicon.html) æˆ– [QPixmap](https://doc.qt.io/qt-5/qpixmap.html) |
| `Qt.ItemDataRole.EditRole`       | `2`  | ä»¥é€‚åˆåœ¨ç¼–è¾‘å™¨ä¸­ç¼–è¾‘çš„æ ¼å¼å‘ˆç°çš„æ•°æ®ã€‚ [QString](https://doc.qt.io/qt-5/qstring.html) |
| `Qt.ItemDataRole.ToolTipRole`    | `3`  | é¡¹ç›®å·¥å…·æç¤ºä¸­æ˜¾ç¤ºçš„æ•°æ®. [QString](https://doc.qt.io/qt-5/qstring.html) |
| `Qt.ItemDataRole.StatusTipRole`  | `4`  | çŠ¶æ€æ ä¸­æ˜¾ç¤ºçš„æ•°æ®.[QString](https://doc.qt.io/qt-5/qstring.html) |
| `Qt.ItemDataRole.WhatsThisRole`  | `5`  | åœ¨â€œè¿™æ˜¯ä»€ä¹ˆï¼Ÿâ€æ¨¡å¼ä¸‹æ˜¾ç¤ºçš„é¡¹ç›®æ•°æ®.[QString](https://doc.qt.io/qt-5/qstring.html) |
| `Qt.ItemDataRole.SizeHintRole`   | `13` | ç”¨äºæä¾›ç»™è§†å›¾çš„é¡¹çš„å°ºå¯¸æç¤º. [Qsize](https://doc.qt.io/qt-5/qsize.html) |

è¦æŸ¥çœ‹å¯ç”¨çš„æ‰€æœ‰è§’è‰²åˆ—è¡¨ï¼Œè¯·å‚é˜… [Qt ItemDataRole æ–‡æ¡£](https://doc.qt.io/qt-5/qt.html#ItemDataRole-enum)ã€‚æˆ‘ä»¬çš„å¾…åŠäº‹é¡¹åˆ—è¡¨ä»…ä½¿ç”¨ `Qt.ItemDataRole.DisplayRole` å’Œ `Qt.ItemDataRole.DecorationRole`ã€‚

## åŸºæœ¬å®ç°

ä¸‹é¢çš„ä»£ç å±•ç¤ºäº†æˆ‘ä»¬åœ¨åº”ç”¨ç¨‹åºéª¨æ¶ä¸­åˆ›å»ºçš„åŸºæœ¬æ¨¡å‹ï¼Œè¯¥æ¨¡å‹åŒ…å«å°†æ¨¡å‹æ˜¾ç¤ºåœ¨ç•Œé¢çš„å¿…è¦ä»£ç â€”â€”å°½ç®¡ç›®å‰å®ƒæ˜¯ç©ºçš„ï¼æˆ‘ä»¬å°†åœ¨æ­¤åŸºç¡€ä¸Šæ·»åŠ æ¨¡å‹ä»£ç å’Œåº”ç”¨ç¨‹åºé€»è¾‘ã€‚

*Listing 97. model-views/todo_1b.py*

```python
import sys

from PyQt6.QtCore import QAbstractListModel, Qt
from PyQt6.QtWidgets import QApplication, QMainWindow

from MainWindow import Ui_MainWindow


class TodoModel(QAbstractListModel):
    def __init__(self, todos=None):
        super().__init__()
        self.todos = todos or []
        
    def data(self, index, role):
        if role == Qt.ItemDataRole.DisplayRole:
            status, text = self.todos[index.row()]
            return text
        
    def rowCount(self, index):
        return len(self.todos)
    
class MainWindow(QMainWindow, Ui_MainWindow):
    def __init__(self):
        super().__init__()
        self.setupUi(self)
        self.model = TodoModel()
        self.todoView.setModel(self.model)
        
        
app = QApplication(sys.argv)
window = MainWindow()
window.show()
app.exec()
```

æˆ‘ä»¬æŒ‰ç…§ä¹‹å‰çš„æ–¹å¼å®šä¹‰`TodoModel` å¹¶åˆå§‹åŒ– `MainWindow` å¯¹è±¡ã€‚åœ¨ `MainWindow` çš„`__init__`æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬åˆ›å»º `TodoModel` çš„å®ä¾‹å¹¶å°†å…¶è®¾ç½®ä¸º `todo_view`ã€‚å°†æ­¤æ–‡ä»¶ä¿å­˜ä¸º `todo.py` å¹¶ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿è¡Œï¼š

```python
python3 todo.py
```

è™½ç„¶ç›®å‰è¿˜çœ‹ä¸åˆ°å¤ªå¤šå†…å®¹ï¼Œä½† `QListView` å’Œæˆ‘ä»¬çš„æ¨¡å‹å®é™…ä¸Šå·²ç»å¼€å§‹å·¥ä½œäº†ã€‚å¦‚æœæ‚¨åœ¨`MainWindow` ç±»ä¸­çš„ `TodoModel` ä¸­æ·»åŠ ä¸€äº›é»˜è®¤æ•°æ®ï¼Œæ‚¨å°±ä¼šçœ‹åˆ°å®ƒå‡ºç°åœ¨åˆ—è¡¨ä¸­ã€‚

```python
self.model = TodoModel(todos=[(False, 'my first todo')])
```

![Figure136](Figure136.png)

> å›¾136ï¼šQListView æ˜¾ç¤ºç¡¬ç¼–ç çš„å¾…åŠäº‹é¡¹

æ‚¨å¯ä»¥ç»§ç»­æ‰‹åŠ¨æ·»åŠ é¡¹ç›®ï¼Œå®ƒä»¬å°†æŒ‰é¡ºåºæ˜¾ç¤ºåœ¨ `QListView` ä¸­ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†å®ç°ä»åº”ç”¨ç¨‹åºå†…éƒ¨æ·»åŠ é¡¹ç›®çš„åŠŸèƒ½ã€‚

é¦–å…ˆåœ¨ `MainWindow` ä¸Šåˆ›å»ºä¸€ä¸ªåä¸º `add` çš„æ–°æ–¹æ³•ã€‚è¿™æ˜¯æˆ‘ä»¬çš„å›è°ƒå‡½æ•°ï¼Œå®ƒå°†è´Ÿè´£å°†è¾“å…¥ä¸­çš„å½“å‰æ–‡æœ¬ä½œä¸ºæ–°å¾…åŠäº‹é¡¹æ·»åŠ ã€‚å°†æ­¤æ–¹æ³•è¿æ¥åˆ° `__init__` å—æœ«å°¾çš„ `addButton.pressed` ä¿¡å·ã€‚

*Listing 98. model-views/todo_2.py*

```python
class MainWindow(QMainWindow, Ui_MainWindow):
    def __init__(self):
        super().__init__()
        self.setupUi(self)
        self.model = TodoModel()
        self.todoView.setModel(self.model)
        # è¿æ¥åˆ°æŒ‰é’®.
        self.addButton.pressed.connect(self.add)
        
    def add(self):
        """
        å°†ä¸€é¡¹å†…å®¹æ·»åŠ åˆ°æˆ‘ä»¬çš„å¾…åŠäº‹é¡¹åˆ—è¡¨ä¸­ï¼Œä» QLineEdit .todoEdit ä¸­è·å–æ–‡æœ¬ï¼Œç„¶åæ¸…é™¤å®ƒã€‚
        """
        text = self.todoEdit.text()
        # æ¸…æ¥šå­—ç¬¦ä¸²æœ«å°¾çš„å°¾éšç©ºæ ¼
        text = text.strip()
        if text: # ä¸è¦æ·»åŠ ç©ºå­—ç¬¦ä¸²
            # é€šè¿‡æ¨¡å‹è®¿é—®è¯¥åˆ—è¡¨
            self.model.todos.append((False, text))
            # è§¦å‘åˆ·æ–°
            self.model.layoutChanged.emit() #1
            # æ¸…ç©ºè¾“å…¥(input)
            self.todoEdit.setText("")
```

> 1. è¿™é‡Œï¼Œæˆ‘ä»¬å‘å‡ºä¸€ä¸ªæ¨¡å‹ä¿¡å· `.layoutChanged`ï¼Œè®©è§†å›¾çŸ¥é“æ•°æ®çš„å½¢çŠ¶å·²ç»æ”¹å˜ã€‚è¿™ä¼šè§¦å‘æ•´ä¸ªè§†å›¾çš„åˆ·æ–°ã€‚å¦‚æœæ‚¨çœç•¥äº†è¿™ä¸€è¡Œï¼Œå¾…åŠäº‹é¡¹ä»ç„¶ä¼šè¢«æ·»åŠ ï¼Œä½† `QListView` ä¸ä¼šæ›´æ–°ã€‚

å¦‚æœåªæ˜¯æ•°æ®å‘ç”Ÿäº†æ”¹å˜ï¼Œä½†è¡Œ/åˆ—æ•°æœªå—å½±å“ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ `.dataChanged()` ä¿¡å·ã€‚è¿™ä¹Ÿä¼šä½¿ç”¨å·¦ä¸Šè§’å’Œå³ä¸‹è§’çš„ä½ç½®æ¥å®šä¹‰æ•°æ®ä¸­å‘ç”Ÿæ”¹å˜çš„åŒºåŸŸï¼Œä»¥é¿å…é‡æ–°ç»˜åˆ¶æ•´ä¸ªè§†å›¾ã€‚

## è¿æ¥å…¶ä»–æ“ä½œ

ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥è¿æ¥æŒ‰é’®çš„å…¶ä½™ä¿¡å·ï¼Œå¹¶æ·»åŠ è¾…åŠ©å‡½æ•°æ¥æ‰§è¡Œåˆ é™¤å’Œå®Œæˆæ“ä½œã€‚æˆ‘ä»¬åƒä¹‹å‰ä¸€æ ·å°†æŒ‰é’®ä¿¡å·æ·»åŠ åˆ° `__init__` å—ä¸­ã€‚

```python
        self.addButton.pressed.connect(self.add)
        self.deleteButton.pressed.connect(self.delete)
        self.completeButton.pressed.connect(self.complete)
```

ç„¶åå®šä¹‰ä¸€ä¸ªæ–°çš„ `delete` æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤º â€”â€”

*Listing 99. model-views/todo_3.py*

```python
class MainWindow(QMainWindow, Ui_MainWindow):
    
    def delete(self):
        indexes = self.todoView.selectedIndexes()
        if indexes:
            # ç´¢å¼•æ˜¯ä¸€ä¸ªå•é€‰æ¨¡å¼ä¸‹çš„å•é¡¹åˆ—è¡¨
            index = indexes[0]
            # åˆ é™¤è¯¥é¡¹å¹¶åˆ·æ–°
            del self.model.todos[index.row()]
            self.model.layoutChanged.emit()
            # æ¸…é™¤é€‰ä¸­é¡¹ï¼ˆå› å…¶å·²ä¸å†æœ‰æ•ˆï¼‰
            self.todoView.clearSelection()
```

æˆ‘ä»¬ä½¿ç”¨ `self.todoView.selectedIndexes` æ¥è·å–ç´¢å¼•ï¼ˆå®é™…ä¸Šæ˜¯ä¸€ä¸ªå•é¡¹åˆ—è¡¨ï¼Œå› ä¸ºæˆ‘ä»¬å¤„äºå•é€‰æ¨¡å¼ï¼‰ï¼Œç„¶åä½¿ç”¨ `.row()` ä½œä¸ºç´¢å¼•è¿›å…¥æˆ‘ä»¬æ¨¡å‹ä¸Šçš„å¾…åŠäº‹é¡¹åˆ—è¡¨ã€‚æˆ‘ä»¬ä½¿ç”¨ Python çš„ `del` æ“ä½œç¬¦åˆ é™¤ç´¢å¼•é¡¹ï¼Œç„¶åè§¦å‘ `layoutChanged` ä¿¡å·ï¼Œå› ä¸ºæ•°æ®çš„å½¢çŠ¶å·²ç»å‘ç”Ÿäº†æ”¹å˜ã€‚

æœ€åï¼Œæˆ‘ä»¬æ¸…é™¤æ´»åŠ¨é€‰æ‹©ï¼Œå› ä¸ºæ‚¨é€‰æ‹©çš„é¡¹ç°åœ¨å·²ä¸å­˜åœ¨ï¼Œä¸”è¯¥ä½ç½®æœ¬èº«å¯èƒ½å·²è¶…å‡ºèŒƒå›´ï¼ˆå¦‚æœæ‚¨é€‰æ‹©äº†æœ€åä¸€ä¸ªé¡¹ï¼‰ã€‚

![tips](tips.png)

> æ‚¨å¯ä»¥è®©æ“ä½œæ›´æ™ºèƒ½ä¸€äº›ï¼Œæ”¹ä¸ºé€‰æ‹©åˆ—è¡¨ä¸­ç›¸é‚»çš„é¡¹ã€‚

`complete` æ–¹æ³•å¦‚ä¸‹æ‰€ç¤º â€”

*Listing 100. model-views/todo_4.py*

```python
class MainWindow(QMainWindow, Ui_MainWindow):
    def complete(self):
        indexes = self.todoView.selectedIndexes()
        if indexes:
            index = indexes[0]
            row = index.row()
            status, text = self.model.todos[row]
            self.model.todos[row] = (True, text)
            # .dataChanged æ–¹æ³•æ¥å—å·¦ä¸Šè§’å’Œå³ä¸‹è§’åæ ‡ï¼Œä¸”è¿™ä¸¤ä¸ªåæ ‡ç›¸ç­‰ã€‚
            # å¯¹äºå•ä¸€é€‰æ‹©ã€‚
            self.model.dataChanged.emit(index, index)
            # æ¸…é™¤é€‰ä¸­å†…å®¹ï¼ˆå› å…¶å·²ä¸å†æœ‰æ•ˆï¼‰ã€‚
            self.todoView.clearSelection()
```

è¿™ä¸åˆ é™¤æ“ä½œä½¿ç”¨ç›¸åŒçš„ç´¢å¼•ï¼Œä½†è¿™æ¬¡æˆ‘ä»¬ä»æ¨¡å‹ `.todos` åˆ—è¡¨ä¸­è·å–è¯¥é¡¹ï¼Œç„¶åå°†çŠ¶æ€æ›¿æ¢ä¸º `True`ã€‚

![tips](tips.png)

> æˆ‘ä»¬å¿…é¡»è¿›è¡Œè¿™ç§æŸ¥æ‰¾æ›¿æ¢æ“ä½œï¼Œå› ä¸ºæˆ‘ä»¬çš„æ•°æ®ä»¥Pythonå…ƒç»„çš„å½¢å¼å­˜å‚¨ï¼Œå…ƒç»„æ˜¯ä¸å¯å˜çš„ã€‚

ä¸æ ‡å‡† Qt æ§ä»¶çš„å…³é”®åŒºåˆ«åœ¨äºï¼Œæˆ‘ä»¬ç›´æ¥å¯¹æ•°æ®è¿›è¡Œæ›´æ”¹ï¼Œåªéœ€é€šçŸ¥ Qt å‘ç”Ÿäº†æŸäº›æ›´æ”¹å³å¯â€”â€”æ§ä»¶çŠ¶æ€çš„æ›´æ–°ç”±æ»‘å—è‡ªåŠ¨å®Œæˆã€‚

## ä½¿ç”¨ DecorationRole

å¦‚æœæ‚¨è¿è¡Œè¯¥åº”ç”¨ç¨‹åºï¼Œæ‚¨ä¼šå‘ç°æ·»åŠ å’Œåˆ é™¤åŠŸèƒ½å‡å¯æ­£å¸¸ä½¿ç”¨ï¼Œä½†å°½ç®¡å®Œæˆé¡¹çš„åŠŸèƒ½æ­£å¸¸ï¼Œè§†å›¾ä¸­å´æ²¡æœ‰ç›¸åº”çš„æ˜¾ç¤ºæç¤ºã€‚æˆ‘ä»¬éœ€è¦æ›´æ–°æ¨¡å‹ï¼Œä¸ºè§†å›¾æä¾›ä¸€ä¸ªæŒ‡ç¤ºå™¨ï¼Œç”¨äºæ˜¾ç¤ºé¡¹å·²å®Œæˆçš„çŠ¶æ€ã€‚æ›´æ–°åçš„æ¨¡å‹å¦‚ä¸‹æ‰€ç¤ºã€‚

*Listing 101. model-views/todo_5.py*

```python
import os

basedir = os.path.dirname(__file__)

tick = QImage(os.path.join(basedir, "tick.png"))

class TodoModel(QAbstractListModel):
    def __init__(self, *args, todos=None, **kwargs):
        super(TodoModel, self).__init__(*args, **kwargs)
        self.todos = todos or []
        
    def data(self, index, role):
        if role == Qt.ItemDataRole.DisplayRole:
            status, text = self.todos[index.row()]
            return text
        
        if role == Qt.ItemDataRole.DecorationRole:
            status, text = self.todos[index.row()]
            if status:
                return tick
            
     def rowCount(self, index):
        return len(self.todos)
```

![information](information.png)

> æˆ‘ä»¬ä½¿ç”¨ä¹‹å‰ä»‹ç»çš„ `basedir` æŠ€æœ¯åŠ è½½å›¾æ ‡ï¼Œä»¥ç¡®ä¿æ— è®ºè„šæœ¬åœ¨ä½•å¤„è¿è¡Œï¼Œè·¯å¾„éƒ½æ˜¯æ­£ç¡®çš„ã€‚æˆ‘ä½¿ç”¨çš„å›¾æ ‡æ¥è‡ª [p.yusukekamiyamane](http://p.yusukekamiyamane.com/) çš„Fugueå›¾æ ‡é›†ã€‚

æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå‹¾é€‰å›¾æ ‡ `tick.png` æ¥è¡¨ç¤ºå·²å®Œæˆçš„é¡¹ç›®ï¼Œå¹¶å°†è¯¥å›¾æ ‡åŠ è½½åˆ°åä¸º `tick` çš„ `QImage` å¯¹è±¡ä¸­ã€‚åœ¨æ¨¡å‹ä¸­ï¼Œæˆ‘ä»¬å®ç°äº†å¯¹ `Qt.ItemDataRole.DecorationRole` çš„å¤„ç†ç¨‹åºï¼Œè¯¥å¤„ç†ç¨‹åºä¼šä¸ºçŠ¶æ€ä¸º `True`ï¼ˆè¡¨ç¤ºå·²å®Œæˆï¼‰çš„è¡Œè¿”å›å‹¾é€‰å›¾æ ‡ã€‚

![tips](tips.png)

> é™¤äº†å›¾æ ‡ï¼Œæ‚¨è¿˜å¯ä»¥è¿”å›ä¸€ç§é¢œè‰²ï¼Œä¾‹å¦‚ï¼š`QtGui.QColor(â€˜greenâ€™)`ï¼Œå®ƒå°†è¢«ç»˜åˆ¶ä¸ºå®å¿ƒæ­£æ–¹å½¢ã€‚

è¿è¡Œè¯¥åº”ç”¨åï¼Œæ‚¨ç°åœ¨åº”è¯¥èƒ½å¤Ÿå°†é¡¹ç›®æ ‡è®°ä¸ºå·²å®Œæˆã€‚

![Figure137](Figure137.png)

> å›¾137ï¼šå…¨éƒ¨å®Œæˆ

## æŒä¹…åŒ–æ•°æ®å­˜å‚¨

æˆ‘ä»¬çš„å¾…åŠäº‹é¡¹åº”ç”¨ç¨‹åºè¿è¡Œè‰¯å¥½ï¼Œä½†å®ƒæœ‰ä¸€ä¸ªè‡´å‘½ç¼ºé™·â€”â€”å®ƒä¼šåœ¨æ‚¨å…³é—­åº”ç”¨ç¨‹åºåç«‹å³å¿˜è®°ä½ çš„å¾…åŠäº‹é¡¹ã€‚è™½ç„¶è®¤ä¸ºè‡ªå·±æ²¡æœ‰äº‹æƒ…å¯åšå¯èƒ½ä¼šå¸¦æ¥çŸ­æš‚çš„å¹³é™æ„Ÿï¼Œä½†ä»é•¿è¿œæ¥çœ‹ï¼Œè¿™å¯èƒ½ä¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ã€‚

è§£å†³æ–¹æ¡ˆæ˜¯å®ç°æŸç§æŒä¹…åŒ–æ•°æ®å­˜å‚¨ã€‚æœ€ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨ç®€å•çš„æ–‡ä»¶å­˜å‚¨ï¼Œæˆ‘ä»¬åœ¨å¯åŠ¨æ—¶ä»JSONæˆ–Pickleæ–‡ä»¶ä¸­åŠ è½½é¡¹ï¼Œå¹¶å†™å›ä»»ä½•æ›´æ”¹ã€‚

ä¸ºæ­¤ï¼Œæˆ‘ä»¬åœ¨ `MainWindow` ç±»ä¸­å®šä¹‰ä¸¤ä¸ªæ–°æ–¹æ³•â€”â€” `load` å’Œ `save` ã€‚è¿™ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«ä»åä¸º `data.json` çš„ JSON æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼Œåˆ™å¿½ç•¥æ–‡ä»¶ä¸å­˜åœ¨æ—¶çš„é”™è¯¯ï¼‰ä¸­åŠ è½½æ•°æ®åˆ°  `self.model.todos`ï¼Œå¹¶å°†å½“å‰çš„ `self.model.todos` å†™å…¥åˆ°åŒä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚

*Listing 102. model-views/todo_6.py*

```python
    def load(self):
        try:
            with open("data.json", "r") as f:
                self.model.todos = json.load(f)
        except Exception:
            pass
        
    def save(self):
        with open("data.json", "w") as f:
            data = json.dump(self.model.todos, f)
```

è¦æŒä¹…åŒ–æ•°æ®çš„æ›´æ”¹ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä»»ä½•ä¿®æ”¹æ•°æ®çš„æ–¹æ³•æœ«å°¾æ·»åŠ  `.save()` å¤„ç†ç¨‹åºï¼Œå¹¶åœ¨æ¨¡å‹åˆ›å»ºååœ¨ `__init__` å—ä¸­æ·»åŠ  `.load()` å¤„ç†ç¨‹åºã€‚

æœ€ç»ˆçš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºâ€”â€”

*Listing 103. mode-views/todo_complete.py*

```python
import json
import os
import sys

from PyQt6.QtCore import QAbstractListModel, Qt
from PyQt6.QtGui import QImage
from PyQt6.QtWidgets import QApplication, QMainWindow
from MainWindow import Ui_MainWindow

basedir = os.path.dirname(__file__)

tick = QImage(os.path.join(basedir, "tick.png"))


class TodoModel(QAbstractListModel):
    def __init__(self, todos=None):
        super().__init__()
        self.todos = todos or []
        
    def data(self, index, role):
        if role == Qt.ItemDataRole.DisplayRole:
            status, text = self.todos[index.row()]
            return text
        
        if role == Qt.ItemDataRole.DecorationRole:
            status, text = self.todos[index.row()]
            if status:
                return tick
            
    def rowCount(self, index):
        return len(self.todos)
    
    
class MainWindow(QMainWindow, Ui_MainWindow):
    def __init__(self):
        super().__init__()
        self.setupUi(self)
        self.model = TodoModel()
        self.load()
        self.todoView.setModel(self.model)
        self.addButton.pressed.connect(self.add)
        self.deleteButton.pressed.connect(self.delete)
        self.completeButton.pressed.connect(self.complete)
        
    def add(self):
        """
        å°†ä¸€é¡¹å†…å®¹æ·»åŠ åˆ°æˆ‘ä»¬çš„å¾…åŠäº‹é¡¹åˆ—è¡¨ä¸­ï¼Œä» QLineEdit .todoEdit ä¸­è·å–æ–‡æœ¬ï¼Œç„¶åæ¸…é™¤å®ƒã€‚
        """
        text = self.todoEdit.text()
        # æ¸…æ¥šå­—ç¬¦ä¸²æœ«å°¾çš„å°¾éšç©ºæ ¼
        text = text.strip()
        if text: # ä¸è¦æ·»åŠ ç©ºå­—ç¬¦ä¸²
            # é€šè¿‡æ¨¡å‹è®¿é—®è¯¥åˆ—è¡¨
            self.model.todos.append((False, text))
            # è§¦å‘åˆ·æ–°
            self.model.layoutChanged.emit() #1
            # æ¸…ç©ºè¾“å…¥(input)
            self.todoEdit.setText("")
            self.save()
            
    def delete(self):
        indexes = self.todoView.selectedIndexes()
        if indexes:
            # ç´¢å¼•æ˜¯ä¸€ä¸ªå•é€‰æ¨¡å¼ä¸‹çš„å•é¡¹åˆ—è¡¨
            index = indexes[0]
            # åˆ é™¤è¯¥é¡¹å¹¶åˆ·æ–°
            del self.model.todos[index.row()]
            self.model.layoutChanged.emit()
            # æ¸…é™¤é€‰ä¸­é¡¹ï¼ˆå› å…¶å·²ä¸å†æœ‰æ•ˆï¼‰
            self.todoView.clearSelection()
            self.save()
            
    def complete(self):
        indexes = self.todoView.selectedIndexes()
        if indexes:
            index = indexes[0]
            row = index.row()
            status, text = self.model.todos[row]
            self.model.todos[row] = (True, text)
            # .dataChanged æ–¹æ³•æ¥å—å·¦ä¸Šè§’å’Œå³ä¸‹è§’åæ ‡ï¼Œä¸”è¿™ä¸¤ä¸ªåæ ‡ç›¸ç­‰ã€‚
            # å¯¹äºå•ä¸€é€‰æ‹©ã€‚
            self.model.dataChanged.emit(index, index)
            # æ¸…é™¤é€‰ä¸­å†…å®¹ï¼ˆå› å…¶å·²ä¸å†æœ‰æ•ˆï¼‰ã€‚
            self.todoView.clearSelection()
            self.save()
            
    def load(self):
        try:
            with open("data.json", "r") as f:
                self.model.todos = json.load(f)
        except Exception:
            pass
        
    def save(self):
        with open("data.json", "w") as f:
            data = json.dump(self.model.todos, f)
            
            
app = QApplication(sys.argv)
window = MainWindow()
window.show()
app.exec()
```

å¦‚æœæ‚¨çš„åº”ç”¨ç¨‹åºä¸­çš„æ•°æ®æœ‰å¯èƒ½å˜å¾—åºå¤§æˆ–å¤æ‚ï¼Œæ‚¨å¯èƒ½æ›´å€¾å‘äºä½¿ç”¨å®é™…çš„æ•°æ®åº“æ¥å­˜å‚¨å®ƒã€‚Qt æä¾›äº†ä¸ SQL æ•°æ®åº“äº¤äº’çš„æ¨¡å‹ï¼Œæˆ‘ä»¬ç¨åå°†è¯¦ç»†ä»‹ç»ã€‚

![tips](tips.png)

> å¦ä¸€ä¸ªæœ‰è¶£çš„ `QListView` ç¤ºä¾‹è¯·å‚è§æˆ‘çš„ [åª’ä½“æ’­æ”¾å™¨åº”ç”¨ç¨‹åºç¤ºä¾‹](https://www.pythonguis.com/apps/failamp-multimedia-player/)ã€‚è¯¥ç¤ºä¾‹ä½¿ç”¨Qtå†…ç½®çš„ `QMediaPlaylist` ä½œä¸ºæ•°æ®å­˜å‚¨ï¼Œå…¶å†…å®¹é€šè¿‡ `QListView` è¿›è¡Œæ˜¾ç¤ºã€‚
