# åº”ç”¨ç¨‹åºç¤ºä¾‹

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæ‚¨åº”è¯¥å·²ç»æŒæ¡äº†å¦‚ä½•ä½¿ç”¨PyQt6æ„å»ºç®€å•åº”ç”¨ç¨‹åºçš„æ–¹æ³•ã€‚ä¸ºäº†å±•ç¤ºå¦‚ä½•å°†æ‰€å­¦çŸ¥è¯†ä»˜è¯¸å®è·µï¼Œæœ¬ç« ä¸­åŒ…å«äº†å‡ ä¸ªç¤ºä¾‹åº”ç”¨ç¨‹åºã€‚è¿™äº›åº”ç”¨ç¨‹åºåŠŸèƒ½é½å…¨ã€ç®€å•æ˜“ç”¨ï¼Œä½†åœ¨æŸäº›æ–¹é¢å¯èƒ½ä¸å¤Ÿå®Œå–„ã€‚æ‚¨å¯ä»¥å°†å®ƒä»¬ä½œä¸ºçµæ„Ÿæ¥æºï¼Œè¿›è¡Œæ‹†è§£åˆ†æï¼Œå¹¶å€Ÿæ­¤æœºä¼šè¿›è¡Œæ”¹è¿›ã€‚è¯·æ‚¨ç»§ç»­é˜…è¯»ï¼Œæˆ‘ä»¬å°†å¯¹æ¯ä¸ªåº”ç”¨ç¨‹åºçš„ç²¾å½©éƒ¨åˆ†è¿›è¡Œè¯¦ç»†è®²è§£ã€‚

è¿™ä¸¤ä¸ªåº”ç”¨ç¨‹åºçš„å®Œæ•´æºä»£ç å‡å¯ä¸‹è½½ï¼Œæ­¤å¤–ï¼Œæ‚¨è¿˜å¯ä»¥åœ¨æˆ‘çš„GitHubä¸Šçš„ [15åˆ†é’Ÿåº”ç”¨ç¨‹åº](https://github.com/pythonguis/15-minute-apps) ä»“åº“ä¸­æ‰¾åˆ°å¦å¤–13ä¸ªåº”ç”¨ç¨‹åºã€‚ç¥æ‚¨ç©å¾—æ„‰å¿«ï¼

æœ¬ä¹¦ä¸­è¿˜æœ‰å…¶ä»–ä¸€äº›å¾®å‹åº”ç”¨ç¨‹åºçš„ç¤ºä¾‹â€”â€”ä¾‹å¦‚ç»˜å›¾å’Œå¾…åŠäº‹é¡¹åº”ç”¨ç¨‹åºâ€”â€”æˆ‘é¼“åŠ±æ‚¨ä¹Ÿè¦æ‰©å±•è¿™äº›åº”ç”¨ç¨‹åºï¼Œè¿™æ˜¯å­¦ä¹ çš„æœ€ä½³æ–¹å¼ã€‚

## 41. Mozzarella Ashbadger

Mozzarella Ashbadger æ˜¯ç½‘é¡µæµè§ˆé¢†åŸŸçš„æœ€æ–°é©å‘½ï¼è¿”å›å’Œå‰è¿›ï¼æ‰“å°ï¼ä¿å­˜æ–‡ä»¶ï¼è·å–å¸®åŠ©ï¼ï¼ˆæ‚¨å¯èƒ½ä¼šéœ€è¦å®ƒï¼‰ã€‚ä¸å…¶ä»–æµè§ˆå™¨çš„ä»»ä½•ç›¸ä¼¼ä¹‹å¤„çº¯å±å·§åˆã€‚

![Figure269](Figure269.png)

> å›¾269ï¼šMozzarella Ashbadger

![tips](tips.png)

> æ­¤åº”ç”¨ç¨‹åºåˆ©ç”¨äº†ä¿¡å·ä¸æ§½ã€æ‰©å±•ä¿¡å·å’Œæ§ä»¶ä¸­ä»‹ç»çš„åŠŸèƒ½ã€‚

Mozzarella Ashbadger çš„æºä»£ç æœ‰ä¸¤ç§å½¢å¼ï¼Œä¸€ç§å¸¦æœ‰æ ‡ç­¾å¼æµè§ˆï¼Œå¦ä¸€ç§æ²¡æœ‰ã€‚æ·»åŠ æ ‡ç­¾ä¼šç¨å¾®å¢åŠ ä¿¡å·å¤„ç†çš„å¤æ‚æ€§ï¼Œå› æ­¤æˆ‘ä»¬é¦–å…ˆä»‹ç»æ²¡æœ‰æ ‡ç­¾çš„ç‰ˆæœ¬ã€‚

è¦åˆ›å»ºæµè§ˆå™¨ï¼Œæˆ‘ä»¬éœ€è¦å®‰è£…ä¸€ä¸ªé¢å¤–çš„ PyQt6 ç»„ä»¶ â€” PyQtWebEngineã€‚æ‚¨å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œä½¿ç”¨ `pip` è¿›è¡Œå®‰è£…ï¼Œå…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š

```bash
pip3 install pyqt6-webengine
```

### æºä»£ç 

æ— æ ‡ç­¾æµè§ˆå™¨çš„å®Œæ•´æºä»£ç åŒ…å«åœ¨æœ¬ä¹¦çš„ä¸‹è½½å†…å®¹ä¸­ã€‚æµè§ˆå™¨ä»£ç çš„æ–‡ä»¶åä¸º `browser.py` ã€‚

```bash
python3 browser.py
```

> ğŸš€ **è¿è¡Œå®ƒå§ï¼** åœ¨å¼€å§‹ç¼–å†™ä»£ç ä¹‹å‰ï¼Œè¯·å…ˆæ¢ç´¢ Mozzarella Ashbadger çš„ç•Œé¢å’ŒåŠŸèƒ½ã€‚

### æµè§ˆå™¨æ§ä»¶

æµè§ˆå™¨çš„æ ¸å¿ƒæ˜¯ `QWebEngineView`ï¼Œæˆ‘ä»¬ä» `QtWebEngineWidgets` å¯¼å…¥å®ƒã€‚å®ƒæä¾›äº†ä¸€ä¸ªå®Œæ•´çš„æµè§ˆå™¨çª—å£ï¼Œè¯¥çª—å£è´Ÿè´£æ»‘å—ä¸‹è½½é¡µé¢çš„æ¸²æŸ“ã€‚ä»¥ä¸‹æ˜¯ PyQt6 ä¸­ä½¿ç”¨ç½‘é¡µæµè§ˆå™¨æ§ä»¶æ‰€éœ€çš„æœ€ä½é™åº¦ä»£ç ã€‚

*Listing 264. app/browser_skeleton.py*

```python
import sys

from PyQt6.QtCore import QUrl
from PyQt6.QtWebEngineWidgets import QWebEngineView
from PyQt6.QtWidgets import QApplication, QMainWindow


class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        
        self.browser = QWebEngineView()
        self.browser.setUrl(QUrl("https://www.google.com"))
        
        self.setCentralWidget(self.browser)
        
        self.show()
        
        
app = QApplication(sys.argv)
window = MainWindow()

app.exec()
```

å¦‚æœæ‚¨ç¨å¾®ç‚¹å‡»ä¸€ä¸‹ï¼Œæ‚¨ä¼šå‘ç°æµè§ˆå™¨è¡¨ç°å¾—åƒé¢„æœŸçš„ä¸€æ ·â€”â€”é“¾æ¥æ­£å¸¸å·¥ä½œï¼Œæ‚¨å¯ä»¥ä¸é¡µé¢äº’åŠ¨ã€‚ç„¶è€Œï¼Œæ‚¨ä¹Ÿä¼šæ³¨æ„åˆ°ä¸€äº›ä½ ä¹ ä»¥ä¸ºå¸¸çš„ä¸œè¥¿ç¼ºå¤±äº†â€”â€”æ¯”å¦‚åœ°å€æ ã€æ§åˆ¶æŒ‰é’®æˆ–ä»»ä½•ç±»å‹çš„ç•Œé¢ã€‚è¿™ä½¿å¾—ä½¿ç”¨èµ·æ¥æœ‰ç‚¹æ£˜æ‰‹ã€‚

è®©æˆ‘ä»¬æŠŠè¿™ä¸ªç®€é™‹çš„æµè§ˆå™¨æ”¹é€ æˆä¸€ä¸ªç¨å¾®å®ç”¨ä¸€ç‚¹çš„å·¥å…·å§ï¼

### è·¯å¾„

ä¸ºäº†æ›´æ–¹ä¾¿åœ°å¤„ç†ç•Œé¢å›¾æ ‡ï¼Œæˆ‘ä»¬å¯ä»¥é¦–å…ˆå®šä¹‰ä¸€ä¸ªâ€œä½¿ç”¨ç›¸å¯¹è·¯å¾„â€ï¼ˆå‚è§å‰é¢çš„ç« èŠ‚ï¼‰ã€‚å®ƒä¸º `icons` æ•°æ®æ–‡ä»¶å’Œä¸€ä¸ª `icon` æ–¹æ³•å®šä¹‰äº†ä¸€ä¸ªå•ä¸€çš„æ–‡ä»¶å¤¹ä½ç½®ï¼Œç”¨äºåˆ›å»ºå›¾æ ‡çš„è·¯å¾„ã€‚è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿä½¿ç”¨ `Paths.icon()` æ¥åŠ è½½æµè§ˆå™¨ç•Œé¢çš„å›¾æ ‡ã€‚

*Listing 265. app/paths.py*

```python
import os


class Paths:
    
    base = os.path.dirname(__file__)
    icons = os.path.join(base, "icons")
    
    # æ–‡ä»¶åŠ è½½å™¨.
    @classmethod
    def icon(cls, filename):
        return os.path.join(cls.icons, filename)
```

è¯·æ‚¨å°†å®ƒä¸æˆ‘ä»¬çš„æµè§ˆå™¨ä¿å­˜åœ¨åŒä¸€æ–‡ä»¶å¤¹ä¸­ï¼Œå®ƒå¯ä»¥å¯¼å…¥ä¸ºï¼š

*Listing 266. app/browser.py*

```python
from paths import Paths
```

### å¯¼èˆª

ç°åœ¨è¿™äº›éƒ½å·²å°±ç»ªï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ ä¸€äº›ç•Œé¢æ§ä»¶ï¼Œä¾‹å¦‚åœ¨ `QToolbar` ä¸Šä½¿ç”¨ä¸€ç³»åˆ—çš„ `QActions` ã€‚æˆ‘ä»¬å°†è¿™äº›å®šä¹‰æ·»åŠ åˆ° `QMainWindow` çš„ `__init__` å—ä¸­ã€‚æˆ‘ä»¬ä½¿ç”¨æˆ‘ä»¬çš„ `Paths.icon()` æ–¹æ³•ä½¿ç”¨ç›¸å¯¹è·¯å¾„åŠ è½½æ–‡ä»¶ã€‚

*Listing 267. app/browser.py*

```python
        navtb = QToolBar("Navigation")
        navtb.setIconSize(QSize(16, 16))
        self.addToolBar(navtb)
        
        back_btn = QAction(
            QIcon(Paths.icon("arrow-180.png")), "Back", self
        )
        back_btn.setStatusTip("Back to previous page")
        back_btn.triggered.connect(self.browser.back)
        navtb.addAction(back_btn)
```

`QWebEngineView` åŒ…æ‹¬ç”¨äºå‰è¿›ã€åé€€å’Œé‡æ–°åŠ è½½å¯¼èˆªçš„æ§½ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶ç›´æ¥è¿æ¥åˆ°æˆ‘ä»¬çš„åŠ¨ä½œçš„ `.triggered` ä¿¡å·ã€‚

æˆ‘ä»¬ä¸ºå‰©ä½™çš„æ§ä»¶ä½¿ç”¨ç›¸åŒçš„ `QAction` ç»“æ„ã€‚

*Listing 268. app/browser.py*

```python
        next_btn = QAction(
            QIcon(Paths.icon("arrow-000.png")), "Forward", self
        )
        next_btn.setStatusTip("Forward to next page")
        next_btn.triggered.connect(self.browser.forward)
        navtb.addAction(next_btn)
        
        reload_btn = QAction(
            QIcon(Paths.icon("arrow-circle-315.png")),
            "Reload",
            self,
        )
        reload_btn.setStatusTip("Reload page")
        reload_btn.triggered.connect(self.browser.reload)
        navtb.addAction(reload_btn)
        
        home_btn = QAction(QIcon(Paths.icon("home.png")), "Home", self)
        home_btn.setStatusTip("Go home")
        home_btn.triggered.connect(self.navigate_home)
        navtb.addAction(home_btn)
```

è¯·æ³¨æ„ï¼Œè™½ç„¶å‰è¿›ã€åé€€å’Œé‡æ–°åŠ è½½å¯ä»¥ä½¿ç”¨å†…ç½®æ§½ï¼Œä½†å¯¼èˆªä¸»é¡µæŒ‰é’®éœ€è¦è‡ªå®šä¹‰æ§½å‡½æ•°ã€‚è¯¥æ§½å‡½æ•°åœ¨æˆ‘ä»¬çš„ `QMainWindow` ç±»ä¸­å®šä¹‰ï¼Œåªéœ€å°†æµè§ˆå™¨çš„URLè®¾ç½®ä¸ºè°·æ­Œä¸»é¡µå³å¯ã€‚è¯·æ³¨æ„ï¼ŒURLå¿…é¡»ä½œä¸º `QUrl` å¯¹è±¡ä¼ é€’ã€‚

*Listing 269. app/browser.py*

```python
    def navigate_home(self):
        self.browser.setUrl(QUrl("http://www.google.com"))
```

![tips](tips.png)

> æŒ‘æˆ˜
>
> å°è¯•å°†ä¸»é¡µå¯¼èˆªä½ç½®è®¾ç½®ä¸ºå¯é…ç½®ã€‚æ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ªå¸¦è¾“å…¥å­—æ®µçš„ `QDialog` å¯¹è¯æ¡†ã€‚

ä»»ä½•ä¸€æ¬¾åˆæ ¼çš„ç½‘é¡µæµè§ˆå™¨éƒ½å¿…é¡»å…·å¤‡åœ°å€æ ï¼Œå¹¶ä¸”éœ€è¦æä¾›ä¸€ç§æ–¹å¼æ¥åœæ­¢å¯¼èˆªâ€”â€”æ— è®ºæ˜¯ç”±äºè¯¯æ“ä½œï¼Œè¿˜æ˜¯é¡µé¢åŠ è½½è¿‡æ…¢ã€‚

*Listing 270. app/browser.py*

```python
        self.httpsicon = QLabel() # æ˜¯çš„ï¼Œå°±åƒè¿™æ ·!
        self.httpsicon.setPixmap(QPixmap(Paths.icon("lock-nossl.png")))
        navtb.addWidget(self.httpsicon)
        
        self.urlbar = QLineEdit()
        self.urlbar.returnPressed.connect(self.navigate_to_url)
        navtb.addWidget(self.urlbar)
        
        stop_btn = QAction(
            QIcon(Paths.icon("cross-circle.png")), "Stop", self
        )
        stop_btn.setStatusTip("Stop loading current page")
        stop_btn.triggered.connect(self.browser.stop)
        navtb.addAction(stop_btn)
```

ä¸ä¹‹å‰ä¸€æ ·ï¼Œ`QWebEngineView` ä¸Šæä¾›äº†â€œåœæ­¢â€åŠŸèƒ½ï¼Œæˆ‘ä»¬åªéœ€å°†åœæ­¢æŒ‰é’®çš„ `.triggered` ä¿¡å·è¿æ¥åˆ°ç°æœ‰çš„æ§½å³å¯ã€‚ä½†æ˜¯ï¼ŒURL æ çš„å…¶ä»–åŠŸèƒ½å¿…é¡»å•ç‹¬å¤„ç†ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬æ·»åŠ ä¸€ä¸ª `QLabel` æ¥ä¿å­˜æˆ‘ä»¬çš„ SSL æˆ–é SSL å›¾æ ‡ï¼Œä»¥æŒ‡ç¤ºé¡µé¢æ˜¯å¦å®‰å…¨ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ·»åŠ ä¸€ä¸ª URL æ ï¼Œå®ƒåªæ˜¯ä¸€ä¸ª `QLineEdit`ã€‚ä¸ºäº†è§¦å‘åœ¨è¾“å…¥ï¼ˆæŒ‰å›è½¦é”®ï¼‰æ—¶åœ¨æ ä¸­åŠ è½½ URLï¼Œæˆ‘ä»¬è¿æ¥åˆ°æ§ä»¶ä¸Šçš„ `.returnPressed` ä¿¡å·ï¼Œä»¥é©±åŠ¨ä¸€ä¸ªè‡ªå®šä¹‰æ§½å‡½æ•°ï¼Œè§¦å‘å¯¼èˆªåˆ°æŒ‡å®šçš„ URLã€‚

*Listing 271. app/browser.py*

```python
    def navigate_to_url(self): # æœªæ¥æ”¶ URL
        q = QUrl(self.urlbar.text())
        if q.scheme() == "":
            q.setScheme("http")
            
        self.browser.setUrl(q)
```

æˆ‘ä»¬è¿˜å¸Œæœ› URL æ¡èƒ½å¤Ÿæ ¹æ®é¡µé¢å˜åŒ–è¿›è¡Œæ›´æ–°ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `QWebEngineView` çš„ `.urlChanged` å’Œ `.loadFinished` ä¿¡å·ã€‚æˆ‘ä»¬åœ¨ `__init__` å—ä¸­æŒ‰ç…§ä»¥ä¸‹æ–¹å¼è®¾ç½®äº†ä¿¡å·çš„è¿æ¥ï¼š

*Listing 272. app/browser.py*

```python
        self.browser.urlChanged.connect(self.update_urlbar)
        self.browser.loadFinished.connect(self.update_title)
```

ç„¶åï¼Œæˆ‘ä»¬å®šä¹‰è¿™äº›ä¿¡å·çš„ç›®æ ‡æ§½å‡½æ•°ã€‚ç¬¬ä¸€ä¸ªå‡½æ•°ç”¨äºæ›´æ–° URL æ ï¼Œå®ƒæ¥å—ä¸€ä¸ª `QUrl` å¯¹è±¡ï¼Œå¹¶ç¡®å®šè¿™æ˜¯ `http` è¿˜æ˜¯ `https` URLï¼Œç„¶åä½¿ç”¨æ­¤ä¿¡æ¯è®¾ç½® SSL å›¾æ ‡ã€‚

![caution](caution.png)

> è¿™æ˜¯ä¸€ç§éå¸¸ç³Ÿç³•çš„æµ‹è¯•è¿æ¥æ˜¯å¦â€œå®‰å…¨â€çš„æ–¹æ³•ã€‚è¦æ­£ç¡®åœ°è¿›è¡Œæµ‹è¯•ï¼Œæˆ‘ä»¬åº”è¯¥æ‰§è¡Œè¯ä¹¦éªŒè¯ã€‚

`QUrl` è¢«è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼ŒURL æ ä¹Ÿæ›´æ–°ä¸ºè¯¥å€¼ã€‚è¯·æ³¨æ„ï¼Œæˆ‘ä»¬è¿˜å°†å…‰æ ‡ä½ç½®è®¾ç½®å›è¡Œé¦–ï¼Œä»¥é˜²æ­¢`QLineEdit` æ§ä»¶æ»šåŠ¨åˆ°è¡Œå°¾ã€‚

*Listing 273. app/browser.py*

```python
    def update_urlbar(self, q):
        
        if q.scheme() == "https":
            # å®‰å…¨æŒ‚é”å›¾æ ‡
            self.httpsicon.setPixmap(
                QPixmap(Paths.icon("lock-ssl.png"))
            )
            
        else:
            # ä¸å®‰å…¨çš„æŒ‚é”å›¾æ ‡
            self.httpsicon.setPixmap(
                QPixmap(Paths.icon("lock-nossl.png"))
            )
            
        self.urlbar.setText(q.toString())
        self.urlbar.setCursorPosition(0)
```

å¦å¤–ï¼Œå°†åº”ç”¨ç¨‹åºçª—å£çš„æ ‡é¢˜æ›´æ–°ä¸ºå½“å‰é¡µé¢çš„æ ‡é¢˜ä¹Ÿæ˜¯ä¸€ä¸ªä¸é”™çš„ç»†èŠ‚ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `browser.page().title()` æ–¹æ³•è·å–æ­¤ä¿¡æ¯ï¼Œè¯¥æ–¹æ³•è¿”å›å½“å‰åŠ è½½çš„ç½‘é¡µä¸­ `<title></title>` æ ‡ç­¾çš„å†…å®¹ã€‚

*Listing 274. app/browser.py*

```python
    def update_title(self):
        title = self.browser.page().title()
        self.setWindowTitle("%s - Mozzarella Ashbadger" % title)
```

### æ–‡ä»¶æ“ä½œ

ä½¿ç”¨ `self.menuBar().addMenu(â€œ&Fileâ€)` å¯ä»¥åˆ›å»ºä¸€ä¸ªæ ‡å‡†çš„â€œæ–‡ä»¶â€èœå•ï¼Œå°† F é”®åˆ†é…ä¸º Alt å¿«æ·é”®ï¼ˆä¸é€šå¸¸ä¸€æ ·ï¼‰ã€‚è·å¾—èœå•å¯¹è±¡åï¼Œæˆ‘ä»¬å¯ä»¥å°† `QAction` å¯¹è±¡åˆ†é…ç»™è¯¥å¯¹è±¡ä»¥åˆ›å»ºæ¡ç›®ã€‚æˆ‘ä»¬åœ¨è¿™é‡Œåˆ›å»ºäº†ä¸¤ä¸ªåŸºæœ¬æ¡ç›®ï¼Œç”¨äºæ‰“å¼€å’Œä¿å­˜ HTML æ–‡ä»¶ï¼ˆæ¥è‡ªæœ¬åœ°ç£ç›˜ï¼‰ã€‚è¿™ä¸¤ä¸ªæ¡ç›®éƒ½éœ€è¦è‡ªå®šä¹‰æ§½å‡½æ•°ã€‚

*Listing 275. app/browser.py*

```python
        file_menu = self.menuBar().addMenu("&File")
    
        open_file_action = QAction(
            QIcon(Paths.icon("disk--arrow.png")),
            "Open file...",
            self,
        )
        open_file_action.setStatusTip("Open from file")
        open_file_action.triggered.connect(self.open_file)
        file_menu.addAction(open_file_action)
        
        save_file_action = QAction(
            QIcon(Paths.icon("disk--pencil.png")),
            "Save Page As...",
            self,
        )
        save_file_action.setStatusTip("Save current page to file")
        save_file_action.triggered.connect(self.save_file)
        file_menu.addAction(save_file_action)
```

æ‰“å¼€æ–‡ä»¶çš„æ§½å‡½æ•°ä½¿ç”¨å†…ç½®çš„ `QFileDialog.getOpenFileName()` å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–‡ä»¶æ‰“å¼€å¯¹è¯æ¡†å¹¶è·å–ä¸€ä¸ªåç§°ã€‚æˆ‘ä»¬é»˜è®¤å°†åç§°é™åˆ¶ä¸ºä¸ `*.htm` æˆ– `*.html` åŒ¹é…çš„æ–‡ä»¶ã€‚

æˆ‘ä»¬ä½¿ç”¨æ ‡å‡†çš„ Python å‡½æ•°å°†æ–‡ä»¶è¯»å–åˆ°ä¸€ä¸ªåä¸º `html` çš„å˜é‡ä¸­ï¼Œç„¶åä½¿ç”¨`.setHtml()` å°† HTML å†…å®¹åŠ è½½åˆ°æµè§ˆå™¨ä¸­ã€‚

*Listing 276. app/browser.py*

```python
    def open_file(self):
        filename, _ = QFileDialog.getOpenFileName(
            self,
            "Open file",
            "",
            "Hypertext Markup Language (*.htm *.html);;"
            "All files (*.*)",
        )
        
        if filename:
            with open(filename, "r") as f:
                html = f.read()
                
            self.browser.setHtml(html)
            self.urlbar.setText(filename)
```

åŒæ ·åœ°ï¼Œä¸ºäº†ä¿å­˜å½“å‰é¡µé¢çš„ HTMLï¼Œæˆ‘ä»¬ä½¿ç”¨å†…ç½®çš„ `QFileDialog.getSaveFileName()` æ–¹æ³•è·å–æ–‡ä»¶åã€‚ä¸è¿‡è¿™æ¬¡æˆ‘ä»¬é€šè¿‡ `self.browser.page().toHtml()` è·å– HTMLã€‚

è¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬ä¸ä¼šç«‹å³æ”¶åˆ° HTMLã€‚ç›¸åï¼Œæˆ‘ä»¬å¿…é¡»ä¼ é€’ä¸€ä¸ªå›è°ƒæ–¹æ³•ï¼Œè¯¥æ–¹æ³•å°†åœ¨ HTML å‡†å¤‡å°±ç»ªåæ¥æ”¶å®ƒã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªç®€å•çš„ `writer` å‡½æ•°ï¼Œå®ƒä½¿ç”¨æœ¬åœ°èŒƒå›´ä¸­çš„æ–‡ä»¶åæ¥å¤„ç†å®ƒã€‚

*Listing 277. app/browser.py*

```python
    def save_file(self):
        filename, _ = QFileDialog.getSaveFileName(
            self,
            "Save Page As",
            "",
            "Hypertext Markup Language (*.htm *html);;"
            "All files (*.*)",
        )
        
        if filename:
            # å®šä¹‰å›è°ƒæ–¹æ³•ä»¥å¤„ç†å†™å…¥æ“ä½œ.
            def writer(html):
                with open(filename, "w") as f:
                    f.write(html)
                    
            self.browser.page().toHtml(writer)
```

### æ‰“å°

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¹‹å‰çš„æ–¹æ³•åœ¨â€œæ–‡ä»¶â€èœå•ä¸­æ·»åŠ æ‰“å°é€‰é¡¹ã€‚åŒæ ·ï¼Œè¿™éœ€è¦ä¸€ä¸ªè‡ªå®šä¹‰æ§½å‡½æ•°æ¥æ‰§è¡Œæ‰“å°æ“ä½œã€‚

*Listing 278. app/browser.py*

```python
        print_action = QAction(
            QIcon(Paths.icon("printer.png")), "Print...", self
        )
        print_action.setStatusTip("Print current page")
        print_action.triggered.connect(self.print_page)
        file_menu.addAction(print_action)
        
        # åˆ›å»ºæˆ‘ä»¬çš„ç³»ç»Ÿæ‰“å°æœºå®ä¾‹.
        self.printer = QPrinter()
```

Qt æä¾›äº†ä¸€ä¸ªåŸºäº `QPrinter` å¯¹è±¡çš„å®Œæ•´æ‰“å°æ¡†æ¶ï¼Œæ‚¨å¯ä»¥åœ¨å…¶ä¸Šç»˜åˆ¶è¦æ‰“å°çš„é¡µé¢ã€‚ä¸ºäº†å¯åŠ¨æ‰“å°è¿‡ç¨‹ï¼Œæˆ‘ä»¬é¦–å…ˆä¸ºç”¨æˆ·æ‰“å¼€ä¸€ä¸ª `QPrintDialog`ã€‚è¿™å…è®¸ç”¨æˆ·é€‰æ‹©ç›®æ ‡æ‰“å°æœºå¹¶é…ç½®æ‰“å°è®¾ç½®ã€‚

æˆ‘ä»¬åœ¨ `__init__`ä¸­åˆ›å»ºäº† `QPrinter` å¯¹è±¡ï¼Œå¹¶å°†å…¶å­˜å‚¨ä¸º `self.printer`ã€‚åœ¨æˆ‘ä»¬çš„æ‰“å°å¤„ç†æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å°†æ­¤æ‰“å°æœºä¼ é€’ç»™ `QPrintDialog`ï¼Œä»¥ä¾¿å…¶å¯ä»¥è¢«é…ç½®ã€‚å¦‚æœå¯¹è¯æ¡†è¢«æ¥å—ï¼Œæˆ‘ä»¬å°†ï¼ˆç°åœ¨å·²é…ç½®çš„ï¼‰æ‰“å°æœºå¯¹è±¡ä¼ é€’ç»™ `self.browser.page().print` ä»¥è§¦å‘æ‰“å°ã€‚

*Listing 279. app/browser.py*

```python
def print_page(self):
    page = self.browser.page()
    
    def callback(*args):
        pass
    
    dlg = QPrintDialog(self.printer)
    dlg.accepted.connect(callback)
    if dlg.exec() == QDialog.DialogCode.Accepted:
        page.print(self.printer, callback)
```

è¯·æ³¨æ„ï¼Œ`.print` æ–¹æ³•è¿˜æ¥å—ç¬¬äºŒä¸ªå‚æ•°â€”â€”ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šæ¥æ”¶æ‰“å°æ“ä½œçš„ç»“æœã€‚è¿™å…è®¸æ‚¨åœ¨æ‰“å°æ“ä½œå®Œæˆåæ˜¾ç¤ºä¸€æ¡é€šçŸ¥ï¼Œä½†åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åªæ˜¯é™é»˜åœ°å¿½ç•¥äº†å›è°ƒå‡½æ•°ã€‚

### å¸®åŠ©

æœ€åï¼Œä¸ºäº†å®Œæˆæ ‡å‡†ç•Œé¢ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ ä¸€ä¸ªâ€œå¸®åŠ©â€èœå•ã€‚å®ƒä¸ä¹‹å‰ä¸€æ ·ï¼Œå®šä¹‰ä¸ºä¸¤ä¸ªè‡ªå®šä¹‰æ§½å‡½æ•°ï¼Œä¸€ä¸ªç”¨äºæ˜¾ç¤ºâ€œå…³äºâ€å¯¹è¯æ¡†ï¼Œå¦ä¸€ä¸ªç”¨äºåŠ è½½åŒ…å«æ›´å¤šä¿¡æ¯çš„â€œæµè§ˆå™¨é¡µé¢â€ã€‚

*Listing 280. app/browser.py*

```python
        help_menu = self.menuBar().addMenu("&Help")
        about_action = QAction(
            QIcon(Paths.icon("question.png")),
            "About Mozzarella Ashbadger",
            self,
        )
        about_action.setStatusTip(
            "Find out more about Mozzarella Ashbadger"
        ) # æˆ‘çœŸé¥¿äº†!
        about_action.triggered.connect(self.about)
        help_menu.addAction(about_action)
        navigate_mozzarella_action = QAction(
            QIcon(Paths.icon("lifebuoy.png")),
            "Mozzarella Ashbadger Homepage",
            self,
        )
        navigate_mozzarella_action.setStatusTip(
            "Go to Mozzarella Ashbadger Homepage"
        )
        navigate_mozzarella_action.triggered.connect(
            self.navigate_mozzarella
        )
        help_menu.addAction(navigate_mozzarella_action)
```

æˆ‘ä»¬å®šä¹‰äº†ä¸¤ä¸ªæ–¹æ³•ï¼Œä½œä¸ºâ€œå¸®åŠ©â€èœå•ä¿¡å·çš„æ§½ã€‚ç¬¬ä¸€ä¸ª `navigate_mozzarella` æ‰“å¼€ä¸€ä¸ªé¡µé¢ï¼Œæä¾›æœ‰å…³æµè§ˆå™¨ï¼ˆæˆ–åœ¨æœ¬ä¹¦çš„æœ¬ä¾‹ä¸­ï¼‰çš„æ›´å¤šä¿¡æ¯ã€‚ç¬¬äºŒä¸ªåˆ›å»ºå¹¶æ‰§è¡Œä¸€ä¸ªè‡ªå®šä¹‰çš„ `QDialog` ç±» `AboutDialog`ï¼Œæˆ‘ä»¬å°†åœ¨ä¸‹é¢è¿›è¡Œå®šä¹‰ã€‚

*Listing 281. app/browser.py*

```python
    def navigate_mozzarella(self):
        self.browser.setUrl(QUrl("https://www.pythonguis.com/"))
        
    def about(self):
        dlg = AboutDialog()
        dlg.exec()
```

å…³äºå¯¹è¯æ¡†çš„å®šä¹‰å¦‚ä¸‹ã€‚è¯¥ç»“æ„ä¸æœ¬ä¹¦å‰é¢ä»‹ç»çš„ç»“æ„ç›¸ä¼¼ï¼Œä½¿ç”¨ `QDialogButtonBox` å’Œç›¸å…³ä¿¡å·æ¥å¤„ç†ç”¨æˆ·è¾“å…¥ï¼Œå¹¶ä½¿ç”¨ä¸€ç³»åˆ— `QLabels` æ¥æ˜¾ç¤ºåº”ç”¨ç¨‹åºä¿¡æ¯å’Œå¾½æ ‡ã€‚

è¿™é‡Œå”¯ä¸€çš„æŠ€å·§æ˜¯å°†æ‰€æœ‰å…ƒç´ æ·»åŠ åˆ°å¸ƒå±€ä¸­ï¼Œç„¶ååœ¨å•ä¸ªå¾ªç¯ä¸­éå†å®ƒä»¬ï¼Œå°†å¯¹é½æ–¹å¼è®¾ç½®ä¸ºå±…ä¸­ã€‚è¿™æ ·å¯ä»¥é¿å…åœ¨å„ä¸ªéƒ¨åˆ†ä¸­é‡å¤è®¾ç½®ã€‚

*Listing 282. app/browser.py*

```python
class AboutDialog(QDialog):
    def __init__(self):
        super().__init__()
        
        QBtn = QDialogButtonBox.StandardButton.Ok # ä¸å–æ¶ˆ
        self.buttonBox = QDialogButtonBox(QBtn)
        self.buttonBox.accepted.connect(self.accept)
        self.buttonBox.rejected.connect(self.reject)
        
        layout = QVBoxLayout()
        
        title = QLabel("Mozzarella Ashbadger")
        font = title.font()
        font.setPointSize(20)
        title.setFont(font)
        
        layout.addWidget(title)
        
        logo = QLabel()
        logo.setPixmap(QPixmap(Paths.icon("ma-icon-128.png")))
        layout.addWidget(logo)
        
        layout.addWidget(QLabel("Version 23.35.211.233232"))
        layout.addWidget(QLabel("Copyright 2015 Mozzarella Inc."))
        
        for i in range(0, layout.count()):
            layout.itemAt(i).setAlignment(Qt.AlignmentFlag.AlignHCenter)
            
        layout.addWidget(self.buttonBox)
        
        self.setLayout(layout)
```

### æ ‡ç­¾å¼æµè§ˆ

![Figure270](Figure270.png)

> å›¾270ï¼šæ ‡ç­¾åŒ–çš„Mozzarella Ashbadger

### æºä»£ç 

æœ¬ä¹¦çš„ä¸‹è½½å†…å®¹ä¸­åŒ…å«äº†å¸¦æ ‡ç­¾é¡µæµè§ˆå™¨çš„å®Œæ•´æºä»£ç ã€‚æµè§ˆå™¨ä»£ç çš„æ–‡ä»¶åä¸º `browser_tabs.py`ã€‚

> ğŸš€ **è¿è¡Œå®ƒå§ï¼** åœ¨å¼€å§‹ç¼–å†™ä»£ç ä¹‹å‰ï¼Œè¯·å…ˆæ¢ç´¢æ ‡ç­¾åŒ–çš„ Mozzarella Ashbadger çš„ç•Œé¢å’ŒåŠŸèƒ½ã€‚

### åˆ›å»ºä¸€ä¸ª `QTabWidget`

ä½¿ç”¨ `QTabWidget` å¯ä»¥è½»æ¾åœ°ä¸ºæµè§ˆå™¨æ·»åŠ æ ‡ç­¾é¡µç•Œé¢ã€‚å®ƒä¸ºå¤šä¸ªæ§ä»¶ï¼ˆåœ¨æœ¬ä¾‹ä¸­ä¸º `QWebEngineView` æ§ä»¶ï¼‰æä¾›äº†ä¸€ä¸ªç®€å•çš„å®¹å™¨ï¼Œå¹¶å†…ç½®äº†ç”¨äºåœ¨æ§ä»¶ä¹‹é—´åˆ‡æ¢çš„æ ‡ç­¾é¡µç•Œé¢ã€‚

æˆ‘ä»¬åœ¨è¿™é‡Œä½¿ç”¨çš„ä¸¤ä¸ªè‡ªå®šä¹‰è®¾ç½®æ˜¯ `.setDocumentMode(True)`ï¼Œå®ƒåœ¨ macOS ä¸Šæä¾›ä¸€ä¸ªç±»ä¼¼ Safari çš„ç•Œé¢ï¼Œä»¥åŠ `.setTabsClosable(True)`ï¼Œå®ƒå…è®¸ç”¨æˆ·åœ¨åº”ç”¨ç¨‹åºä¸­å…³é—­æ ‡ç­¾é¡µã€‚

æˆ‘ä»¬è¿˜å°† `QTabWidget` ä¿¡å· `tabBarDoubleClicked`ã€`currentChanged` å’Œ `tabCloseRequested `è¿æ¥åˆ°è‡ªå®šä¹‰æ§½æ–¹æ³•ï¼Œä»¥å¤„ç†è¿™äº›è¡Œä¸ºã€‚

*Listing 283. app/browser_tabs.py*

```python
        self.tabs = QTabWidget()
        self.tabs.setDocumentMode(True)
        self.tabs.tabBarDoubleClicked.connect(self.tab_open_doubleclick)
        self.tabs.currentChanged.connect(self.current_tab_changed)
        self.tabs.setTabsClosable(True)
        self.tabs.tabCloseRequested.connect(self.close_current_tab)
        
        self.setCentralWidget(self.tabs)
```

è¿™ä¸‰ç§æ§½æ–¹æ³•éƒ½æ¥å—ä¸€ä¸ª `i`ï¼ˆç´¢å¼•ï¼‰å‚æ•°ï¼Œè¯¥å‚æ•°æŒ‡ç¤ºä¿¡å·æ¥è‡ªå“ªä¸ªé€‰é¡¹å¡ï¼ˆæŒ‰é¡ºåºï¼‰ã€‚

æˆ‘ä»¬åŒå‡»æ ‡ç­¾æ ä¸­çš„ç©ºç™½å¤„ï¼ˆç”±ç´¢å¼• `-1`è¡¨ç¤ºï¼‰æ¥è§¦å‘æ–°æ ‡ç­¾çš„åˆ›å»ºã€‚è¦åˆ é™¤æ ‡ç­¾ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨ç´¢å¼•æ¥åˆ é™¤æ§ä»¶ï¼ˆä»¥åŠæ ‡ç­¾ï¼‰ï¼Œå¹¶è¿›è¡Œç®€å•çš„æ£€æŸ¥ä»¥ç¡®ä¿è‡³å°‘æœ‰ 2 ä¸ªæ ‡ç­¾â€”â€”å…³é—­æœ€åä¸€ä¸ªæ ‡ç­¾ä¼šå¯¼è‡´æ‚¨æ— æ³•æ‰“å¼€æ–°æ ‡ç­¾ã€‚

`current_tab_changed` å¤„ç†ç¨‹åºä½¿ç”¨ `self.tabs.currentWidget()` ç»“æ„æ¥è®¿é—®å½“å‰æ´»åŠ¨æ ‡ç­¾é¡µçš„æ§ä»¶ï¼ˆ`QWebEngineView` æµè§ˆå™¨ï¼‰ï¼Œç„¶åä½¿ç”¨å®ƒæ¥è·å–å½“å‰é¡µé¢çš„ URLã€‚

*Listing 284. app/browser_tabs.py*

```python
    def tab_open_doubleclick(self, i):
        if i == -1: # Nç‚¹å‡»åæ²¡æœ‰é€‰é¡¹å¡
            self.add_new_tab()
   
    def current_tab_changed(self, i):
        qurl = self.tabs.currentWidget().url()
        self.update_urlbar(qurl, self.tabs.currentWidget())
        self.update_title(self.tabs.currentWidget())  
        
    def close_current_tab(self, i):
        if self.tabs.count() < 2:
            return

        self.tabs.removeTab(i)
```

*Listing 285. app/browser_tabs.py*

```python
    def add_new_tab(self, qurl=None, label="Blank"):
        
        if qurl is None:
            qurl = QUrl("")
           
        browser = QWebEngineView()
        browser.setUrl(qurl)
        i = self.tabs.addTab(browser, label)
        
        self.tabs.setCurrentIndex(i)
```

### ä¿¡å·å’Œæ§½çš„å˜åŒ–

è™½ç„¶ `QTabWidget` å’Œç›¸å…³ä¿¡å·çš„è®¾ç½®å¾ˆç®€å•ï¼Œä½†åœ¨æµè§ˆå™¨æ§½æ–¹æ³•ä¸­ï¼Œäº‹æƒ…å°±å˜å¾—ç¨å¾®å¤æ‚ä¸€äº›äº†ã€‚

ä»¥å‰æˆ‘ä»¬åªæœ‰ä¸€ä¸ª `QWebEngineView`ï¼Œç°åœ¨æœ‰å¤šä¸ªè§†å›¾ï¼Œæ¯ä¸ªè§†å›¾éƒ½æœ‰è‡ªå·±çš„ä¿¡å·ã€‚å¦‚æœå¤„ç†éšè—æ ‡ç­¾çš„ä¿¡å·ï¼Œäº‹æƒ…å°±ä¼šå˜å¾—ä¸€å›¢ç³Ÿã€‚ä¾‹å¦‚ï¼Œå¤„ç† `loadCompleted` ä¿¡å·çš„æ§½å¿…é¡»æ£€æŸ¥æºè§†å›¾æ˜¯å¦åœ¨å¯è§æ ‡ç­¾ä¸­ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‘é€é™„åŠ æ•°æ®ä¿¡å·çš„æŠ€å·§æ¥å®ç°è¿™ä¸€ç‚¹ã€‚åœ¨æ ‡ç­¾å¼æµè§ˆå™¨ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ `lambda` æ ·å¼è¯­æ³•æ¥å®ç°è¿™ä¸€ç‚¹ã€‚

ä»¥ä¸‹æ˜¯åœ¨åˆ›å»ºæ–°çš„ `QWebEngineView` æ—¶ï¼Œåœ¨ `add_new_tab` å‡½æ•°ä¸­å®ç°æ­¤åŠŸèƒ½çš„ç¤ºä¾‹ï¼š

*Listing 286. app/browser_tabs.py*

```python
        # æ›´å¤æ‚äº†ï¼æˆ‘ä»¬åªå¸Œæœ›åœ¨URLæ¥è‡ªæ­£ç¡®æ ‡ç­¾é¡µæ—¶è¿›è¡Œæ›´æ–°ã€‚
        browser.urlChanged.connect(
            lambda qurl, browser=browser: self.update_urlbar(
                qurl, browser
            )
        )
        
        browser.loadFinished.connect(
            lambda _, i=i, browser=browser: self.tabs.setTabText(
                i, browser.page().title()
            )
        )
```

å¦‚æ‚¨æ‰€è§ï¼Œæˆ‘ä»¬å°† `lambda` è®¾ç½®ä¸º `urlChanged` ä¿¡å·çš„æ§½ï¼Œæ¥å—è¯¥ä¿¡å·å‘é€çš„ `qurl` å‚æ•°ã€‚æˆ‘ä»¬å°†æœ€è¿‘åˆ›å»ºçš„ `browser` å¯¹è±¡æ·»åŠ åˆ° `update_urlbar` å‡½æ•°ä¸­ã€‚

ç»“æœæ˜¯ï¼Œæ¯å½“è¿™ä¸ª `urlChanged` ä¿¡å·è§¦å‘æ—¶ï¼Œ`update_urlbar` å°†åŒæ—¶æ”¶åˆ°æ–° URL å’Œå®ƒæ¥è‡ªçš„æµè§ˆå™¨ã€‚åœ¨æ§½æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ£€æŸ¥ä»¥ç¡®ä¿ä¿¡å·çš„æ¥æºä¸å½“å‰å¯è§çš„æµè§ˆå™¨ç›¸åŒ¹é…ï¼Œå¦‚æœä¸åŒ¹é…ï¼Œæˆ‘ä»¬åªéœ€ä¸¢å¼ƒè¯¥ä¿¡å·å³å¯ã€‚

*Listing 287. app/browser_tabs.py*

```python
    def update_urlbar(self, q, browser=None):
        if browser != self.tabs.currentWidget():
            # å¦‚æœè¯¥ä¿¡å·ä¸æ˜¯æ¥è‡ªå½“å‰é€‰é¡¹å¡ï¼Œåˆ™å¿½ç•¥å®ƒ
            return
        
        if q.scheme() == "https":
            # å®‰å…¨æŒ‚é”å›¾æ ‡
            self.httpsicon.setPixmap(
                QPixmap(Paths.icon("lock-ssl.png"))
            )
            
        else:
            # ä¸å®‰å…¨çš„æŒ‚é”å›¾æ ‡
            self.httpsicon.setPixmap(
                QPixmap(Paths.icon("lock-nossl.png"))
            )
           
        self.urlbar.setText(q.toString())
        self.urlbar.setCursorPosition(0)
```

### ç»§ç»­æ·±å…¥

ç°åœ¨æ‚¨å¯ä»¥æ¢ç´¢æµè§ˆå™¨æ ‡ç­¾é¡µç‰ˆæœ¬çš„å…¶ä½™æºä»£ç ï¼Œè¯·ç‰¹åˆ«æ³¨æ„ `self.tabs.currentWidget()` çš„ä½¿ç”¨ä»¥åŠé€šè¿‡ä¿¡å·ä¼ é€’é¢å¤–æ•°æ®ã€‚è¿™æ˜¯æ‚¨æ‰€å­¦çŸ¥è¯†çš„ä¸€ä¸ªå¾ˆå¥½çš„å®é™…åº”ç”¨æ¡ˆä¾‹ï¼Œæ‰€ä»¥å°è¯•ä¸€ä¸‹ï¼Œçœ‹çœ‹æ‚¨èƒ½å¦ä»¥æœ‰è¶£çš„æ–¹å¼æ‰“ç ´/æ”¹è¿›å®ƒã€‚

![tips](tips.png)

> æŒ‘æˆ˜
>
> æ‚¨å¯èƒ½æƒ³å°è¯•æ·»åŠ ä¸€äº›é¢å¤–åŠŸèƒ½â€”â€”
>
> - ä¹¦ç­¾ï¼ˆæˆ–æ”¶è—å¤¹ï¼‰â€”â€”æ‚¨å¯ä»¥å°†è¿™äº›å­˜å‚¨åœ¨ä¸€ä¸ªç®€å•çš„æ–‡æœ¬æ–‡ä»¶ä¸­ï¼Œå¹¶åœ¨èœå•ä¸­æ˜¾ç¤ºå®ƒä»¬
> - ç½‘ç«™å›¾æ ‡ï¼ˆFaviconsï¼‰â€”â€”è¿™äº›å°å°çš„ç½‘ç«™å›¾æ ‡ï¼Œåœ¨æ ‡ç­¾é¡µä¸Šçœ‹èµ·æ¥ä¼šéå¸¸æ£’ã€‚
> - æŸ¥çœ‹æºä»£ç  â€”â€”æ·»åŠ ä¸€ä¸ªèœå•é€‰é¡¹ä»¥æŸ¥çœ‹é¡µé¢æºä»£ç ã€‚
> - åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€ â€”â€”æ·»åŠ å³é”®ç‚¹å‡»ä¸Šä¸‹æ–‡èœå•ï¼Œæˆ–é”®ç›˜å¿«æ·é”®ï¼Œä»¥åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“é“¾æ¥

## 42. Moonsweeper

æ¢ç´¢ç¥ç§˜çš„ Qâ€™tee å«æ˜Ÿï¼Œä½†ä¸è¦å¤ªé è¿‘å¤–æ˜Ÿäººï¼

Moonsweeper æ˜¯ä¸€æ¬¾å•äººè§£è°œæ¸¸æˆã€‚æ¸¸æˆçš„ç›®æ ‡æ˜¯æ¢ç´¢æ‚¨ç€é™†çš„å¤ªç©ºç«ç®­å‘¨å›´çš„åŒºåŸŸï¼ŒåŒæ—¶é¿å…è¿‡äºé è¿‘è‡´å‘½çš„ Bâ€™ug å¤–æ˜Ÿäººã€‚æ‚¨å¯é çš„è®¡æ•°å™¨ä¼šå‘Šè¯‰ä½ é™„è¿‘æœ‰å¤šå°‘ Bâ€™ugã€‚

![tips](tips.png)

> æ¨èé˜…è¯»
>
> æ­¤åº”ç”¨ç¨‹åºåˆ©ç”¨äº†ä¿¡å·ä¸æ§½ä»¥åŠäº‹ä»¶ä¸­çš„åŠŸèƒ½ã€‚

![Figure271](Figure271.png)

> å›¾271ï¼šMoonsweeper

è¿™æ˜¯ä¸€ä¸ªä»¥æ‰«é›·æ¸¸æˆä¸ºåŸå‹çš„ç®€å•å•äººæ¢ç´¢æ¸¸æˆï¼Œå…¶ä¸­æ‚¨å¿…é¡»æ­å¼€æ‰€æœ‰æ–¹å—è€Œä¸è§¦å‘éšè—çš„åœ°é›·ã€‚æ­¤å®ç°ä½¿ç”¨è‡ªå®šä¹‰çš„ `QWidget` å¯¹è±¡è¡¨ç¤ºæ–¹å—ï¼Œæ¯ä¸ªæ–¹å—å•ç‹¬ä¿å­˜å…¶çŠ¶æ€ï¼ŒåŒ…æ‹¬æ˜¯å¦ä¸ºåœ°é›·ã€å½“å‰çŠ¶æ€ä»¥åŠç›¸é‚»åœ°é›·çš„æ•°é‡ã€‚åœ¨æ­¤ç‰ˆæœ¬ä¸­ï¼Œåœ°é›·è¢«æ›¿æ¢ä¸ºå¤–æ˜Ÿè™«å­ï¼ˆBâ€™ugï¼‰ï¼Œä½†å®ƒä»¬ä¹Ÿå¯ä»¥æ˜¯ä»»ä½•å…¶ä»–ç‰©ä½“ã€‚

åœ¨è®¸å¤šæ‰«é›·å˜ä½“ä¸­ï¼Œåˆå§‹å›åˆè¢«è§†ä¸ºå®‰å…¨å›åˆâ€”â€”å¦‚æœæ‚¨åœ¨ç¬¬ä¸€æ¬¡ç‚¹å‡»æ—¶è§¦ç¢°åˆ°åœ°é›·ï¼Œå®ƒä¼šè¢«ç§»åŠ¨åˆ°å…¶ä»–åœ°æ–¹ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬ç¨å¾®ä½œå¼Šä¸€ä¸‹ï¼Œå°†ç©å®¶çš„é¦–æ¬¡æ“ä½œå›ºå®šåœ¨éåœ°é›·ä½ç½®ã€‚è¿™æ ·åšå¯ä»¥é¿å…å› é¦–æ¬¡æ“ä½œé”™è¯¯è€Œéœ€è¦é‡æ–°è®¡ç®—ç›¸é‚»æ ¼å­çš„æƒ…å†µã€‚æˆ‘ä»¬å¯ä»¥å°†æ­¤è§£é‡Šä¸ºâ€œç«ç®­å‘¨å›´çš„åˆå§‹æ¢ç´¢â€ï¼Œä½¿å…¶å¬èµ·æ¥å®Œå…¨åˆç†ã€‚

![tips](tips.png)

> æŒ‘æˆ˜ï¼
>
> å¦‚æœæ‚¨æƒ³å®ç°è¿™ä¸€ç‚¹ï¼Œå¯ä»¥åœ¨ä½ç½®ä¸Šæ•è·ç¬¬ä¸€æ¬¡ç‚¹å‡»ï¼Œç„¶ååœ¨å¤„ç†ç‚¹å‡»ä¹‹å‰ç”Ÿæˆåœ°é›·/ç›¸é‚»ä½ç½®ï¼Œä½†ä¸åŒ…æ‹¬æ‚¨çš„ä½ç½®ã€‚æ‚¨éœ€è¦è®©è‡ªå®šä¹‰æ§ä»¶è®¿é—®çˆ¶çª—å£å¯¹è±¡

### æºä»£ç 

Moonsweeper æ¸¸æˆçš„å®Œæ•´æºä»£ç åŒ…å«åœ¨æœ¬ä¹¦çš„ä¸‹è½½å†…å®¹ä¸­ã€‚æ¸¸æˆæ–‡ä»¶ä»¥ `minesweeper.py` çš„åç§°ä¿å­˜ã€‚

```bash
python3 minesweeper.py
```

### è·¯å¾„

ä¸ºäº†æ›´æ–¹ä¾¿åœ°å¤„ç†ç•Œé¢å›¾æ ‡ï¼Œæˆ‘ä»¬å¯ä»¥é¦–å…ˆå®šä¹‰ä¸€ä¸ªâ€œä½¿ç”¨ç›¸å¯¹è·¯å¾„â€ï¼ˆå‚è§å‰é¢çš„ç« èŠ‚ï¼‰ã€‚å®ƒä¸º `icons` æ•°æ®æ–‡ä»¶å’Œä¸€ä¸ª `icon` æ–¹æ³•å®šä¹‰äº†ä¸€ä¸ªå•ä¸€çš„æ–‡ä»¶å¤¹ä½ç½®ï¼Œç”¨äºåˆ›å»ºå›¾æ ‡çš„è·¯å¾„ã€‚è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿä½¿ç”¨ `Paths.icon()` æ¥åŠ è½½æ¸¸æˆç•Œé¢çš„å›¾æ ‡ã€‚

*Listing 288. app/paths.py*

```python
import os


class Paths:
    
    base = os.path.dirname(__file__)
    icons = os.path.join(base, "icons")
    
    # æ–‡ä»¶åŠ è½½å™¨.
    @classmethod
    def icon(cls, filename):
        return os.path.join(cls.icons, filename)
```

ä¸æˆ‘ä»¬çš„ Moonsweeper åº”ç”¨ç¨‹åºä¿å­˜åœ¨åŒä¸€æ–‡ä»¶å¤¹ä¸­ï¼Œå®ƒå¯ä»¥è¢«å¯¼å…¥ä¸ºï¼š

*Listing 289. app/moonsweeper.py*

```python
from paths import Paths
```

### å›¾æ ‡ä¸é¢œè‰²

ç°åœ¨è·¯å¾„å·²ç»å®šä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒä»¬æ¥åŠ è½½ä¸€äº›å›¾æ ‡ï¼Œç”¨äºæˆ‘ä»¬çš„æ¸¸æˆâ€”â€”ä¸€ä¸ªè™«å­ã€ä¸€é¢æ——å¸œã€ä¸€æšç«ç®­å’Œä¸€ä¸ªæ—¶é’Ÿã€‚æˆ‘ä»¬è¿˜å®šä¹‰äº†ä¸€ç»„é¢œè‰²ç”¨äºç•Œé¢çŠ¶æ€ï¼Œä»¥åŠä¸€ç³»åˆ—çŠ¶æ€æ ‡å¿—æ¥è·Ÿè¸ªæ¸¸æˆçš„è¿›å±•â€”â€”æ¯ä¸ªæ ‡å¿—éƒ½å…³è”ä¸€ä¸ªç¬‘è„¸å›¾æ ‡ã€‚

*Listing 290. app/moonsweeper.py*

```python
IMG_BOMB = QImage(Paths.icon("bug.png"))
IMG_FLAG = QImage(Paths.icon("flag.png"))
IMG_START = QImage(Paths.icon("rocket.png"))
IMG_CLOCK = QImage(Paths.icon("clock-select.png"))

NUM_COLORS = {
    1: QColor("#f44336"),
    2: QColor("#9C27B0"),
    3: QColor("#3F51B5"),
    4: QColor("#03A9F4"),
    5: QColor("#00BCD4"),
    6: QColor("#4CAF50"),
    7: QColor("#E91E63"),
    8: QColor("#FF9800"),
}

STATUS_READY = 0
STATUS_PLAYING = 1
STATUS_FAILED = 2
STATUS_SUCCESS = 3

STATUS_ICONS = {
    STATUS_READY: Paths.icon("plus.png"),
    STATUS_PLAYING: Paths.icon("smiley.png"),
    STATUS_FAILED: Paths.icon("cross.png"),
    STATUS_SUCCESS: Paths.icon("smiley-lol.png"),
}
```

### æ¸¸æˆåŒºåŸŸ

Moonsweeper çš„æ¸¸æˆåŒºåŸŸæ˜¯ä¸€ä¸ª NxN çš„ç½‘æ ¼ï¼Œå…¶ä¸­åŒ…å«å›ºå®šæ•°é‡çš„çŸ¿äº•ã€‚æˆ‘ä»¬ä½¿ç”¨çš„ç½‘æ ¼å°ºå¯¸å’ŒçŸ¿äº•æ•°é‡æ¥è‡ª Windows ç‰ˆæœ¬ã€Šæ‰«é›·ã€‹çš„é»˜è®¤å€¼ã€‚æ‰€ä½¿ç”¨çš„å€¼å¦‚è¡¨æ‰€ç¤ºï¼š

*Table 14. Table Dimensions and mine counts*

| éš¾åº¦ç­‰çº§ | å°ºå¯¸    | åœ°é›·æ•°é‡ |
| -------- | ------- | -------- |
| ç®€å•     | 8 x 8   | 10       |
| ä¸­ç­‰     | 16 x 16 | 40       |
| å›°éš¾     | 24 x 24 | 99       |

æˆ‘ä»¬å°†è¿™äº›å€¼å­˜å‚¨ä¸ºæ–‡ä»¶é¡¶éƒ¨å®šä¹‰çš„å¸¸é‡ `LEVELS`ã€‚ç”±äºæ‰€æœ‰æ¸¸æˆåŒºåŸŸå‡ä¸ºæ­£æ–¹å½¢ï¼Œå› æ­¤åªéœ€å­˜å‚¨ä¸€æ¬¡å€¼ï¼ˆ8ã€16æˆ–24ï¼‰ã€‚

*Listing 291. app/minesweeper.py*

```python
LEVELS = [("Easy", 8, 10), ("Medium", 16, 40), ("Hard", 24, 99)]
```

æ¸¸æˆç½‘æ ¼å¯ä»¥ä»¥å¤šç§æ–¹å¼è¡¨ç¤ºï¼Œä¾‹å¦‚ä½¿ç”¨ä¸€ä¸ªäºŒç»´çš„â€œåˆ—è¡¨çš„åˆ—è¡¨â€æ¥è¡¨ç¤ºæ¸¸æˆä½ç½®çš„ä¸åŒçŠ¶æ€ï¼ˆåœ°é›·ã€å·²æ­ç¤ºã€å·²æ ‡è®°ï¼‰ã€‚

ç„¶è€Œï¼Œåœ¨æˆ‘ä»¬çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬å°†é‡‡ç”¨é¢å‘å¯¹è±¡çš„æ–¹æ³•ï¼Œå…¶ä¸­åœ°å›¾ä¸Šçš„æ¯ä¸ªä½ç½®éƒ½åŒ…å«è‡ªèº«ç›¸å…³çš„æ‰€æœ‰æ•°æ®ã€‚è¿›ä¸€æ­¥è€Œè¨€ï¼Œæˆ‘ä»¬å¯ä»¥è®©è¿™äº›å¯¹è±¡å„è‡ªè´Ÿè´£ç»˜åˆ¶è‡ªèº«ã€‚åœ¨Qtä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç»§æ‰¿`QWidget` ç±»ï¼Œå¹¶å®ç°è‡ªå®šä¹‰ç»˜åˆ¶å‡½æ•°æ¥å®ç°è¿™ä¸€ç‚¹ã€‚

åœ¨ä»‹ç»è¿™äº›è‡ªå®šä¹‰æ§ä»¶çš„å¤–è§‚ä¹‹å‰ï¼Œæˆ‘ä»¬å°†å…ˆä»‹ç»å®ƒä»¬çš„ç»“æ„å’Œè¡Œä¸ºã€‚ç”±äºæˆ‘ä»¬çš„ç“·ç –å¯¹è±¡æ˜¯ `QWidget` çš„å­ç±»ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åƒå…¶ä»–æ§ä»¶ä¸€æ ·å¯¹å®ƒä»¬è¿›è¡Œå¸ƒå±€ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®ä¸€ä¸ª `QGridLayout`ã€‚

*Listing 292. app/minesweeper.py*

```python
        self.grid = QGridLayout()
        self.grid.setSpacing(5)
        self.grid.setSizeConstraint(QLayout.SizeConstraint.SetFixedSize)
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®æ¸¸æˆåŒºåŸŸï¼Œåˆ›å»ºä½ç½®å›¾å—æ§ä»¶å¹¶å°†å…¶æ·»åŠ åˆ°ç½‘æ ¼ä¸­ã€‚å…³å¡çš„åˆå§‹è®¾ç½®åœ¨è‡ªå®šä¹‰æ–¹æ³•ä¸­å®šä¹‰ï¼Œè¯¥æ–¹æ³•ä» `LEVELS` è¯»å–æ•°æ®ï¼Œå¹¶å°†ä¸€äº›å˜é‡åˆ†é…ç»™çª—å£ã€‚çª—å£æ ‡é¢˜å’Œåœ°é›·è®¡æ•°å™¨æ›´æ–°åï¼Œç½‘æ ¼çš„è®¾ç½®å°±å¼€å§‹äº†ã€‚

*Listing 293. app/minesweeper.py*

```python
    def set_level(self, level):
        self.level_name, self.b_size, self.n_mines = LEVELS[level]
        
        self.setWindowTitle("Moonsweeper - %s" % (self.level_name))
        self.mines.setText("%03d" % self.n_mines)
        
        self.clear_map()
        self.init_map()
        self.reset_map()
```

æ¥ä¸‹æ¥æˆ‘ä»¬å°†ä»‹ç»è®¾ç½®åŠŸèƒ½ã€‚

æˆ‘ä»¬è¿™é‡Œä½¿ç”¨äº†ä¸€ä¸ªè‡ªå®šä¹‰çš„ `Pos` ç±»ï¼Œæˆ‘ä»¬ç¨åä¼šè¯¦ç»†ä»‹ç»å®ƒã€‚ç›®å‰ï¼Œæ‚¨åªéœ€è¦çŸ¥é“å®ƒåŒ…å«åœ°å›¾ä¸­ç›¸å…³ä½ç½®çš„æ‰€æœ‰ç›¸å…³ä¿¡æ¯â€”â€”ä¾‹å¦‚ï¼Œæ˜¯å¦ä¸ºåœ°é›·ã€æ˜¯å¦å·²è¢«æ­ç¤ºã€æ˜¯å¦è¢«æ ‡è®°ä»¥åŠé™„è¿‘åœ°é›·çš„æ•°é‡ã€‚

æ¯ä¸ª `Pos` å¯¹è±¡è¿˜æœ‰ 3 ä¸ªè‡ªå®šä¹‰ä¿¡å· `clicked`ã€`revealed` å’Œ `expandable`ï¼Œæˆ‘ä»¬å°†å…¶è¿æ¥åˆ°è‡ªå®šä¹‰æ§½æ–¹æ³•ã€‚æœ€åï¼Œæˆ‘ä»¬è°ƒç”¨ `resize` æ¥è°ƒæ•´çª—å£çš„å¤§å°ï¼Œä»¥é€‚åº”æ–°å†…å®¹ã€‚è¯·æ³¨æ„ï¼Œè¿™å®é™…ä¸Šåªæœ‰åœ¨çª—å£ç¼©å°æ—¶æ‰éœ€è¦â€”â€”çª—å£ä¼šè‡ªåŠ¨æ‰©å¤§ã€‚

*Listing 294. app/minesweeper.py*

```python
    def init_map(self):
        # åœ¨åœ°å›¾ä¸Šæ·»åŠ ä½ç½®
        for x in range(0, self.b_size):
            for y in range(0, self.b_size):
                w = Pos(x, y)
                self.grid.addWidget(w, y, x)
                # å°†ä¿¡å·è¿æ¥åˆ°æ»‘å—æ‰©å±•ä»¶.
                w.clicked.connect(self.trigger_start)
                w.revealed.connect(self.on_reveal)
                w.expandable.connect(self.expand_reveal)
                
            # å°†è°ƒæ•´å¤§å°æ“ä½œæ”¾å…¥äº‹ä»¶é˜Ÿåˆ—ï¼Œå¹¶åœ¨æ“ä½œå®Œæˆå‰å°†æ§åˆ¶æƒäº¤è¿˜ç»™Qt.
            QTimer.singleShot(0, lambda: self.resize(1, 1)) #1
```

> 1. å•æ¬¡å®šæ—¶å™¨ï¼ˆ`singleShot timer`ï¼‰ç”¨äºç¡®ä¿åœ¨Qtæ£€æµ‹åˆ°æ–°å†…å®¹åå†æ‰§è¡Œçª—å£å¤§å°è°ƒæ•´ã€‚é€šè¿‡ä½¿ç”¨å®šæ—¶å™¨ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®ä¿æ§åˆ¶æƒåœ¨çª—å£å¤§å°è°ƒæ•´å‘ç”Ÿå‰è¿”å›ç»™Qtã€‚

æˆ‘ä»¬è¿˜éœ€è¦å®ç° `init_map` å‡½æ•°çš„é€†å‡½æ•°ï¼Œä»¥ä»åœ°å›¾ä¸­ç§»é™¤ç“·ç –å¯¹è±¡ã€‚åœ¨ä»è¾ƒé«˜å±‚çº§ç§»åŠ¨åˆ°è¾ƒä½å±‚çº§æ—¶ï¼Œç§»é™¤ç“·ç –å°†æ˜¯å¿…è¦çš„ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç¨å¾®èªæ˜ä¸€ç‚¹ï¼Œåªæ·»åŠ /ç§»é™¤é‚£äº›è¾¾åˆ°æ­£ç¡®å°ºå¯¸æ‰€éœ€çš„ç“¦ç‰‡ã€‚ä½†æ˜¯ï¼Œæ—¢ç„¶æˆ‘ä»¬å·²ç»æœ‰äº†ä¸€ä¸ªå‡½æ•°å¯ä»¥å°†æ‰€æœ‰ç“¦ç‰‡æ·»åŠ åˆ°æ­£ç¡®å°ºå¯¸ï¼Œæˆ‘ä»¬å¯ä»¥ç¨å¾®ä½œå¼Šä¸€ä¸‹ã€‚

![tips](tips.png)

> æŒ‘æˆ˜
>
> æ›´æ–°æ­¤ä»£ç ä»¥æ·»åŠ /ç§»é™¤å¿…è¦çš„ç“·ç –ï¼Œä»¥è°ƒæ•´æ–°å…³å¡çš„å°ºå¯¸ã€‚

è¯·æ³¨æ„ï¼Œæˆ‘ä»¬ä½¿ç”¨ `self.grid.removeItem(c)` å°†é¡¹ç›®ä»ç½‘æ ¼ä¸­åˆ é™¤ï¼Œå¹¶æ¸…é™¤çˆ¶çº§ `c.widget().setParent(None)`ã€‚ç¬¬äºŒæ­¥æ˜¯å¿…è¦çš„ï¼Œå› ä¸ºæ·»åŠ é¡¹ç›®æ—¶ä¼šå°†çˆ¶çº§çª—å£æŒ‡å®šä¸ºçˆ¶çº§ã€‚ä»…åˆ é™¤å®ƒä»¬ä¼šä½¿å®ƒä»¬æ¼‚æµ®åœ¨å¸ƒå±€å¤–çš„çª—å£ä¸­ã€‚

*Listing 295. app/minesweeper.py*

```python
    def clear_map(self):
        # ä»åœ°å›¾ä¸Šç§»é™¤æ‰€æœ‰ä½ç½®ï¼Œç›´è‡³è¾¾åˆ°æœ€å¤§å®¹é‡.
        for x in range(0, LEVELS[-1][1]): #1
            for y in range(0, LEVELS[-1][1]):
                c = self.grid.itemAtPosition(y, x)
                if c: #2
                    c.widget().close()
                    self.grid.removeItem(c)
```

> 1. ä¸ºäº†ç¡®ä¿æˆ‘ä»¬èƒ½å¤Ÿå¤„ç†æ‰€æœ‰å°ºå¯¸çš„åœ°å›¾ï¼Œæˆ‘ä»¬é‡‡ç”¨æœ€é«˜çº§åˆ«çš„å°ºå¯¸ã€‚
> 2. å¦‚æœç½‘æ ¼ä¸­è¯¥ä½ç½®æ²¡æœ‰å†…å®¹ï¼Œæˆ‘ä»¬å¯ä»¥è·³è¿‡å®ƒã€‚

ç°åœ¨æˆ‘ä»¬å·²ç»å°†ä½ç½®ç“·ç –å¯¹è±¡çš„ç½‘æ ¼å¸ƒå±€åˆ°ä½ï¼Œå¯ä»¥å¼€å§‹åˆ›å»ºæ¸¸æˆæ¿çš„åˆå§‹æ¡ä»¶ã€‚è¿™ä¸ªè¿‡ç¨‹ç›¸å½“å¤æ‚ï¼Œå› æ­¤è¢«åˆ†è§£ä¸ºå¤šä¸ªå‡½æ•°ã€‚æˆ‘ä»¬å°†å…¶å‘½åä¸º `_reset`ï¼ˆå‰ç¼€ä¸‹åˆ’çº¿æ˜¯è¡¨ç¤ºç§æœ‰å‡½æ•°çš„çº¦å®šï¼Œä¸ä¾›å¤–éƒ¨ä½¿ç”¨ï¼‰ã€‚ä¸»å‡½æ•° `reset_map` ä¾æ¬¡è°ƒç”¨è¿™äº›å‡½æ•°æ¥è¿›è¡Œè®¾ç½®ã€‚

æµç¨‹å¦‚ä¸‹ 

1. ç§»é™¤æ‰€æœ‰åœ°é›·ï¼ˆå¹¶é‡ç½®æ•°æ®ï¼‰å¹¶æ¸…ç©ºåœºåœ°ã€‚
2. åœ¨åœºåœ°ä¸­æ·»åŠ æ–°çš„åœ°é›·ã€‚
3. è®¡ç®—æ¯ä¸ªä½ç½®ç›¸é‚»åœ°é›·çš„æ•°é‡ã€‚
4. æ·»åŠ èµ·å§‹æ ‡è®°ï¼ˆç«ç®­ï¼‰å¹¶è§¦å‘åˆå§‹æ¢ç´¢ã€‚
5. é‡ç½®è®¡æ—¶å™¨ã€‚

*Listing 296. app/minesweeper.py*

```python
    def reset_map(self):
        self._reset_position_data()
        self._reset_add_mines()
        self._reset_calculate_adjacency()
        self._reset_add_starting_marker()
        self.update_timer()
```

ä»¥ä¸‹å°†ä¾æ¬¡è¯¦ç»†æè¿°æ­¥éª¤1è‡³5ï¼Œå¹¶é™„ä¸Šå„æ­¥éª¤çš„ä»£ç .

ç¬¬ä¸€æ­¥æ˜¯é‡ç½®åœ°å›¾ä¸Šæ¯ä¸ªä½ç½®çš„æ•°æ®ã€‚æˆ‘ä»¬éå†æ£‹ç›˜ä¸Šçš„æ¯ä¸ªä½ç½®ï¼Œåœ¨æ¯ä¸ªç‚¹ä¸Šè°ƒç”¨æ§ä»¶çš„ `.reset()` æ–¹æ³•ã€‚`.reset()` æ–¹æ³•çš„ä»£ç åœ¨æˆ‘ä»¬çš„è‡ªå®šä¹‰ `Pos` ç±»ä¸­å®šä¹‰ï¼Œæˆ‘ä»¬ç¨åä¼šè¯¦ç»†æ¢è®¨ã€‚ç›®å‰åªéœ€çŸ¥é“å®ƒä¼šæ¸…é™¤åœ°é›·ã€æ——å¸œï¼Œå¹¶å°†ä½ç½®è®¾ç½®ä¸ºæœªæ­ç¤ºçŠ¶æ€å³å¯ã€‚

*Listing 297. app/minesweeper.py*

```python
    def _reset_position_data(self):
        # æ¸…é™¤æ‰€æœ‰åœ°é›·ä½ç½®
        for x in range(0, self.b_size):
            for y in range(0, self.b_size):
                w = self.grid.itemAtPosition(y, x).widget()
                w.reset()
```

ç°åœ¨æ‰€æœ‰ä½ç½®å‡ä¸ºç©ºï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹å°†åœ°é›·æ·»åŠ åˆ°åœ°å›¾äº†ã€‚åœ°é›·çš„æœ€å¤§æ•°é‡ `n_mines` ç”±å…³å¡è®¾ç½®å®šä¹‰ï¼Œå¦‚å‰æ‰€è¿°ã€‚

*Listing 298. app/minesweeper.py*

```python
    def _reset_add_mines(self):
        # æ·»åŠ åœ°é›·ä½ç½®
        positions = []
        while len(positions) < self.n_mines:
            x, y = (
                random.randint(0, self.b_size - 1),
                random.randint(0, self.b_size - 1),
            )
            if (x, y) not in positions:
                w = self.grid.itemAtPosition(y, x).widget()
                w.is_mine = True
                positions.append((x, y))
               
            # è®¡ç®—ç»ˆå±€æ¡ä»¶
            self.end_game_n = (self.b_size * self.b_size) - (
                self.n_mines + 1
            )
            return positions
```

åœ°é›·å°±ä½åï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—æ¯ä¸ªä½ç½®çš„â€œé‚»è¿‘â€æ•°â€”â€”å³è¯¥ç‚¹å‘¨å›´ 3x3 ç½‘æ ¼å†…åœ°é›·çš„æ•°é‡ã€‚è‡ªå®šä¹‰å‡½æ•° `get_surrounding` ä»…è¿”å›ç»™å®šxå’Œyä½ç½®å‘¨å›´çš„è¿™äº›ä½ç½®ã€‚æˆ‘ä»¬ç»Ÿè®¡å…¶ä¸­ `is_mine == True`ï¼ˆå³ä¸ºåœ°é›·ï¼‰çš„æ•°é‡å¹¶å­˜å‚¨

![tips](tips.png)

> é¢„è®¡ç®—
>
> é€šè¿‡è¿™ç§æ–¹å¼é¢„è®¡ç®—ç›¸é‚»è®¡æ•°ï¼Œæœ‰åŠ©äºç®€åŒ–åç»­çš„æ˜¾ç¤ºé€»è¾‘ã€‚

*Listing 299. app/minesweeper.py*

```python
    def _reset_calculate_adjacency(self):
        def get_adjacency_n(x, y):
            positions = self.get_surrounding(x, y)
            return sum(1 for w in positions if w.is_mine)
        
        # ä¸ºä½ç½®æ·»åŠ ç›¸é‚»å…³ç³»
        for x in range(0, self.b_size):
            for y in range(0, self.b_size):
                w = self.grid.itemAtPosition(y, x).widget()
                w.adjacent_n = get_adjacency_n(x, y)
```

èµ·å§‹æ ‡è®°ç”¨äºç¡®ä¿ç¬¬ä¸€æ­¥æ€»æ˜¯æœ‰æ•ˆçš„ã€‚è¿™é€šè¿‡å¯¹ç½‘æ ¼ç©ºé—´è¿›è¡Œæš´åŠ›æœç´¢æ¥å®ç°ï¼Œå³éšæœºå°è¯•ä¸åŒä½ç½®ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªä¸æ˜¯åœ°é›·çš„ä½ç½®ã€‚ç”±äºæˆ‘ä»¬ä¸çŸ¥é“éœ€è¦å°è¯•å¤šå°‘æ¬¡ï¼Œå› æ­¤éœ€è¦å°†æ­¤è¿‡ç¨‹åŒ…è£¹åœ¨ä¸€ä¸ªå¾ªç¯ä¸­ã€‚

ä¸€æ—¦æ‰¾åˆ°è¯¥ä½ç½®ï¼Œæˆ‘ä»¬å°†å®ƒæ ‡è®°ä¸ºèµ·å§‹ä½ç½®ï¼Œç„¶åè§¦å‘å¯¹æ‰€æœ‰å‘¨è¾¹ä½ç½®çš„æ¢ç´¢ã€‚æˆ‘ä»¬é€€å‡ºå¾ªç¯ï¼Œå¹¶é‡ç½®å°±ç»ªçŠ¶æ€ã€‚

*Listing 300. app/minesweeper.py*

```python
    def _reset_add_starting_marker(self):
        # æ”¾ç½®èµ·å§‹æ ‡è®°.
        
        # è®¾ç½®åˆå§‹çŠ¶æ€ï¼ˆ.click åŠŸèƒ½éœ€è¦æ­¤è®¾ç½®ï¼‰
        self.update_status(STATUS_READY)
        
        while True:
            x, y = (
                random.randint(0, self.b_size - 1),
                random.randint(0, self.b_size - 1),
            )
            w = self.grid.itemAtPosition(y, x).widget()
            # æˆ‘ä»¬ä¸æƒ³ä»åœ°é›·ä¸Šå¼€å§‹.
            if not w.is_mine:
                w.is_start = True
                w.is_revealed = True
                w.update()
                
                # å¦‚æœè¿™äº›ä½ç½®ä¹Ÿä¸æ˜¯åœ°é›·ï¼Œåˆ™æ˜¾ç¤ºæ‰€æœ‰ç›¸å…³ä½ç½®.
                for w in self.get_surrounding(x, y):
                    if not w.is_mine:
                        w.click()
                       
                break
                      
        # åˆå§‹ç‚¹å‡»åå°†çŠ¶æ€é‡ç½®ä¸ºå°±ç»ª.
        self.update_status(STATUS_READY)
```

![Figure272](Figure272.png)

> å›¾272ï¼šç«ç®­çš„åˆæ­¥æ¢ç´¢

### ä½ç½®ç“·ç –

å¦‚å‰æ‰€è¿°ï¼Œæˆ‘ä»¬è®¾è®¡äº†æ¸¸æˆç»“æ„ï¼Œä½¿æ¯ä¸ªæ–¹å—çš„ä½ç½®éƒ½ä¿å­˜è‡ªå·±çš„çŠ¶æ€ä¿¡æ¯ã€‚è¿™æ„å‘³ç€ `Pos` å¯¹è±¡å¤„äºç†æƒ³çš„ä½ç½®ï¼Œå¯ä»¥å¤„ç†ä¸è‡ªèº«çŠ¶æ€ç›¸å…³çš„äº¤äº’ååº”çš„æ¸¸æˆé€»è¾‘ã€‚æ¢å¥è¯è¯´ï¼Œè¿™å°±æ˜¯å¥¥å¦™æ‰€åœ¨ä¹‹å¤„ã€‚

ç”±äº `Pos` ç±»ç›¸å¯¹å¤æ‚ï¼Œè¿™é‡Œå°†å…¶åˆ†è§£ä¸ºä¸»è¦ä¸»é¢˜ï¼Œå¹¶ä¾æ¬¡è¿›è¡Œè®¨è®ºã€‚åˆå§‹åŒ–è®¾ç½® `__init__` å—éå¸¸ç®€å•ï¼Œæ¥å— `x` å’Œ `y` åæ ‡å¹¶å°†å…¶å­˜å‚¨åœ¨å¯¹è±¡ä¸­ã€‚`Pos` åæ ‡ä¸€æ—¦åˆ›å»ºå°±ä¸ä¼šæ”¹å˜ã€‚

å®Œæˆè®¾ç½®åï¼Œæˆ‘ä»¬è°ƒç”¨ `.reset()` å‡½æ•°å°†æ‰€æœ‰å¯¹è±¡å±æ€§é‡ç½®ä¸ºé»˜è®¤å€¼ï¼Œå³é›¶å€¼ã€‚è¿™å°†æ ‡è®°è¯¥åœ°é›·ä¸ºéèµ·å§‹ä½ç½®ã€éåœ°é›·ã€æœªæ­ç¤ºä¸”æœªæ ‡è®°ã€‚æˆ‘ä»¬è¿˜é‡ç½®äº†ç›¸é‚»è®¡æ•°ã€‚

*Listing 301. app/minesweeper.py*

```python
class Pos(QWidget):
    
    expandable = pyqtSignal(int, int)
    revealed = pyqtSignal(object)
    clicked = pyqtSignal()
    
    def __init__(self, x, y):
        super().__init__()
        self.setFixedSize(QSize(20, 20))
        self.x = x
        self.y = y
        self.reset()

    def reset(self):
        self.is_start = False
        self.is_mine = False
        self.adjacent_n = 0
        self.is_revealed = False
        self.is_flagged = False
        
        self.update()
```

æ¸¸æˆç©æ³•ä»¥é¼ æ ‡ä¸æ¸¸æˆåœºä¸­çš„æ–¹å—çš„äº¤äº’ä¸ºä¸­å¿ƒï¼Œå› æ­¤æ£€æµ‹é¼ æ ‡ç‚¹å‡»å¹¶åšå‡ºååº”æ˜¯è‡³å…³é‡è¦çš„ã€‚åœ¨ Qt ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡æ£€æµ‹ `mouseReleaseEvent` æ¥æ•è·é¼ æ ‡ç‚¹å‡»ã€‚ä¸ºäº†å¯¹æˆ‘ä»¬çš„è‡ªå®šä¹‰ `Pos` æ§ä»¶æ‰§è¡Œæ­¤æ“ä½œï¼Œæˆ‘ä»¬åœ¨ç±»ä¸Šå®šä¹‰äº†ä¸€ä¸ªå¤„ç†ç¨‹åºã€‚è¯¥å¤„ç†ç¨‹åºæ¥æ”¶åŒ…å«å‘ç”Ÿäº‹ä»¶ä¿¡æ¯çš„ `QMouseEvent`ã€‚åœ¨æ­¤æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä»…å…³æ³¨é¼ æ ‡é‡Šæ”¾æ“ä½œæ˜¯æ¥è‡ªå·¦é”®è¿˜æ˜¯å³é”®ã€‚

å¯¹äºå·¦é”®ç‚¹å‡»ï¼Œæˆ‘ä»¬æ£€æŸ¥è¯¥æ–¹å—æ˜¯å¦å·²è¢«æ ‡è®°æˆ–å·²æ­å¼€ã€‚å¦‚æœå®ƒç¬¦åˆå…¶ä¸­ä¸€ç§æƒ…å†µï¼Œæˆ‘ä»¬å°†å¿½ç•¥è¯¥ç‚¹å‡»â€”â€”ä½¿æ ‡è®°è¿‡çš„æ–¹å—â€œå®‰å…¨â€ï¼Œæ— æ³•è¢«æ„å¤–ç‚¹å‡»ã€‚å¦‚æœæ–¹å—æœªè¢«æ ‡è®°ï¼Œæˆ‘ä»¬åªéœ€è°ƒç”¨ `.click()` æ–¹æ³•ï¼ˆè§åæ–‡ï¼‰ã€‚

å¯¹äºå³é”®ç‚¹å‡»æœªæ˜¾ç¤ºçš„ç“·ç –ï¼Œæˆ‘ä»¬è°ƒç”¨æˆ‘ä»¬çš„ `.toggle_flag()` æ–¹æ³•æ¥åˆ‡æ¢æ ‡å¿—çš„çŠ¶æ€ã€‚

*Listing 302. app/minesweeper.py*

```python
    def mouseReleaseEvent(self, e):
        if (
            e.button() == Qt.MouseButton.RightButton
            and not self.is_revealed
        ):
            self.toggle_flag()
            
        elif e.button() == Qt.MouseButton.LeftButton:
            # é˜»æ­¢ç‚¹å‡»æ ‡è®°çš„é›·åŒº.
            if not self.is_flagged and not self.is_revealed:
                self.click()
```

ç”±é¼ æ ‡é‡Šæ”¾äº‹ä»¶å¤„ç†ç¨‹åºè°ƒç”¨çš„æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š

`.toggle_flag` å¤„ç†ç¨‹åºä»…å°† `.is_flagged` è®¾ç½®ä¸ºå…¶è‡ªèº«çš„åè½¬å€¼ï¼ˆ`True` å˜ä¸º `False`ï¼Œ`False` å˜ä¸º `True`ï¼‰ï¼Œä»è€Œå®ç°å…¶å¼€å…³çŠ¶æ€çš„åˆ‡æ¢ã€‚æ³¨æ„ï¼Œæˆ‘ä»¬å¿…é¡»è°ƒç”¨ `.update()` æ–¹æ³•ä»¥å¼ºåˆ¶é‡æ–°ç»˜åˆ¶ï¼Œå› ä¸ºçŠ¶æ€å·²å‘ç”Ÿå˜åŒ–ã€‚æˆ‘ä»¬è¿˜å‘å‡ºè‡ªå®šä¹‰çš„ `.clicked` ä¿¡å·ï¼Œè¯¥ä¿¡å·ç”¨äºå¯åŠ¨è®¡æ—¶å™¨ï¼Œå› ä¸ºæ”¾ç½®æ ‡å¿—ä¹Ÿåº”ç®—ä½œå¯åŠ¨ï¼Œè€Œä¸ä»…ä»…æ˜¯æ˜¾ç¤ºä¸€ä¸ªæ–¹å—ã€‚

`.click()` æ–¹æ³•å¤„ç†é¼ æ ‡å·¦é”®ç‚¹å‡»ï¼Œå¹¶è§¦å‘æ˜¾ç¤ºæ­£æ–¹å½¢ã€‚å¦‚æœè¯¥ä½ç½®ç›¸é‚»çš„åœ°é›·æ•°é‡ä¸ºé›¶ï¼Œåˆ™è§¦å‘ `.expandable` ä¿¡å·ï¼Œå¼€å§‹è‡ªåŠ¨æ‰©å±•å·²æ¢ç´¢åŒºåŸŸï¼ˆè§ä¸‹æ–‡ï¼‰ã€‚æœ€åï¼Œæˆ‘ä»¬å†æ¬¡å‘å‡º `.clicked` ä¿¡å·ï¼Œä»¥æŒ‡ç¤ºæ¸¸æˆå¼€å§‹ã€‚

æœ€åï¼Œ`.reveal()` æ–¹æ³•æ£€æŸ¥è¯¥æ–¹å—æ˜¯å¦å·²ç»æ˜¾ç¤ºï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™å°† `.is_revealed` è®¾ç½®ä¸º `True`ã€‚å†æ¬¡è°ƒç”¨ `.update()` ä»¥è§¦å‘æ§ä»¶çš„é‡ç»˜ã€‚

å¯é€‰çš„ `.revealed` ä¿¡å·ä»…ç”¨äºæ¸¸æˆç»“æŸæ—¶å…¨åœ°å›¾çš„æ­ç¤ºã€‚ç”±äºæ¯æ¬¡æ­ç¤ºéƒ½ä¼šè§¦å‘è¿›ä¸€æ­¥çš„æŸ¥æ‰¾ï¼Œä»¥æŸ¥æ‰¾å“ªäº›ç“·ç –ä¹Ÿå¯ä»¥æ­ç¤ºï¼Œå› æ­¤æ­ç¤ºæ•´ä¸ªåœ°å›¾ä¼šäº§ç”Ÿå¤§é‡å†—ä½™çš„å›è°ƒã€‚é€šè¿‡åœ¨æ­¤å¤„æŠ‘åˆ¶ä¿¡å·ï¼Œæˆ‘ä»¬å¯ä»¥é¿å…è¿™ç§æƒ…å†µã€‚

*Listing 303. app/minesweeper.py*

```python
    def toggle_flag(self):
        self.is_flagged = not self.is_flagged
        self.update()
        
        self.clicked.emit()
        
    def click(self):
        self.reveal()
        if self.adjacent_n == 0:
            self.expandable.emit(self.x, self.y)
           
        self.clicked.emit()
        
    def reveal(self, emit=True):
        if not self.is_revealed:
            self.is_revealed = True
            self.update()
          
        if emit:
                self.revealed.emit(self)
```

æœ€åï¼Œæˆ‘ä»¬ä¸º `Pos` æ§ä»¶å®šä¹‰äº†ä¸€ä¸ªè‡ªå®šä¹‰çš„ `paintEvent` æ–¹æ³•ï¼Œä»¥å¤„ç†å½“å‰ä½ç½®çŠ¶æ€çš„æ˜¾ç¤ºã€‚å¦‚ å‰æ–‡æ‰€è¿°ï¼Œè¦åœ¨æ§ä»¶ç”»å¸ƒä¸Šæ‰§è¡Œè‡ªå®šä¹‰ç»˜åˆ¶ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª `QPainter` å’Œ `event.rect()`ï¼Œå®ƒæä¾›äº†æˆ‘ä»¬è¦ç»˜åˆ¶çš„è¾¹ç•Œâ€”â€”åœ¨æœ¬ä¾‹ä¸­ï¼Œæ˜¯ `Pos` æ§ä»¶çš„å¤–è¾¹æ¡†ã€‚

å·²æ­ç¤ºçš„æ–¹å—æ ¹æ®å…¶ç±»å‹ï¼ˆèµ·å§‹ä½ç½®ã€ç‚¸å¼¹æˆ–ç©ºæ ¼ï¼‰ä»¥ä¸åŒæ–¹å¼ç»˜åˆ¶ã€‚å‰ä¸¤ç§ç±»å‹åˆ†åˆ«ç”±ç«ç®­å’Œç‚¸å¼¹çš„å›¾æ ‡è¡¨ç¤ºã€‚è¿™äº›å›¾æ ‡é€šè¿‡ `.drawPixmap` æ–¹æ³•ç»˜åˆ¶åˆ°æ–¹å—çš„ `QRect` ä¸­ã€‚æ³¨æ„ï¼šæˆ‘ä»¬éœ€è¦å°†`QImage` å¸¸é‡è½¬æ¢ä¸ºåƒç´ å›¾ï¼Œé€šè¿‡å°† `QPixmap` ä¼ é€’ç»™ `QImage` çš„ `.toPixmap()` æ–¹æ³•å®ç°ã€‚

![tips](tips.png)

> QPixmap ä¸ QImages
>
> æ‚¨å¯èƒ½ä¼šæƒ³ï¼šâ€œæ—¢ç„¶æˆ‘ä»¬æ­£åœ¨ä½¿ç”¨å®ƒä»¬ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥å°†è¿™äº›å­˜å‚¨ä¸º `QPixmap` å¯¹è±¡ï¼Ÿæˆ‘ä»¬ä¸èƒ½è¿™æ ·åšå¹¶å°†å…¶å­˜å‚¨åœ¨å¸¸é‡ä¸­ï¼Œå› ä¸ºåœ¨æ‚¨çš„ `QApplication` å¯åŠ¨å¹¶è¿è¡Œä¹‹å‰ï¼Œæ‚¨æ— æ³•åˆ›å»º `QPixmap` å¯¹è±¡

å¯¹äºç©ºä½ï¼ˆéç«ç®­ã€éç‚¸å¼¹ï¼‰ï¼Œæˆ‘ä»¬å¯é€‰åœ°æ˜¾ç¤ºç›¸é‚»æ•°ï¼Œå¦‚æœè¯¥æ•°å¤§äºé›¶ã€‚ä¸ºäº†åœ¨ QPainter ä¸Šç»˜åˆ¶æ–‡æœ¬ï¼Œæˆ‘ä»¬ä½¿ç”¨ `.drawText()` æ–¹æ³•ï¼Œä¼ å…¥ `QRect`ã€å¯¹é½æ ‡å¿—ä»¥åŠè¦ç»˜åˆ¶çš„æ•°å­—ä½œä¸ºå­—ç¬¦ä¸²ã€‚æˆ‘ä»¬ä¸ºæ¯ä¸ªæ•°å­—å®šä¹‰äº†æ ‡å‡†é¢œè‰²ï¼ˆå­˜å‚¨åœ¨ `NUM_COLORS` ä¸­ï¼‰ï¼Œä»¥æé«˜æ˜“ç”¨æ€§ã€‚

å¯¹äºæœªæ˜¾ç¤ºçš„ç“·ç –ï¼Œæˆ‘ä»¬ç»˜åˆ¶ä¸€ä¸ªç“·ç –ï¼Œé€šè¿‡ç”¨æµ…ç°è‰²å¡«å……ä¸€ä¸ªçŸ©å½¢å¹¶ç»˜åˆ¶ä¸€ä¸ª1åƒç´ å®½çš„æ·±ç°è‰²è¾¹æ¡†ã€‚å¦‚æœ `.is_flagged` è¢«è®¾ç½®ï¼Œæˆ‘ä»¬è¿˜ä¼šåœ¨ç“·ç –ä¸Šæ–¹ç»˜åˆ¶ä¸€ä¸ªæ——å¸œå›¾æ ‡ä½¿ç”¨ `drawPixmap` å’Œç“·ç –çš„ `QRect`ã€‚

*Listing 304. app/minesweeper.py*

```python
    def paintEvent(self, event):
        p = QPainter(self)
        p.setRenderHint(QPainter.RenderHint.Antialiasing)
        
        r = event.rect()
        
        if self.is_revealed:
            if self.is_start:
                p.drawPixmap(r, QPixmap(IMG_START))
                
            elif self.is_mine:
                p.drawPixmap(r, QPixmap(IMG_BOMB))
                
            elif self.adjacent_n > 0:
                pen = QPen(NUM_COLORS[self.adjacent_n])
                p.setPen(pen)
                f = p.font()
                f.setBold(True)
                p.setFont(f)
                p.drawText(
                    r,
                    Qt.AlignmentFlag.AlignHCenter
                    | Qt.AlignmentFlag.AlignVCenter,
                    str(self.adjacent_n),
                )
           
        else:
            p.fillRect(r, QBrush(Qt.GlobalColor.lightGray))
            pen = QPen(Qt.GlobalColor.gray)
            pen.setWidth(1)
            p.setPen(pen)
            p.drawRect(r)
            if self.is_flagged:
                p.drawPixmap(r, QPixmap(IMG_FLAG))
```

### æ¸¸æˆè¿‡ç¨‹

æˆ‘ä»¬é€šå¸¸éœ€è¦è·å–ç»™å®šç‚¹å‘¨å›´çš„æ‰€æœ‰å›¾å—ï¼Œå› æ­¤æˆ‘ä»¬ä¸ºæ­¤å®šåˆ¶äº†ä¸€ä¸ªå‡½æ•°ã€‚å®ƒç®€å•åœ°éå†è¯¥ç‚¹å‘¨å›´çš„ 3x3 ç½‘æ ¼ï¼Œå¹¶æ£€æŸ¥ä»¥ç¡®ä¿æˆ‘ä»¬ä¸ä¼šè¶…å‡ºç½‘æ ¼è¾¹ç¼˜çš„èŒƒå›´ï¼ˆ`0 â‰¥ x â‰¤ self.b_size`ï¼‰ã€‚è¿”å›çš„åˆ—è¡¨åŒ…å«æ¯ä¸ªå‘¨å›´ä½ç½®çš„ `Pos` æ§ä»¶ã€‚

*Listing 305. app/minesweeper.py*

```python
    def get_surrounding(self, x, y):
        positions = [
        for xi in range(max(0, x - 1), min(x + 2, self.b_size)):
            for yi in range(max(0, y - 1), min(y + 2, self.b_size)):
                if not (xi == x and yi == y):
                    positions.append(
                        self.grid.itemAtPosition(yi, xi).widget()
                    )
                   
        return positions
```

`expand_reveal` æ–¹æ³•åœ¨ç‚¹å‡»ä¸€ä¸ªå‘¨å›´æ²¡æœ‰åœ°é›·çš„æ–¹å—æ—¶è§¦å‘ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›å°†ç‚¹å‡»åŒºåŸŸæ‰©å±•åˆ°ä»»ä½•å‘¨å›´ä¹Ÿæ²¡æœ‰åœ°é›·çš„åŒºåŸŸï¼Œå¹¶æ­ç¤ºæ‰©å±•åŒºåŸŸè¾¹ç•Œå‘¨å›´çš„ä»»ä½•éåœ°é›·æ–¹å—ã€‚

è¿™å¯ä»¥é€šè¿‡æŸ¥çœ‹ç‚¹å‡»æ–¹å—å‘¨å›´çš„æ‰€æœ‰æ–¹å—æ¥å®ç°ï¼Œå¹¶å¯¹ä»»ä½• `.n_adjacent == 0` çš„æ–¹å—è§¦å‘ `.click()`ã€‚æ­£å¸¸çš„æ¸¸æˆé€»è¾‘ä¼šæ¥ç®¡å¹¶è‡ªåŠ¨æ‰©å±•åŒºåŸŸã€‚ç„¶è€Œï¼Œè¿™æœ‰äº›ä½æ•ˆï¼Œä¼šäº§ç”Ÿå¤§é‡å†—ä½™ä¿¡å·ï¼ˆæ¯ä¸ªæ–¹å—ä¼šä¸ºæ¯ä¸ªå‘¨å›´æ–¹å—è§¦å‘å¤šè¾¾ 9 ä¸ªä¿¡å·ï¼‰ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æ›´é«˜æ•ˆçš„æ–¹æ³•æ¥å¤„ç†è¿™äº›ä¿¡å·ã€‚

ç›¸åï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªç‹¬ç«‹çš„æ–¹æ³•æ¥ç¡®å®šè¦æ˜¾ç¤ºçš„åŒºåŸŸï¼Œç„¶åè§¦å‘æ˜¾ç¤ºï¼ˆä½¿ç”¨ `.reveal()` æ¥é¿å… `.clicked` ä¿¡å·ï¼‰ã€‚

æˆ‘ä»¬é¦–å…ˆåˆ›å»ºä¸€ä¸ªåˆ—è¡¨ `to_expand`ï¼Œå…¶ä¸­åŒ…å«ä¸‹ä¸€æ¬¡è¿­ä»£è¦æ£€æŸ¥çš„ä½ç½®ï¼›ä¸€ä¸ªåˆ—è¡¨ `to_reveal`ï¼Œå…¶ä¸­åŒ…å«è¦æ˜¾ç¤ºçš„ç“·ç –æ§ä»¶ï¼›ä»¥åŠä¸€ä¸ªæ ‡å¿— `any_added`ï¼Œç”¨äºç¡®å®šä½•æ—¶é€€å‡ºå¾ªç¯ã€‚å½“ `to_reveal` ä¸­æ²¡æœ‰æ·»åŠ æ–°æ§ä»¶æ—¶ï¼Œå¾ªç¯å°±ä¼šåœæ­¢ã€‚

åœ¨å¾ªç¯å†…éƒ¨ï¼Œæˆ‘ä»¬å°† `any_added` é‡ç½®ä¸º `False`ï¼Œå¹¶æ¸…ç©º `to_expand` åˆ—è¡¨ï¼ŒåŒæ—¶åœ¨ `l` ä¸­ä¿ç•™ä¸€ä¸ªä¸´æ—¶å­˜å‚¨ç©ºé—´ç”¨äºè¿­ä»£ã€‚

å¯¹äºæ¯ä¸ª `x` å’Œ `y` ä½ç½®ï¼Œæˆ‘ä»¬è·å–å‘¨å›´çš„ 8 ä¸ªæ§ä»¶ã€‚å¦‚æœè¿™äº›æ§ä»¶ä¸­ä»»ä½•ä¸€ä¸ªä¸æ˜¯åœ°é›·ï¼Œå¹¶ä¸”å°šæœªæ·»åŠ åˆ° `to_reveal` åˆ—è¡¨ä¸­ï¼Œåˆ™å°†å…¶æ·»åŠ åˆ°è¯¥åˆ—è¡¨ä¸­ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿æ‰©å±•åŒºåŸŸçš„è¾¹ç¼˜å…¨éƒ¨è¢«æ­ç¤ºã€‚å¦‚æœè¯¥ä½ç½®æ²¡æœ‰ç›¸é‚»çš„åœ°é›·ï¼Œæˆ‘ä»¬å°†åæ ‡é™„åŠ åˆ° `to_expand`ï¼Œä»¥ä¾¿åœ¨ä¸‹æ¬¡è¿­ä»£æ—¶è¿›è¡Œæ£€æŸ¥ã€‚

é€šè¿‡å°†ä»»ä½•éåœ°é›·æ–¹å—æ·»åŠ åˆ° `to_reveal` ä¸­ï¼Œå¹¶ä¸”ä»…å±•å¼€é‚£äº›å°šæœªåœ¨ `to_reveal` ä¸­å­˜åœ¨çš„æ–¹å—ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®ä¿ä¸ä¼šè®¿é—®åŒä¸€æ–¹å—è¶…è¿‡ä¸€æ¬¡ã€‚

*Listing 306. app/minesweeper.py*

```python
    def expand_reveal(self, x, y):
        """
        ä»åˆå§‹ç‚¹å¼€å§‹å‘å¤–è¿­ä»£ï¼Œå°†æ–°ä½ç½®æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ã€‚è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿä¸€æ¬¡æ€§å±•å¼€æ‰€æœ‰å†…å®¹ï¼Œè€Œä¸æ˜¯ä¾èµ–å¤šä¸ªå›è°ƒ.
        """
        to_expand = [(x, y)]
        to_reveal = []
        any_added = True
        
        while any_added:
            any_added = False
            to_expand, l = [], to_expand
            
            for x, y in l:
                positions = self.get_surrounding(x, y)
                for w in positions:
                    if not w.is_mine and w not in to_reveal:
                        to_reveal.append(w)
                        if w.adjacent_n == 0:
                            to_expand.append((w.x, w.y))
                            any_added = True
                           
        # éå†å¹¶æ˜¾ç¤ºæˆ‘ä»¬æ‰¾åˆ°çš„æ‰€æœ‰ä½ç½®.
        for w in to_reveal:
            w.reveal()
```

### ç»ˆå±€

ç»ˆå±€çŠ¶æ€åœ¨ç‚¹å‡»æ ‡é¢˜åè¿›è¡Œçš„æ˜¾ç¤ºè¿‡ç¨‹ä¸­è¢«æ£€æµ‹åˆ°ã€‚æœ‰ä¸¤ç§å¯èƒ½çš„ç»“æœâ€”â€”

1. åœ°ç –æ˜¯åœ°é›·ï¼Œæ¸¸æˆç»“æŸã€‚
2. åœ°ç –ä¸æ˜¯åœ°é›·ï¼Œå‡å°‘ `self.end_game_n` ã€‚

æ­¤è¿‡ç¨‹æŒç»­è¿›è¡Œï¼Œç›´åˆ° `self.end_game_n` è¾¾åˆ°é›¶ï¼Œè¿™å°†è§¦å‘æ¸¸æˆç»“æŸæµç¨‹ï¼Œé€šè¿‡è°ƒç”¨ `game_over` æˆ– `game_won` å‡½æ•°æ¥å®ç°ã€‚æˆåŠŸæˆ–å¤±è´¥çš„è§¦å‘æ¡ä»¶æ˜¯æ­ç¤ºåœ°å›¾å¹¶è®¾ç½®ç›¸å…³çŠ¶æ€ï¼Œåœ¨ä¸¤ç§æƒ…å†µä¸‹å‡éœ€æ‰§è¡Œæ­¤æ“ä½œã€‚

*Listing 307. app/minesweeper.py*

```python
    def on_reveal(self, w):
        if w.is_mine:
            self.game_over()
            
        else:
            self.end_game_n -= 1 # å‡å°‘å‰©ä½™ç©ºä½
            
            if self.end_game_n == 0:
                self.game_won()
                
    def game_over(self):
        self.reveal_map()
        self.update_status(STATUS_FAILED)
        
    def game_won(self):
        self.reveal_map()
        self.update_status(STATUS_SUCCESS)
```

![Figure273](Figure273.png)

> å›¾273ï¼šå“¦ä¸ã€‚è¢«Bâ€™ugåƒæ‰äº†ã€‚

### çŠ¶æ€

Moonsweeper çš„ç”¨æˆ·ç•Œé¢éå¸¸ç®€å•ï¼šä¸€ä¸ªæ˜¾ç¤ºå±æ˜¾ç¤ºåœ°é›·çš„æ•°é‡ï¼Œä¸€ä¸ªæ˜¾ç¤ºå±æ˜¾ç¤ºå·²è¿‡å»çš„æ—¶é—´ï¼Œä»¥åŠä¸€ä¸ªç”¨äºå¯åŠ¨/é‡æ–°å¯åŠ¨æ¸¸æˆçš„æŒ‰é’®ã€‚

è¿™ä¸¤ä¸ªæ ‡ç­¾å‡è¢«å®šä¹‰ä¸º `QLabel` å¯¹è±¡ï¼Œä¸”ä½¿ç”¨ç›¸åŒçš„ `QFont` å­—ä½“å¤§å°å’Œé¢œè‰²ã€‚è¿™äº›æ ‡ç­¾åœ¨ `QMainWindow` å¯¹è±¡ä¸Šè¿›è¡Œå®šä¹‰ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥åœ¨åç»­æ—¶é—´è®¿é—®å¹¶æ›´æ–°å®ƒä»¬ã€‚å¦å¤–ï¼Œè¿˜å®šä¹‰äº†ä¸¤ä¸ªé¢å¤–çš„å›¾æ ‡ï¼ˆæ—¶é’Ÿå’Œåœ°é›·ï¼‰ä½œä¸º `QLabel` å¯¹è±¡ã€‚

è¯¥æŒ‰é’®æ˜¯ä¸€ä¸ªå¸¦æœ‰å®šä¹‰å›¾æ ‡çš„ `QPushButton`ï¼Œè¯¥å›¾æ ‡åœ¨ `set_status` ä¸­æ ¹æ®çŠ¶æ€å˜åŒ–è¿›è¡Œæ›´æ–°ã€‚`.pressed` ä¿¡å·è¿æ¥åˆ°è‡ªå®šä¹‰æ§½æ–¹æ³• `button_pressed`ï¼Œè¯¥æ–¹æ³•æ ¹æ®æ¸¸æˆçŠ¶æ€ä»¥ä¸åŒçš„æ–¹å¼å¤„ç†ä¿¡å·ã€‚

*Listing 308. app/minesweeper.py*

```python
        self.mines = QLabel()
        self.mines.setAlignment(
            Qt.AlignmentFlag.AlignHCenter
            | Qt.AlignmentFlag.AlignVCenter
        )
        
        self.clock = QLabel()
        self.clock.setAlignment(
            Qt.AlignmentFlag.AlignHCenter
            | Qt.AlignmentFlag.AlignVCenter
        )
        
        f = self.mines.font()
        f.setPointSize(24)
        f.setWeight(QFont.Weight.Bold)
        self.mines.setFont(f)
        self.clock.setFont(f)
        
        self.clock.setText("000")
        
        self.button = QPushButton()
        self.button.setFixedSize(QSize(32, 32))
        self.button.setIconSize(QSize(32, 32))
        self.button.setIcon(QIcon(Paths.icon("smiley.png")))
        self.button.setFlat(True)
        
        self.button.pressed.connect(self.button_pressed)
        
        self.statusBar()
        l = QLabel()
        l.setPixmap(QPixmap.fromImage(IMG_BOMB))
        l.setAlignment(
            Qt.AlignmentFlag.AlignRight | Qt.AlignmentFlag
            .AlignVCenter
        )
        hb.addWidget(l)
        
        hb.addWidget(self.mines)
        hb.addWidget(self.button)
        hb.addWidget(self.clock)
        
        l = QLabel()
        l.setPixmap(QPixmap.fromImage(IMG_CLOCK))
        l.setAlignment(
            Qt.AlignmentFlag.AlignLeft | Qt.AlignmentFlag.AlignVCenter
        )
        hb.addWidget(l)
        
        vb = QVBoxLayout()
        vb.setSizeConstraint(QLayout.SizeConstraint.SetFixedSize)
        vb.addLayout(hb)
```

å¦‚æœæ¸¸æˆå½“å‰æ­£åœ¨è¿›è¡Œä¸­ï¼Œä¸” `self.status == STATUS_PLAYING`ï¼Œåˆ™æŒ‰ä¸‹æŒ‰é’®ä¼šè¢«è§£é‡Šä¸ºâ€œæˆ‘æ”¾å¼ƒâ€ï¼Œå¹¶è§¦å‘æ¸¸æˆç»“æŸçŠ¶æ€ã€‚

å¦‚æœå½“å‰æ¸¸æˆçŠ¶æ€ä¸ºè·èƒœï¼ˆ`self.status == STATUS_SUCCESS`ï¼‰æˆ–å¤±è´¥ï¼ˆ`self.status ==STATUS_FAILED`ï¼‰ï¼Œåˆ™æŒ‰ä¸‹æŒ‰é’®è¢«è§†ä¸ºâ€œé‡æ–°å°è¯•â€ï¼Œæ¸¸æˆåœ°å›¾å°†è¢«é‡ç½®ã€‚

*Listing 309. app/minesweeper.py*

```python
    def button_pressed(self):
        if self.status == STATUS_PLAYING:
            self.game_over()
            
        elif (
            self.status == STATUS_FAILED
            or self.status == STATUS_SUCCESS
        ):
            self.reset_map()
```

### èœå•

Moonsweeper åªæœ‰ä¸€ä¸ªèœå•ï¼Œç”¨äºæ§åˆ¶æ¸¸æˆã€‚æˆ‘ä»¬é€šè¿‡è°ƒç”¨ `QMainWindow.menuBar()` çš„ `.addMenu()` æ–¹æ³•æ¥åˆ›å»º `QMenu`ï¼Œä¸é€šå¸¸æ“ä½œä¸€è‡´ã€‚

ç¬¬ä¸€ä¸ªèœå•é¡¹æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ `QAction` ï¼Œç”¨äºâ€œæ–°æ¸¸æˆâ€ï¼Œå…¶ `.triggered` å±æ€§ä¸ `.reset_map` å‡½æ•°å…³è”ï¼Œè¯¥å‡½æ•°è´Ÿè´£æ•´ä¸ªåœ°å›¾çš„åˆå§‹åŒ–è¿‡ç¨‹ã€‚å¯¹äºæ–°æ¸¸æˆï¼Œæˆ‘ä»¬ä¿ç•™ç°æœ‰çš„æ£‹ç›˜å¤§å°å’Œå¸ƒå±€ï¼Œå› æ­¤æ— éœ€é‡æ–°åˆå§‹åŒ–åœ°å›¾ã€‚

æ­¤å¤–ï¼Œæˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªå­èœå• â€œLevelsâ€ï¼Œå…¶ä¸­åŒ…å« `LEVELS` ä¸­å®šä¹‰çš„æ¯ä¸ªçº§åˆ«çš„ `QAction`ã€‚çº§åˆ«åç§°å–è‡ªç›¸åŒçš„å¸¸é‡ï¼Œè‡ªå®šä¹‰çŠ¶æ€æ¶ˆæ¯ç”±å­˜å‚¨çš„å°ºå¯¸æ„å»ºã€‚æˆ‘ä»¬å°†åŠ¨ä½œ `.triggered` ä¿¡å·è¿æ¥åˆ° `.set_level`ï¼Œä½¿ç”¨ `lambda` æ–¹æ³•ä¸¢å¼ƒé»˜è®¤ä¿¡å·æ•°æ®ï¼Œå¹¶ä¼ é€’çº§åˆ«ç¼–å·ã€‚

*Listing 310. app/minesweeper.py*

```python
        game_menu = self.menuBar().addMenu("&Game")
    
        new_game_action = QAction("New game", self)
        new_game_action.setStatusTip(
            "Start a new game (your current game will be lost)"
        )
        new_game_action.triggered.connect(self.reset_map)
        game_menu.addAction(new_game_action)
        
        levels = game_menu.addMenu("Levels")
        for n, level in enumerate(LEVELS):
            level_action = QAction(level[0], self)
            level_action.setStatusTip(
                "{1}x{1} grid, with {2} mines".format(*level)
            )
            level_action.triggered.connect(
                lambda checked=None, n=n: self.set_level(n)
            )
            levels.addAction(level_action)
```

### ç»§ç»­æ·±å…¥

è¯·æ‚¨æŸ¥çœ‹æˆ‘ä»¬å°šæœªä»‹ç»çš„æºä»£ç çš„å…¶ä½™éƒ¨åˆ†ã€‚

![tips](tips.png)

> æŒ‘æˆ˜
>
> æ‚¨è¿˜å¯ä»¥å°è¯•è¿›è¡Œä»¥ä¸‹ä¿®æ”¹â€”â€”
>
> - å°è¯•ä¿®æ”¹å›¾å½¢ï¼Œåˆ¶ä½œä½ è‡ªå·±çš„ä¸»é¢˜ç‰ˆæ‰«é›·æ¸¸æˆã€‚
> - æ·»åŠ å¯¹éæ­£æ–¹å½¢æ¸¸æˆåŒºåŸŸçš„æ”¯æŒã€‚çŸ©å½¢ï¼Ÿä¸å¦¨è¯•è¯•åœ†å½¢ï¼
> - å°†è®¡æ—¶å™¨æ”¹ä¸ºå€’è®¡æ—¶â€”â€”åœ¨æœˆçƒä¸Šä¸æ—¶é—´èµ›è·‘ï¼
> - æ·»åŠ é“å…·ï¼šæ–¹å—æä¾›å¥–åŠ±ã€é¢å¤–æ—¶é—´ã€æ— æ•ŒçŠ¶æ€ã€‚
