# å¹¶å‘æ‰§è¡Œ

> è®¡ç®—æœºä¸åº”æµªè´¹æ‚¨çš„æ—¶é—´ï¼Œä¹Ÿä¸åº”è¦æ±‚æ‚¨åšè¶…è¿‡ä¸¥æ ¼å¿…è¦çš„å·¥ä½œã€‚
>
> â€”â€”Jef Raskin,ï¼Œç”¨æˆ·ç•Œé¢è®¾è®¡ç¬¬äºŒå®šå¾‹

é€šè¿‡è°ƒç”¨ `QApplication` å¯¹è±¡ä¸Šçš„ `.exec()` å¯åŠ¨çš„äº‹ä»¶å¾ªç¯åœ¨ä¸ Python ä»£ç ç›¸åŒçš„çº¿ç¨‹ä¸­è¿è¡Œã€‚è¿è¡Œæ­¤äº‹ä»¶å¾ªç¯çš„çº¿ç¨‹ï¼ˆé€šå¸¸ç§°ä¸ºå›¾å½¢ç”¨æˆ·ç•Œé¢çº¿ç¨‹ï¼‰è¿˜è´Ÿè´£å¤„ç†ä¸ä¸»æœºæ“ä½œç³»ç»Ÿä¹‹é—´çš„æ‰€æœ‰çª—å£é€šä¿¡ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œäº‹ä»¶å¾ªç¯è§¦å‘çš„ä»»ä½•æ‰§è¡Œä¹Ÿå°†åœ¨è¯¥çº¿ç¨‹ä¸­åŒæ­¥è¿è¡Œã€‚å®é™…ä¸Šï¼Œè¿™æ„å‘³ç€å½“æ‚¨çš„ PyQt6 åº”ç”¨ç¨‹åºåœ¨ä»£ç ä¸­æ‰§è¡ŒæŸé¡¹æ“ä½œæ—¶ï¼Œçª—å£é€šä¿¡å’Œå›¾å½¢ç”¨æˆ·ç•Œé¢äº¤äº’éƒ½ä¼šè¢«å†»ç»“ã€‚

å¦‚æœæ‚¨æ­£åœ¨æ‰§è¡Œçš„æ“ä½œæ¯”è¾ƒç®€å•ï¼Œå¹¶ä¸”èƒ½å¤Ÿå¿«é€Ÿå°†æ§åˆ¶æƒè¿”å›ç»™å›¾å½¢ç”¨æˆ·ç•Œé¢å¾ªç¯ï¼Œé‚£ä¹ˆç”¨æˆ·ä¸ä¼šå¯Ÿè§‰åˆ°è¿™ç§å†»ç»“ç°è±¡ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ‚¨éœ€è¦æ‰§è¡Œè¾ƒé•¿æ—¶é—´çš„ä»»åŠ¡ï¼Œä¾‹å¦‚æ‰“å¼€/å†™å…¥å¤§æ–‡ä»¶ã€ä¸‹è½½ä¸€äº›æ•°æ®æˆ–æ¸²æŸ“ä¸€äº›å¤æ‚çš„å›¾åƒï¼Œå°±ä¼šå‡ºç°é—®é¢˜ã€‚å¯¹äºæ‚¨çš„ç”¨æˆ·æ¥è¯´ï¼Œåº”ç”¨ç¨‹åºä¼¼ä¹æ²¡æœ‰å“åº”ã€‚ç”±äºæ‚¨çš„åº”ç”¨ç¨‹åºä¸å†ä¸æ“ä½œç³»ç»Ÿé€šä¿¡ï¼Œæ“ä½œç³»ç»Ÿä¼šè®¤ä¸ºå®ƒå·²ç»å´©æºƒâ€”â€”åœ¨ macOS ä¸Šï¼Œæ‚¨ä¼šçœ‹åˆ°â€œæ­»äº¡æ—‹è½¬è½®â€ï¼›åœ¨ Windows ä¸Šï¼Œæ‚¨ä¼šçœ‹åˆ°â€œè“å±â€ã€‚è¿™æ˜¾ç„¶ä¸æ˜¯ç†æƒ³çš„ç”¨æˆ·ä½“éªŒã€‚

è§£å†³æ–¹æ¡ˆå¾ˆç®€å•â€”â€”å°†å·¥ä½œä»å›¾å½¢ç”¨æˆ·ç•Œé¢çº¿ç¨‹ä¸­ç§»å‡ºã€‚PyQt6 æä¾›äº†ç›´è§‚çš„ç•Œé¢æ¥å®Œæˆè¿™é¡¹å·¥ä½œã€‚

## 24. çº¿ç¨‹ä¸è¿›ç¨‹ç®€ä»‹

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç”¨äº PyQt6 çš„æœ€å°ç¤ºä¾‹åº”ç”¨ç¨‹åºï¼Œå®ƒå°†ä½¿æˆ‘ä»¬èƒ½å¤Ÿæ¼”ç¤ºé—®é¢˜å¹¶éšåè¿›è¡Œä¿®å¤ã€‚æ‚¨å¯ä»¥å°†æ­¤ä»£ç å¤åˆ¶å¹¶ç²˜è´´åˆ°ä¸€ä¸ªæ–°æ–‡ä»¶ä¸­ï¼Œå¹¶å°†å…¶ä¿å­˜ä¸ºé€‚å½“çš„æ–‡ä»¶åï¼Œä¾‹å¦‚ `concurrent.py`ã€‚

*Listing 171. bad_example_1.py*

```python
import sys
import time

from PyQt6.QtCore import QTimer
from PyQt6.QtWidgets import (
    QApplication,
    QLabel,
    QMainWindow,
    QPushButton,
    QVBoxLayout,
    QWidget,
)


class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        
        self.counter = 0
        
        layout = QVBoxLayout()
        self.l = QLabel("Start")
        b = QPushButton("DANGER!")
        b.pressed.connect(self.oh_no)
        
        layout.addWidget(self.l)
        layout.addWidget(b)
        
        w = QWidget()
        w.setLayout(layout)
        self.setCentralWidget(w)
        
        self.show()
        
        self.timer = QTimer()
        self.timer.setInterval(1000)
        self.timer.timeout.connect(self.recurring_timer)
        self.timer.start()
        
    def oh_no(self):
        time.sleep(5)
        
    def recurring_timer(self):
        self.counter += 1
        self.l.setText("Counter: %d" % self.counter)
        
        
app = QApplication(sys.argv)
window = MainWindow()
app.exec()
```

> ğŸš€ **è¿è¡Œå®ƒå§ï¼** å°†å‡ºç°ä¸€ä¸ªçª—å£ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªæŒ‰é’®å’Œä¸€ä¸ªæ•°å­—ï¼Œè¯¥æ•°å­—æ­£åœ¨å‘ä¸Šè®¡æ•°ã€‚

![Figure198](Figure198.png)

> å›¾198ï¼šè¯¥æ•°å­—å°†ä»¥æ¯ç§’å¢åŠ 1çš„é€Ÿåº¦æŒç»­å¢é•¿ï¼Œåªè¦äº‹ä»¶å¾ªç¯ä»åœ¨è¿è¡Œã€‚

è¿™æ˜¯ç”±ä¸€ä¸ªç®€å•çš„å®šæ—¶å™¨ç”Ÿæˆçš„ï¼Œæ¯ç§’è§¦å‘ä¸€æ¬¡ã€‚æ‚¨å¯ä»¥å°†å®ƒè§†ä¸ºæˆ‘ä»¬çš„äº‹ä»¶å¾ªç¯æŒ‡ç¤ºå™¨â€”â€”è¿™æ˜¯ä¸€ç§ç®€å•çš„æ–¹å¼ï¼Œè®©æˆ‘ä»¬çŸ¥é“åº”ç”¨ç¨‹åºæ­£åœ¨æ­£å¸¸è¿è¡Œã€‚è¿˜æœ‰ä¸€ä¸ªæ ‡æœ‰â€œå±é™©ï¼â€çš„æŒ‰é’®ã€‚è¯·æ‚¨è¯•ç€ç‚¹å‡»å®ƒã€‚

![Figure199](Figure199.png)

> å›¾199ï¼šæŒ‰ä¸‹æŒ‰é’®ï¼ï¼

æ‚¨ä¼šå‘ç°æ¯æ¬¡æŒ‰ä¸‹æŒ‰é’®æ—¶è®¡æ•°å™¨éƒ½ä¼šåœæ­¢è®¡æ•°ï¼Œè€Œæ‚¨çš„åº”ç”¨ç¨‹åºä¼šå®Œå…¨å†»ç»“ã€‚åœ¨Windowsç³»ç»Ÿä¸­ï¼Œæ‚¨å¯èƒ½ä¼šçœ‹åˆ°çª—å£å˜ä¸ºæµ…è‰²ï¼Œè¡¨æ˜å…¶æœªå“åº”ï¼Œè€Œåœ¨macOSç³»ç»Ÿä¸­ï¼Œæ‚¨å¯èƒ½ä¼šçœ‹åˆ°æ—‹è½¬çš„â€œæ­»äº¡ä¹‹è½®â€ã€‚

çœ‹ä¼¼å†»ç»“çš„ç•Œé¢å®é™…ä¸Šæ˜¯ç”±äº Qt äº‹ä»¶å¾ªç¯è¢«é˜»å¡ï¼Œæ— æ³•å¤„ç†ï¼ˆå¹¶å“åº”ï¼‰çª—å£äº‹ä»¶ã€‚æ‚¨å¯¹çª—å£çš„ç‚¹å‡»ä»ä¼šè¢«å®¿ä¸»æ“ä½œç³»ç»Ÿè®°å½•å¹¶å‘é€è‡³æ‚¨çš„åº”ç”¨ç¨‹åºï¼Œä½†ç”±äºè¿™äº›äº‹ä»¶è¢«å¡åœ¨æ‚¨ä»£ç ä¸­çš„æ—¶é—´å»¶è¿Ÿï¼ˆ`time.sleep`ï¼‰éƒ¨åˆ†ï¼Œåº”ç”¨ç¨‹åºæ— æ³•æ¥å—æˆ–å“åº”è¿™äº›äº‹ä»¶ã€‚å› æ­¤ï¼Œåº”ç”¨ç¨‹åºæ— æ³•å“åº”ï¼Œæ“ä½œç³»ç»Ÿå°†å…¶è§£è¯»ä¸ºå†»ç»“æˆ–å¡æ­»ã€‚

### é”™è¯¯çš„æ–¹æ³•

è§£å†³æ­¤é—®é¢˜çš„æœ€ç®€å•æ–¹æ³•æ˜¯åœ¨ä»£ç å†…éƒ¨å¤„ç†äº‹ä»¶ã€‚è¿™å°†å…è®¸ Qt ç»§ç»­å“åº”ä¸»æœºæ“ä½œç³»ç»Ÿï¼Œè€Œæ‚¨çš„åº”ç”¨ç¨‹åºå°†ä¿æŒå“åº”ã€‚æ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨ `QApplication` ç±»çš„é™æ€ `.processEvents()` å‡½æ•°è½»æ¾å®ç°è¿™ä¸€ç‚¹ã€‚åªéœ€åœ¨æ‚¨çš„é•¿è¿è¡Œä»£ç å—ä¸­çš„æŸä¸ªä½ç½®æ·»åŠ ç±»ä¼¼ä»¥ä¸‹çš„ä»£ç è¡Œï¼š

```python
QApplication.processEvents()
```

å¦‚æœæˆ‘ä»¬å°†é•¿æœŸè¿è¡Œçš„ `time.sleep` ä»£ç åˆ†è§£ä¸ºå¤šä¸ªæ­¥éª¤ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å…¶ä¸­æ’å…¥ `.processEvents`ã€‚ç›¸åº”çš„ä»£ç å¦‚ä¸‹ï¼š

```python
def oh_no(self):
    for n in range(5):
        QApplication.processEvents()
        time.sleep(1)
```

ç°åœ¨ï¼Œå½“æ‚¨æŒ‰ä¸‹æŒ‰é’®æ—¶ï¼Œæ‚¨çš„ä»£ç ä¼šåƒä»¥å‰ä¸€æ ·è¢«æ‰§è¡Œã€‚ç„¶è€Œï¼Œç°åœ¨`QApplication.processEvents()` ä¼šé—´æ­‡æ€§åœ°å°†æ§åˆ¶æƒäº¤è¿˜ç»™ Qtï¼Œå¹¶å…è®¸å®ƒåƒå¾€å¸¸ä¸€æ ·å“åº”æ“ä½œç³»ç»Ÿäº‹ä»¶ã€‚Qt ç°åœ¨ä¼šæ¥å—äº‹ä»¶å¹¶å¤„ç†å®ƒä»¬ï¼Œç„¶åè¿”å›è¿è¡Œæ‚¨çš„å…¶ä½™ä»£ç ã€‚

è¿™ç¡®å®æœ‰æ•ˆï¼Œä½†æœ‰å‡ ä¸ªåŸå› è®©å®ƒå˜å¾—ç³Ÿç³•ã€‚

é¦–å…ˆï¼Œå½“æ‚¨å°†æ§åˆ¶æƒäº¤è¿˜ç»™ Qt æ—¶ï¼Œæ‚¨çš„ä»£ç å°†ä¸å†è¿è¡Œã€‚è¿™æ„å‘³ç€æ‚¨è¯•å›¾æ‰§è¡Œçš„ä»»ä½•è€—æ—¶æ“ä½œéƒ½ä¼šèŠ±è´¹æ›´é•¿æ—¶é—´ã€‚è¿™å¯èƒ½ä¸æ˜¯æ‚¨æƒ³è¦çš„ç»“æœã€‚

å…¶æ¬¡ï¼Œåœ¨ä¸»äº‹ä»¶å¾ªç¯ä¹‹å¤–å¤„ç†äº‹ä»¶ä¼šå¯¼è‡´æ‚¨çš„åº”ç”¨ç¨‹åºåœ¨å¾ªç¯ä¸­åˆ†æ”¯åˆ°å¤„ç†ä»£ç ï¼ˆä¾‹å¦‚ï¼Œè§¦å‘æ§½æˆ–äº‹ä»¶ï¼‰ã€‚å¦‚æœæ‚¨çš„ä»£ç ä¾èµ–äº/å“åº”å¤–éƒ¨çŠ¶æ€ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´æœªå®šä¹‰çš„è¡Œä¸ºã€‚ä¸‹é¢çš„ä»£ç æ¼”ç¤ºäº†è¿™ç§æƒ…å†µã€‚

*Listing 172. bad_example_2.py*

```python
import sys
import time

from PyQt6.QtCore import QTimer
from PyQt6.QtWidgets import (
    QApplication,
    QLabel,
    QMainWindow,
    QPushButton,
    QVBoxLayout,
    QWidget,
)


class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        
        self.counter = 0
        
        layout = QVBoxLayout()
        
        self.l = QLabel("Start")
        b = QPushButton("DANGER!")
        b.pressed.connect(self.oh_no)
        
        c = QPushButton("?")
        c.pressed.connect(self.change_message)
        
        layout.addWidget(self.l)
        layout.addWidget(b)
        
        layout.addWidget(c)
        
        w = QWidget()
        w.setLayout(layout)
        
        self.setCentralWidget(w)
        
        self.show()
        
    def change_message(self):
        self.message = "OH NO"
        
    def oh_no(self):
        self.message = "Pressed"
        
        for _ in range(100):
            time.sleep(0.1)
            self.l.setText(self.message)
            QApplication.processEvents()
            
            
app = QApplication(sys.argv)
window = MainWindow()
app.exec()
```

å¦‚æœæ‚¨è¿è¡Œè¿™æ®µä»£ç ï¼Œæ‚¨ä¼šçœ‹åˆ°è®¡æ•°å™¨ä¸ä¹‹å‰ç›¸åŒã€‚æŒ‰ä¸‹â€œDANGER!â€æŒ‰é’®å°†å°†æ˜¾ç¤ºçš„æ–‡æœ¬æ›´æ”¹ä¸ºâ€œPressedâ€ï¼Œæ­£å¦‚åœ¨ `oh_no` å‡½æ•°çš„å…¥å£å¤„æ‰€å®šä¹‰çš„ã€‚ç„¶è€Œï¼Œå¦‚æœæ‚¨åœ¨oh_noä»åœ¨è¿è¡Œæ—¶æŒ‰ä¸‹â€œ?â€æŒ‰é’®ï¼Œæ‚¨å°†çœ‹åˆ°æ¶ˆæ¯å‘ç”Ÿå˜åŒ–ã€‚çŠ¶æ€æ­£åœ¨ä»å¾ªç¯å¤–éƒ¨è¿›è¡Œæ›´æ”¹ã€‚

è¿™æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ã€‚ç„¶è€Œï¼Œå¦‚æœæ‚¨åœ¨åº”ç”¨ç¨‹åºä¸­æœ‰å¤šä¸ªé•¿æ—¶é—´è¿è¡Œçš„è¿›ç¨‹ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½è°ƒç”¨ `QApplication.processEvents()` æ¥ä¿æŒç³»ç»Ÿè¿è¡Œï¼Œæ‚¨çš„åº”ç”¨ç¨‹åºè¡Œä¸ºå¯èƒ½ä¼šè¿…é€Ÿå˜å¾—ä¸å¯é¢„æµ‹ã€‚

### çº¿ç¨‹ä¸è¿›ç¨‹

å¦‚æœæ‚¨é€€ä¸€æ­¥æ€è€ƒï¼Œæƒ³æƒ³æ‚¨åœ¨åº”ç”¨ç¨‹åºä¸­å¸Œæœ›å‘ç”Ÿçš„äº‹æƒ…ï¼Œå®ƒå¯èƒ½å¯ä»¥æ¦‚æ‹¬ä¸ºâ€œåœ¨å…¶ä»–äº‹æƒ…å‘ç”Ÿçš„åŒæ—¶å‘ç”Ÿçš„äº‹æƒ…â€ã€‚åœ¨è®¡ç®—æœºä¸Šè¿è¡Œç‹¬ç«‹ä»»åŠ¡æœ‰ä¸¤ç§ä¸»è¦æ–¹æ³•ï¼šçº¿ç¨‹å’Œè¿›ç¨‹ã€‚

**çº¿ç¨‹**å…±äº«ç›¸åŒçš„å†…å­˜ç©ºé—´ï¼Œå› æ­¤å¯åŠ¨é€Ÿåº¦å¿«ä¸”æ¶ˆè€—çš„èµ„æºæå°‘ã€‚å…±äº«å†…å­˜ä½¿å¾—åœ¨çº¿ç¨‹ä¹‹é—´ä¼ é€’æ•°æ®å˜å¾—éå¸¸ç®€å•ï¼Œç„¶è€Œï¼Œä¸åŒçº¿ç¨‹è¯»å†™å†…å­˜å¯èƒ½ä¼šå¯¼è‡´ç«äº‰æ¡ä»¶æˆ–æ®µé”™è¯¯ã€‚ç„¶è€Œï¼ŒPython è¿˜å­˜åœ¨å¦ä¸€ä¸ªé—®é¢˜ï¼Œå³å¤šä¸ªçº¿ç¨‹å—åŒä¸€å…¨å±€è§£é‡Šå™¨é”ï¼ˆGILï¼‰çš„é™åˆ¶â€”â€”è¿™æ„å‘³ç€ä¸é‡Šæ”¾ GIL çš„ Python ä»£ç åªèƒ½åœ¨å•ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œã€‚ç„¶è€Œï¼Œå¯¹äº PyQt6 è€Œè¨€ï¼Œè¿™å¹¶éä¸»è¦é—®é¢˜ï¼Œå› ä¸ºå¤§éƒ¨åˆ†æ—¶é—´éƒ½èŠ±åœ¨ Python ä¹‹å¤–ã€‚

**è¿›ç¨‹**ä½¿ç”¨ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ï¼ˆä»¥åŠå®Œå…¨ç‹¬ç«‹çš„ Python è§£é‡Šå™¨ï¼‰ã€‚è¿™é¿å…äº†ä¸ GIL ç›¸å…³çš„æ½œåœ¨é—®é¢˜ï¼Œä½†ä»£ä»·æ˜¯å¯åŠ¨æ—¶é—´è¾ƒé•¿ã€å†…å­˜å¼€é”€è¾ƒå¤§ä»¥åŠåœ¨å‘é€/æ¥æ”¶æ•°æ®æ—¶å¤æ‚æ€§å¢åŠ ã€‚

ä¸ºäº†ç®€åŒ–èµ·è§ï¼Œé€šå¸¸ä½¿ç”¨çº¿ç¨‹æ˜¯æ˜æ™ºçš„é€‰æ‹©ã€‚Qtä¸­çš„è¿›ç¨‹æ›´é€‚åˆäºè¿è¡Œå’Œä¸å¤–éƒ¨ç¨‹åºé€šä¿¡ã€‚åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ¢è®¨åœ¨Qtå†…éƒ¨å¯ç”¨çš„é€‰é¡¹ï¼Œä»¥å°†å·¥ä½œè½¬ç§»åˆ°å•ç‹¬çš„çº¿ç¨‹å’Œè¿›ç¨‹ä¸­ã€‚

## 25. ä½¿ç”¨çº¿ç¨‹æ± 

Qt æä¾›äº†ä¸€ä¸ªéå¸¸ç®€å•çš„æ¥å£ï¼Œç”¨äºåœ¨å…¶ä»–çº¿ç¨‹ä¸­è¿è¡Œä»»åŠ¡ï¼Œè¯¥æ¥å£åœ¨ PyQt6 ä¸­å¾—åˆ°äº†å¾ˆå¥½çš„å®ç°ã€‚è¯¥æ¥å£å›´ç»•ä¸¤ä¸ªç±»æ„å»ºâ€”â€”`QRunnable` å’Œ `QThreadPool`ã€‚å‰è€…æ˜¯ç”¨äºå­˜æ”¾æ‚¨è¦æ‰§è¡Œçš„ä»»åŠ¡çš„å®¹å™¨ï¼Œè€Œåè€…åˆ™æ˜¯ç®¡ç†æ‚¨çš„å·¥ä½œçº¿ç¨‹çš„çº¿ç¨‹æ± ã€‚

ä½¿ç”¨ `QThreadPool` çš„å¥½å¤„åœ¨äºï¼Œå®ƒå¯ä»¥ä¸ºæ‚¨å¤„ç†ä»»åŠ¡çš„æ’é˜Ÿå’Œæ‰§è¡Œæ»‘å—ã€‚é™¤äº†æ’é˜Ÿä½œä¸šå’Œæ£€ç´¢ç»“æœå¤–ï¼Œå‡ ä¹æ— éœ€åšå…¶ä»–äº‹æƒ…ã€‚

### ä½¿ç”¨ `QRunnable`

è¦å®šä¹‰è‡ªå®šä¹‰ `QRunnable`ï¼Œæ‚¨å¯ä»¥ç»§æ‰¿åŸºç¡€ `QRunnable` ç±»ï¼Œç„¶åå°†å¸Œæœ›æ‰§è¡Œçš„ä»£ç æ”¾ç½®åœ¨ `run()` æ–¹æ³•ä¸­ã€‚ä»¥ä¸‹æ˜¯å°†æˆ‘ä»¬çš„é•¿æ—¶é—´ `sleep` ä»»åŠ¡å®ç°ä¸º `QRunnable` çš„ç¤ºä¾‹ã€‚å°†ä»¥ä¸‹ä»£ç æ·»åŠ åˆ° `MainWindow` ç±»å®šä¹‰ä¹‹å‰ã€‚

*Listing 173. concurrent/qrunnable_1.py*

```python
class Worker(QRunnable):
    """
    å·¥ä½œçº¿ç¨‹
    """
    @pyqtSlot()
    def run(self):
        """
        æ‚¨çš„ä»£ç åº”æ”¾ç½®åœ¨æ­¤æ–¹æ³•ä¸­
        """
        print("Thread start")
        time.sleep(5)
        print("Thread complete")
```

åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œæˆ‘ä»¬çš„å‡½æ•°ï¼Œåªéœ€åˆ›å»ºä¸€ä¸ª `Worker` çš„å®ä¾‹ï¼Œç„¶åå°†å…¶ä¼ é€’ç»™æˆ‘ä»¬çš„`QThreadPool` å®ä¾‹å³å¯ã€‚

æˆ‘ä»¬åœ¨ `__init__` å—ä¸­åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± çš„å®ä¾‹ã€‚

*Listing 174. concurrent/qrunnable_1.py*

```python
class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.threadpool = QThreadPool()
        print(
            "Multithreading with maximum %d threads"
            % self.threadpool.maxThreadCount()
        )
```

æœ€åï¼Œç”¨ä»¥ä¸‹ä»£ç æ›¿æ¢ `oh_no` æ–¹æ³•ï¼Œä»¥åˆ›å»ºå¹¶æäº¤

*Listing 175. concurrent/qrunnable_1.py*

```python
    def oh_no(self):
        worker = Worker()
        self.threadpool.start(worker)
```

ç°åœ¨ï¼Œç‚¹å‡»æŒ‰é’®å°†åˆ›å»ºä¸€ä¸ªå·¥ä½œè¿›ç¨‹æ¥å¤„ç†ï¼ˆé•¿æœŸè¿è¡Œçš„ï¼‰è¿›ç¨‹ï¼Œå¹¶é€šè¿‡ `QThreadPool` æ± å°†å…¶åˆ†æ‹†åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ä¸­ã€‚å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„çº¿ç¨‹æ¥å¤„ç†ä¼ å…¥çš„å·¥ä½œè¿›ç¨‹ï¼Œå®ƒä»¬å°†è¢«æ’å…¥é˜Ÿåˆ—ï¼Œå¹¶åœ¨ç¨åæŒ‰é¡ºåºæ‰§è¡Œã€‚

> ğŸš€ **è¿è¡Œå®ƒå§ï¼** æ‚¨ä¼šå‘ç°ï¼Œç°åœ¨åº”ç”¨ç¨‹åºå¯ä»¥å¤„ç†æ‚¨ç–¯ç‹‚ç‚¹å‡»æŒ‰é’®çš„æ“ä½œï¼Œè€Œä¸ä¼šå‡ºç°ä»»ä½•é—®é¢˜ã€‚

![Figure200](Figure200.png)

> å›¾200ï¼šç®€å•çš„ `QRunnable` ç¤ºä¾‹åº”ç”¨ç¨‹åºã€‚åªè¦å›¾å½¢ç”¨æˆ·ç•Œé¢çº¿ç¨‹æ­£åœ¨è¿è¡Œè®¡æ•°å™¨å°±ä¼šæ¯ç§’å¢åŠ  1

è¯·æ‚¨æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºï¼Œä»¥è§‚å¯Ÿå·¥ä½œè¿›ç¨‹çš„å¯åŠ¨å’Œå®Œæˆæƒ…å†µã€‚

```bash
Multithreading with maximum 12 threads
Thread start
Thread start
Thread start
Thread complete
Thread complete
Thread complete
```

æ£€æŸ¥å¤šæ¬¡ç‚¹å‡»æŒ‰é’®æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆã€‚æ‚¨åº”è¯¥çœ‹åˆ°æ‚¨çš„çº¿ç¨‹ç«‹å³æ‰§è¡Œï¼Œç›´åˆ°è¾¾åˆ° `.maxThreadCount` æŠ¥å‘Šçš„æ•°é‡ã€‚å¦‚æœåœ¨å·²ç»å­˜åœ¨æ­¤æ•°é‡çš„æ´»è·ƒå·¥ä½œè€…åå†æ¬¡ç‚¹å‡»æŒ‰é’®ï¼Œåç»­çš„å·¥ä½œè€…å°†è¢«æ’é˜Ÿï¼Œç›´åˆ°æœ‰çº¿ç¨‹å¯ç”¨ã€‚

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬è®© `QThreadPool` å†³å®šç†æƒ³çš„æ´»è·ƒçº¿ç¨‹æ•°ã€‚è¿™ä¸ªæ•°å€¼åœ¨ä¸åŒè®¡ç®—æœºä¸Šä¼šæœ‰æ‰€ä¸åŒï¼Œç›®çš„æ˜¯å®ç°æœ€ä½³æ€§èƒ½ã€‚ç„¶è€Œï¼Œæœ‰æ—¶æ‚¨å¯èƒ½éœ€è¦æŒ‡å®šç‰¹å®šçš„çº¿ç¨‹æ•°â€”â€”åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `.setMaxThreadCount` æ–¹æ³•æ˜¾å¼è®¾ç½®æ­¤å€¼ã€‚æ­¤å€¼æ˜¯é’ˆå¯¹æ¯ä¸ªçº¿ç¨‹æ± çš„ã€‚

### ä½¿ç”¨ `QThreadPool.start()`

åœ¨ä¹‹å‰çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬è‡ªå·±åˆ›å»ºäº†ä¸€ä¸ª `QRunnable` å¯¹è±¡ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™ `QThreadPool` ä»¥è¿›è¡Œæ‰§è¡Œã€‚ç„¶è€Œï¼Œå¯¹äºç®€å•çš„ç”¨ä¾‹ï¼ŒQté€šè¿‡ `QThreadPool.start()` æä¾›äº†ä¸€ä¸ªä¾¿æ·çš„æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¯ä»¥å¤„ç†æ‰§è¡Œä»»æ„çš„ Python å‡½æ•°å’Œæ–¹æ³•ã€‚Qt ä¼šä¸ºæ‚¨åˆ›å»ºå¿…è¦çš„ `QRunnable` å¯¹è±¡ï¼Œå¹¶å°†å®ƒä»¬æ’å…¥é˜Ÿåˆ—ã€‚

åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†å·¥ä½œæ”¾åœ¨äº† `do_some_work` æ–¹æ³•ä¸­ï¼Œå¹¶ä¿®æ”¹äº† `oh_no` æ–¹æ³•ï¼Œå°†å…¶ä¼ é€’ç»™çº¿ç¨‹æ± çš„ `.start()` æ–¹æ³•ã€‚

*Listing 176. concurrent/qthreadpool_start_1.py*

```python
    def oh_no(self):
        self.threadpool.start(self.do_some_work)

    @pyqtSlot()
    def do_some_work(self):
        print("Thread start")
        time.sleep(5)
        print("Thread complete")
        
    def recurring_timer(self):
        self.counter += 1
        self.l.setText("Counter: %d" % self.counter)
```

æŒ‰ä¸‹æŒ‰é’®å°†æ‰§è¡Œæˆ‘ä»¬åœ¨ `QThreadPool` ä¸Šå®šä¹‰çš„ `do_some_work` æ–¹æ³•ã€‚

![information](information.png)

> æ‚¨å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼å¯åŠ¨å¤šä¸ªçº¿ç¨‹ã€‚å°è¯•æŒ‰ä¸‹æŒ‰é’®ï¼Œç›´åˆ°è¾¾åˆ°æœ€å¤§å¹¶å‘çº¿ç¨‹æ•°ã€‚åœ¨çº¿ç¨‹æ± ä¸­æœ‰ç©ºé—²ç©ºé—´ä¹‹å‰ï¼Œä¸ä¼šå¯åŠ¨æ–°çš„çº¿ç¨‹ã€‚

å¯¹äºè®¸å¤šç®€å•çš„ä»»åŠ¡æ¥è¯´ï¼Œè¿™ç§æ–¹æ³•éå¸¸æœ‰æ•ˆã€‚åœ¨æ‰§è¡Œçš„å‡½æ•°ä¸­ï¼Œæ‚¨å¯ä»¥è®¿é—®ä¿¡å·ï¼Œå¹¶ä½¿ç”¨å®ƒä»¬æ¥å‘å‡ºæ•°æ®ã€‚æ‚¨æ— æ³•æ¥æ”¶ä¿¡å·â€”â€”æ²¡æœ‰åœ°æ–¹è¿æ¥å®ƒä»¬â€”â€”ä½†æ‚¨å¯ä»¥é€šè¿‡ `self` å¯¹è±¡ä¸å˜é‡è¿›è¡Œäº¤äº’ã€‚

æ›´æ–°ä»£ç ä»¥æ·»åŠ ä»¥ä¸‹ `custom_signal`ï¼Œå¹¶ä¿®æ”¹ `work` æ–¹æ³•ä»¥å‘å‡ºæ­¤ä¿¡å·å¹¶æ›´æ–° `self.counter` å˜é‡ã€‚

*Listing 177. concurrent/qthreadpool_start_2.py*

```python
class MainWindow(QMainWindow):
    
    custom_signal = pyqtSignal()
    
    def __init__(self):
        super().__init__()
        
        # å°†æˆ‘ä»¬çš„è‡ªå®šä¹‰ä¿¡å·è¿æ¥åˆ°å¤„ç†ç¨‹åº.
        self.custom_signal.connect(self.signal_handler)
        # etc.
    def oh_no(self):
        self.threadpool.start(self.do_some_work)
        
    @pyqtSlot()
    def do_some_work(self):
        print("Thread start")
        # å‘å‡ºæˆ‘ä»¬çš„å®šåˆ¶ä¿¡å·.
        self.custom_signal.emit()
        for n in range(5):
            time.sleep(1)
        self.counter = self.counter - 10
        print("Thread complete")
        
    def signal_handler(self):
        print("Signal received!")

    def recurring_timer(self):
        self.counter += 1
        self.l.setText("Counter: %d" % self.counter)
```

è¿è¡Œæ­¤ç¤ºä¾‹åï¼Œæ‚¨ä¼šå‘ç°ï¼Œè™½ç„¶å·¥ä½œæ–¹æ³•åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­è¿è¡Œï¼ˆç¡çœ ä¸ä¼šä¸­æ–­è®¡æ•°å™¨ï¼‰ï¼Œä½†æˆ‘ä»¬ä»ç„¶èƒ½å¤Ÿå‘å‡ºä¿¡å·å¹¶ä¿®æ”¹ `self.counter` å˜é‡ã€‚

![alert](alert.png)

> æ‚¨æ— æ³•ä»å¦ä¸€ä¸ªçº¿ç¨‹ç›´æ¥ä¿®æ”¹å›¾å½¢ç”¨æˆ·ç•Œé¢â€”â€”å°è¯•è¿™æ ·åšä¼šå¯¼è‡´åº”ç”¨ç¨‹åºå´©æºƒã€‚

![tips](tips.png)

> æ‚¨å¯ä»¥ä½¿ç”¨ä¿¡å·ä¿®æ”¹å›¾å½¢ç”¨æˆ·ç•Œé¢ã€‚ä¾‹å¦‚ï¼Œå°è¯•å°† `str` ä¿¡å·è¿æ¥åˆ°æ ‡ç­¾çš„ `.setText` æ–¹æ³•ã€‚

è™½ç„¶è¿™æ˜¯ä¸€ä¸ªæ–¹ä¾¿çš„å°ç•Œé¢ï¼Œä½†æ‚¨ç»å¸¸ä¼šå‘ç°è‡ªå·±å¸Œæœ›å¯¹æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æœ‰æ›´å¤šçš„æ§åˆ¶æƒï¼Œæˆ–è€…ä¸å®ƒä»¬è¿›è¡Œæ›´ç»“æ„åŒ–çš„é€šä¿¡ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†é€šè¿‡ä¸€äº›æ›´å¤æ‚çš„ç¤ºä¾‹ï¼Œä½¿ç”¨ `QRunnable` æ¥å±•ç¤ºä»€ä¹ˆæ˜¯å¯èƒ½çš„ã€‚

### æ‰©å±• QRunnable

å¦‚æœæ‚¨æƒ³å°†è‡ªå®šä¹‰æ•°æ®ä¼ é€’ç»™æ‰§è¡Œå‡½æ•°ï¼Œæ‚¨å¯ä»¥é…ç½®æ‚¨çš„è¿è¡Œå™¨ä»¥æ¥å—å‚æ•°æˆ–å…³é”®å­—ï¼Œç„¶åå°†è¿™äº›æ•°æ®å­˜å‚¨åœ¨ `QRunnable`çš„ `self` å¯¹è±¡ä¸­ã€‚è¿™äº›æ•°æ®éšåå¯ä»¥åœ¨ `run` æ–¹æ³•å†…éƒ¨è®¿é—®ã€‚

*Listing 178. concurrent/qrunnable_2.py*

```python
class Worker(QRunnable):
    """
    å·¥ä½œçº¿ç¨‹
    :param args: ä¼ é€’ç»™è¿è¡Œä»£ç çš„å‚æ•°
    :param kwargs: ä¼ é€’ç»™è¿è¡Œçš„å…³é”®å­—å‚æ•°
    :code
    :
    """
    def __init__(self, *args, **kwargs):
        super().__init__()
        self.args = args
        self.kwargs = kwargs
            
    @pyqtSlot()
    def run(self):
    """
    ä½¿ç”¨ä¼ é€’çš„ self.args åˆå§‹åŒ– runner å‡½æ•°ï¼Œ
    """
        print(self.args, self.kwargs)
    
    def oh_no(self):
        worker = Worker("some", "arguments", keywords=2)
        self.threadpool.start(worker)
```

![tips](tips.png)

> ç”±äºå‡½æ•°åœ¨ Python ä¸­ä¹Ÿæ˜¯å¯¹è±¡ï¼Œæ‚¨è¿˜å¯ä»¥å°†ä¸€ä¸ªå‡½æ•°ä¼ é€’ç»™è¿è¡Œå™¨ä»¥æ‰§è¡Œã€‚è¯·å‚é˜…åæ–‡çš„é€šç”¨ç¤ºä¾‹æ¥è·å–ä¸€ä¸ªç¤ºä¾‹ã€‚

### çº¿ç¨‹ I/O

æœ‰æ—¶ï¼Œèƒ½å¤Ÿä»è¿è¡Œä¸­çš„å·¥ä½œè€…è¿›ç¨‹ä¸­ä¼ é€’çŠ¶æ€å’Œæ•°æ®ä¼šéå¸¸æœ‰ç”¨ã€‚è¿™å¯èƒ½åŒ…æ‹¬è®¡ç®—ç»“æœã€æŠ›å‡ºçš„å¼‚å¸¸æˆ–æ­£åœ¨è¿›è¡Œçš„è¿›åº¦ï¼ˆä¾‹å¦‚è¿›åº¦æ¡ï¼‰ã€‚Qt æä¾›äº†ä¿¡å·å’Œæ§½æ¡†æ¶ï¼Œå…è®¸æ‚¨æ‰§è¡Œæ­¤æ“ä½œï¼Œå¹¶ä¸”æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå…è®¸ä»æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ç›´æ¥ä¸å›¾å½¢ç”¨æˆ·ç•Œé¢è¿›è¡Œå®‰å…¨é€šä¿¡ã€‚ä¿¡å·å…è®¸æ‚¨å‘å‡ºå€¼ï¼Œç„¶åè¿™äº›å€¼ç”±ä¸ `.connect` é“¾æ¥çš„æ§½å‡½æ•°åœ¨ä»£ç çš„å…¶ä»–ä½ç½®æ‹¾å–ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ `WorkerSignals` ç±»ï¼Œå®ƒåŒ…å«ä¸€äº›ç¤ºä¾‹ä¿¡å·ã€‚ä¿¡å·ã€‚

![information](information.png)

> è‡ªå®šä¹‰ä¿¡å·åªèƒ½åœ¨ä» `QObject` æ´¾ç”Ÿçš„å¯¹è±¡ä¸Šå®šä¹‰ã€‚ç”±äº `QRunnable` å¹¶éä» `QObject` æ´¾ç”Ÿï¼Œå› æ­¤æˆ‘ä»¬æ— æ³•ç›´æ¥åœ¨å…¶ä¸­å®šä¹‰ä¿¡å·ã€‚ä½¿ç”¨ä¸€ä¸ªç”¨äºä¿å­˜ä¿¡å·çš„è‡ªå®šä¹‰ `QObject` æ˜¯æœ€ç®€å•çš„è§£å†³æ–¹æ¡ˆã€‚

*Listing 179. concurrent/qrunnable_3.py*

```python
class WorkerSignals(QObject):
    """
    å®šä¹‰è¿è¡Œä¸­çš„å·¥ä½œçº¿ç¨‹å¯ç”¨çš„ä¿¡å·ã€‚
    æ”¯æŒçš„ä¿¡å·åŒ…æ‹¬ï¼š
    finished
        æ— æ•°æ®
    error
        `str` å¼‚å¸¸å­—ç¬¦ä¸²
    result
        `dict` å¤„ç†è¿”å›çš„æ•°æ®
    """
    finished = pyqtSignal()
    error = pyqtSignal(str)
    result = pyqtSignal(dict)
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº† 3 ä¸ªè‡ªå®šä¹‰ä¿¡å·ï¼š

1. **å®Œæˆä¿¡å·**ï¼Œæ²¡æœ‰æ•°æ®è¡¨æ˜ä»»åŠ¡ä½•æ—¶å®Œæˆ
2. **é”™è¯¯ä¿¡å·**ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªç”±å¼‚å¸¸ç±»å‹ã€å¼‚å¸¸å€¼å’Œæ ¼å¼åŒ–è·Ÿè¸ªä¿¡æ¯ç»„æˆçš„å…ƒç»„ã€‚
3. **ç»“æœä¿¡å·**ï¼Œæ¥æ”¶æ‰§è¡Œå‡½æ•°çš„ä»»ä½•å¯¹è±¡ç±»å‹

æ‚¨å¯èƒ½å¹¶ä¸éœ€è¦æ‰€æœ‰è¿™äº›ä¿¡å·ï¼Œä½†å®ƒä»¬è¢«åŒ…æ‹¬è¿›æ¥æ˜¯ä¸ºäº†è¡¨æ˜å…¶å¯èƒ½æ€§ã€‚åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨è¿™äº›ä¿¡å·æ¥é€šçŸ¥ä¸€ä¸ªç®€å•çš„è®¡ç®—å·¥ä½œè¿›ç¨‹çš„å®Œæˆå’Œé”™è¯¯ã€‚

*Listing 180. concurrent/qrunnable_3.py*

```python
import random
import sys
import time

from PyQt6.QtCore import (
    QObject,
    QRunnable,
    QThreadPool,
    QTimer,
    pyqtSignal,
    pyqtSlot,
)
from PyQt6.QtWidgets import (
    QApplication,
    QLabel,
    QMainWindow,
    QPushButton,
    QVBoxLayout,
    QWidget,
)


class WorkerSignals(QObject):
    """
    å®šä¹‰è¿è¡Œä¸­çš„å·¥ä½œçº¿ç¨‹å¯ç”¨çš„ä¿¡å·ã€‚
    æ”¯æŒçš„ä¿¡å·åŒ…æ‹¬ï¼š
    finished
        æ— æ•°æ®
    error
        `str` å¼‚å¸¸å­—ç¬¦ä¸²
    result
        `dict` å¤„ç†è¿”å›çš„æ•°æ®
    """
    finished = pyqtSignal()
    error = pyqtSignal(str)
    result = pyqtSignal(dict)
    
    
class Worker(QRunnable):
    """
    å·¥ä½œçº¿ç¨‹
    :param args: ä¼ é€’ç»™è¿è¡Œä»£ç çš„å‚æ•°
    :param kwargs: ä¼ é€’ç»™è¿è¡Œçš„å…³é”®å­—å‚æ•°
    :code
    :
    """
    def __init__(self, iterations=5):
        super().__init__()
        self.signals = (
            WorkerSignals()
        ) # åˆ›å»ºä¿¡å·ç±»çš„å®ä¾‹.
        self.iterations = iterations
            
    @pyqtSlot()
    def run(self):
    """
    ä½¿ç”¨ä¼ é€’çš„ self.args åˆå§‹åŒ– runner å‡½æ•°ï¼Œ
    """
        try:
            for n in range(self.iterations):
                time.sleep(0.01)
                v = 5 / (40 - n)
                
        except Exception as e:
            self.signals.error.emit(str(e))
            
        else:
            self.signals.finished.emit()
            self.signals.result.emit({"n": n, "value": v})
            
            
class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        
        self.threadpool = QThreadPool()
        print(
            "Multithreading with maximum %d threads"
            % self.threadpool.maxThreadCount()
        )
        
        self.counter = 0
        
        layout = QVBoxLayout()
        
        self.l = QLabel("Start")
        b = QPushButton("DANGER!")
        b.pressed.connect(self.oh_no)
        
        layout.addWidget(self.l)
        layout.addWidget(b)
        
        w = QWidget()
        w.setLayout(layout)
        
        self.setCentralWidget(w)
        
        self.show()
        
        self.timer = QTimer()
        self.timer.setInterval(1000)
        self.timer.timeout.connect(self.recurring_timer)
        self.timer.start()
        
    def oh_no(self):
        worker = Worker(iterations=random.randint(10, 50))
        worker.signals.result.connect(self.worker_output)
        worker.signals.finished.connect(self.worker_complete)
        worker.signals.error.connect(self.worker_error)
        self.threadpool.start(worker)
        
        
    def worker_output(self, s):
        print("RESULT", s)
        
    def worker_complete(self):
        print("THREAD COMPLETE!")
        
    def worker_error(self, t):
        print("ERROR: %s" % t)
        
    def recurring_timer(self):
        self.counter += 1
        self.l.setText("Counter: %d" % self.counter)
        
    
app = QApplication(sys.argv)
window = MainWindow()
app.exec()
```

æ‚¨å¯ä»¥å°†è‡ªå·±çš„å¤„ç†å‡½æ•°è¿æ¥åˆ°è¿™äº›ä¿¡å·ï¼Œä»¥æ¥æ”¶çº¿ç¨‹å®Œæˆï¼ˆæˆ–ç»“æœï¼‰çš„é€šçŸ¥ã€‚\è¯¥ç¤ºä¾‹æ—¨åœ¨å¶å°”æŠ›å‡ºé™¤ä»¥é›¶å¼‚å¸¸ï¼Œæ‚¨å°†åœ¨è¾“å‡ºä¸­çœ‹åˆ°è¯¥å¼‚å¸¸ã€‚

```bash
Multithreading with maximum 12 threads
THREAD COMPLETE!
RESULT {'n': 16, 'value': 0.20833333333333334}
ERROR: division by zero
THREAD COMPLETE!
RESULT {'n': 11, 'value': 0.1724137931034483}
THREAD COMPLETE!
RESULT {'n': 22, 'value': 0.2777777777777778}
ERROR: division by zero
```

åœ¨ä¸‹ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†æ¢è®¨è¿™ç§æ–¹æ³•çš„å‡ ç§ä¸åŒå˜ä½“ï¼Œè¿™äº›å˜ä½“ä½¿æ‚¨èƒ½å¤Ÿåœ¨è‡ªå·±çš„åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ `QThreadPool` å®ç°ä¸€äº›æœ‰è¶£çš„åŠŸèƒ½ã€‚

## 26. QRunnable ç¤ºä¾‹

`QThreadPool` å’Œ `QRunnable` æ˜¯ä»¥å…¶ä»–çº¿ç¨‹è¿è¡Œç¨‹åºçš„ä¸€ç§éå¸¸çµæ´»çš„æ–¹å¼ã€‚é€šè¿‡è°ƒæ•´ä¿¡å·å’Œå‚æ•°ï¼Œæ‚¨å¯ä»¥æ‰§è¡Œä»»ä½•å¯ä»¥æƒ³è±¡åˆ°çš„ä»»åŠ¡ã€‚åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç»ä¸€äº›ç¤ºä¾‹ï¼Œè¯´æ˜å¦‚ä½•ä¸ºç‰¹å®šåœºæ™¯æ„å»ºè¿è¡Œå™¨ã€‚

æ‰€æœ‰ç¤ºä¾‹éƒ½éµå¾ªç›¸åŒçš„æ€»ä½“æ¨¡å¼â€”â€”ä¸€ä¸ªè‡ªå®šä¹‰çš„ `QRunnable` ç±»ï¼Œå¸¦æœ‰è‡ªå®šä¹‰çš„ `WorkerSignals`ã€‚åŒºåˆ«åœ¨äºæˆ‘ä»¬ä¼ é€’ç»™è¿è¡Œå™¨çš„å‚æ•°ã€è¿è¡Œå™¨å¯¹è¿™äº›å‚æ•°çš„å¤„ç†æ–¹å¼ï¼Œä»¥åŠæˆ‘ä»¬å¦‚ä½•è¿æ¥ä¿¡å·ã€‚

*Listing 181. concurrent/qrunnable_base.py*

```python
import sys
import time
import traceback

from PyQt6.QtCore import (
    QObject,
    QRunnable,
    QThreadPool,
    pyqtSignal,
    pyqtSlot,
)
from PyQt6.QtWidgets import QApplication, QMainWindow


class WorkerSignals(QObject):
    pass


class Worker(QRunnable):
    def __init__(self, *args, **kwargs):
        super().__init__()
        # å­˜å‚¨æ„é€ å‡½æ•°å‚æ•°ï¼ˆç”¨äºåç»­å¤„ç†ï¼‰
        self.args = args
        self.kwargs = kwargs
        self.signals = WorkerSignals()
       
    @pyqtSlot()
    def run(self):
        pass
    
    
class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.show()
        
        
app = QApplication(sys.argv)
window = MainWindow()
app.exec()
```

### è¿›åº¦è§‚å¯Ÿå™¨

å¦‚æœæ‚¨æ­£åœ¨ä½¿ç”¨çº¿ç¨‹æ¥æ‰§è¡Œè€—æ—¶è¾ƒé•¿çš„æ“ä½œï¼Œæ‚¨åº”è¯¥è®©ç”¨æˆ·äº†è§£ä»»åŠ¡çš„è¿›å±•æƒ…å†µã€‚ä¸€ç§å¸¸è§çš„åšæ³•æ˜¯é€šè¿‡æ˜¾ç¤ºä¸€ä¸ªè¿›åº¦æ¡æ¥å®ç°ï¼Œè¯¥è¿›åº¦æ¡ä¼šä»¥ä»å·¦åˆ°å³å¡«å……çš„æ–¹å¼ï¼Œæ˜¾ç¤ºä»»åŠ¡å®Œæˆçš„è¿›åº¦ã€‚ä¸ºäº†åœ¨ä»»åŠ¡ä¸­æ˜¾ç¤ºè¿›åº¦æ¡ï¼Œæ‚¨éœ€è¦ä» `worker` ä¸­å‘å‡ºå½“å‰çš„è¿›åº¦çŠ¶æ€ã€‚

ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ `WorkerSignals` å¯¹è±¡ä¸Šå®šä¹‰å¦ä¸€ä¸ªåä¸º `progress` çš„ä¿¡å·ã€‚è¯¥ä¿¡å·åœ¨æ¯ä¸ªå¾ªç¯ä¸­å‘å‡º 0..100 ä¹‹é—´çš„æ•°å­—ï¼Œä»¥è¡¨ç¤ºâ€œä»»åŠ¡â€çš„è¿›å±•ã€‚è¯¥è¿›åº¦ä¿¡å·çš„è¾“å‡ºè¿æ¥åˆ°ä¸»çª—å£çŠ¶æ€æ ä¸Šæ˜¾ç¤ºçš„æ ‡å‡† `QProgressBar`ã€‚

*Listing 182. concurrent/qrunnable_progress.py*

```python
import sys
import time

from PyQt6.QtCore import (
    QObject,
    QRunnable,
    QThreadPool,
    QTimer,
    pyqtSignal,
    pyqtSlot,
)
from PyQt6.QtWidgets import (
    QApplication,
    QLabel,
    QMainWindow,
    QProgressBar,
    QPushButton,
    QVBoxLayout,
    QWidget,
)


class WorkerSignals(QObject):
    """
    å®šä¹‰è¿è¡Œä¸­çš„å·¥ä½œçº¿ç¨‹å¯ç”¨çš„ä¿¡å·
    progress
        int è¿›åº¦å®Œæˆåº¦ï¼ŒèŒƒå›´ä¸º0åˆ°100
    """
    progress = pyqtSignal(int)
    
    
class Worker(QRunnable):
    """
    å·¥ä½œçº¿ç¨‹
    ä» QRunnable ç»§æ‰¿ï¼Œç”¨äºå¤„ç†å·¥ä½œçº¿ç¨‹çš„è®¾ç½®ã€ä¿¡å·å’Œæ”¶å°¾å·¥ä½œã€‚
    """
    def __init__(self):
        super().__init__()
        
        self.signals = WorkerSignals()
        
    @pyqtSlot()
    def run(self):
        total_n = 1000
        for n in range(total_n):
            progress_pc = int(
                100 * float(n + 1) / total_n
            ) # è¿›åº¦ 0-100% ,ä½œä¸ºæ•´æ•°
            self.signals.progress.emit(progress_pc)
            time.sleep(0.01)
            
            
class MainWindow(QMainWindow):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        
        layout = QVBoxLayout()
        
        self.progress = QProgressBar()
        
        button = QPushButton("START IT UP")
        button.pressed.connect(self.execute)
        layout.addWidget(self.progress)
        layout.addWidget(button)
        
        w = QWidget()
        w.setLayout(layout)
        
        self.setCentralWidget(w)
        
        self.show()
        
        self.threadpool = QThreadPool()
        print(
            "Multithreading with maximum %d threads"
            % self.threadpool.maxThreadCount()
        )
        
    def execute(self):
        worker = Worker()
        worker.signals.progress.connect(self.update_progress)
        # æ‰§è¡Œ
        self.threadpool.start(worker)
        
    def update_progress(self, progress):
        self.progress.setValue(progress)
        
        
app = QApplication(sys.argv)
window = MainWindow()
app.exec()
```

![Figure201](Figure201.png)

> å›¾201ï¼šè¿›åº¦æ¡æ˜¾ç¤ºé•¿æœŸè¿è¡Œçš„ä»»åŠ¡çš„å½“å‰è¿›åº¦

å¦‚æœæ‚¨åœ¨å¦ä¸€ä¸ªè¿›ç¨‹å·²ç»è¿è¡Œçš„æƒ…å†µä¸‹æŒ‰ä¸‹æŒ‰é’®ï¼Œæ‚¨ä¼šå‘ç°ä¸€ä¸ªé—®é¢˜â€”â€”ä¸¤ä¸ªè¿›ç¨‹ä¼šå°†å®ƒä»¬çš„è¿›åº¦å‘é€åˆ°åŒä¸€ä¸ªè¿›åº¦æ¡ï¼Œå› æ­¤æ•°å€¼ä¼šæ¥å›è·³åŠ¨ã€‚

ä½¿ç”¨å•ä¸ªè¿›åº¦æ¡è·Ÿè¸ªå¤šä¸ªå·¥ä½œè€…æ˜¯å¯è¡Œçš„â€”â€”æˆ‘ä»¬åªéœ€è¦åšä¸¤ä»¶äº‹ï¼šä¸€ä¸ªç”¨äºå­˜å‚¨æ¯ä¸ªå·¥ä½œè€…è¿›åº¦å€¼çš„å­˜å‚¨ä½ç½®ï¼Œä»¥åŠä¸€ä¸ªæ¯ä¸ªå·¥ä½œè€…çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚åœ¨æ¯æ¬¡è¿›åº¦æ›´æ–°æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—æ‰€æœ‰å·¥ä½œè€…çš„å¹³å‡è¿›åº¦ï¼Œå¹¶æ˜¾ç¤ºè¯¥å€¼ã€‚

*Listing 183. concurrent/qrunnable_progress_many.py*

```python
import random
import sys
import time
import uuid

from PyQt6.QtCore import (
    QObject,
    QRunnable,
    QThreadPool,
    QTimer,
    pyqtSignal,
    pyqtSlot,
)
from PyQt6.QtWidgets import (
    QApplication,
    QLabel,
    QMainWindow,
    QProgressBar,
    QPushButton,
    QVBoxLayout,
    QWidget,
)


class WorkerSignals(QObject):
    """
    å®šä¹‰è¿è¡Œä¸­çš„å·¥ä½œçº¿ç¨‹å¯ç”¨çš„ä¿¡å·
    progress
        int è¿›åº¦å®Œæˆåº¦ï¼ŒèŒƒå›´ä¸º0åˆ°100
    """
    progress = pyqtSignal(str, int)
    finished = pyqtSignal(str)
    
    
class Worker(QRunnable):
    """
    å·¥ä½œçº¿ç¨‹
    ä» QRunnable ç»§æ‰¿ï¼Œç”¨äºå¤„ç†å·¥ä½œçº¿ç¨‹çš„è®¾ç½®ã€ä¿¡å·å’Œæ”¶å°¾å·¥ä½œã€‚
    """
    def __init__(self):
        super().__init__()
        self.job_id = uuid.uuid4().hex #1
        self.signals = WorkerSignals()
        
    @pyqtSlot()
    def run(self):
        total_n = 1000
        delay = random.random() / 100 # éšæœºå»¶è¿Ÿå€¼.
        for n in range(total_n):
            progress_pc = int(100 * float(n + 1) / total_n) #2
            self.signals.progress.emit(self.job_id, progress_pc)
            time.sleep(delay)
        
        self.signals.finished.emit(self.job_id)
        
        
class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        
        layout = QVBoxLayout()
        
        self.progress = QProgressBar()
        
        button = QPushButton("START IT UP")
        button.pressed.connect(self.execute)
        
        self.status = QLabel("0 workers")
        
        layout.addWidget(self.progress)
        layout.addWidget(button)
        layout.addWidget(self.status)
        
        w = QWidget()
        w.setLayout(layout)
        
        # å­—å…¸è®°å½•äº†å½“å‰å·¥ä½œå™¨çš„å·¥ä½œè¿›åº¦ã€‚.
        self.worker_progress = {}
        
        self.setCentralWidget(w)
        
        self.show()
        
        self.threadpool = QThreadPool()
        print(
            "Multithreading with maximum %d threads"
            % self.threadpool.maxThreadCount()
        )
        
        self.timer = QTimer()
        self.timer.setInterval(100)
        self.timer.timeout.connect(self.refresh_progress)
        self.timer.start()
        
    def execute(self):
        worker = Worker()
        worker.signals.progress.connect(self.update_progress)
        worker.signals.finished.connect(self.cleanup) #3
        
        # æ‰§è¡Œ
        self.threadpool.start(worker)
        
    def cleanup(self, job_id):
        if job_id in self.worker_progress:
            del self.worker_progress[job_id] #4
            
            # å¦‚æœæˆ‘ä»¬ç§»é™¤äº†æŸä¸ªå€¼ï¼Œè¯·æ›´æ–°è¿›åº¦æ¡
            self.refresh_progress()
            
    def update_progress(self, job_id, progress):
        self.worker_progress[job_id] = progress
        
    def calculate_progress(self):
        if not self.worker_progress:
            return 0
        
        return sum(v for v in self.worker_progress.values()) / len(
            self.worker_progress
        )
        
    def refresh_progress(self):
        # è®¡ç®—æ€»è¿›åº¦.
        progress = self.calculate_progress()
        print(self.worker_progress)
        self.progress.setValue(progress)
        self.status.setText("%d workers" % len(self.worker_progress))
        
        
app = QApplication(sys.argv)
window = MainWindow()
app.exec()
```

> 1. ä¸ºè¯¥ä»»åŠ¡æ‰§è¡Œå™¨ä½¿ç”¨ä¸€ä¸ªå”¯ä¸€çš„UUID4æ ‡è¯†ç¬¦ã€‚
> 2. è¿›åº¦ä»¥0-100%çš„æ•´æ•°å½¢å¼è¡¨ç¤ºã€‚
> 3. å½“ä»»åŠ¡å®Œæˆåï¼Œéœ€è¦æ¸…ç†ï¼ˆåˆ é™¤ï¼‰ä»»åŠ¡æ‰§è¡Œå™¨çš„è¿›åº¦æ•°æ®ã€‚
> 4. åˆ é™¤å·²å®Œæˆä»»åŠ¡æ‰§è¡Œå™¨çš„è¿›åº¦æ•°æ®ã€‚

è¿è¡Œæ­¤ä»£ç åï¼Œæ‚¨å°†çœ‹åˆ°å…¨å±€è¿›åº¦æ¡ä»¥åŠä¸€ä¸ªæŒ‡ç¤ºå™¨ï¼Œç”¨äºæ˜¾ç¤ºå½“å‰æ­£åœ¨è¿è¡Œçš„æ´»è·ƒå·¥ä½œè€…æ•°é‡ã€‚

![Figure202](Figure202.png)

> å›¾202ï¼šæ˜¾ç¤ºå…¨å±€è¿›åº¦çŠ¶æ€çš„çª—å£ï¼Œä»¥åŠæ´»è·ƒå·¥ä½œè€…çš„æ•°é‡ã€‚

é€šè¿‡æŸ¥çœ‹è„šæœ¬çš„æ§åˆ¶å°è¾“å‡ºï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹æ¯ä¸ªç‹¬ç«‹å·¥ä½œèŠ‚ç‚¹çš„å®é™…çŠ¶æ€ã€‚

![Figure203](Figure203.png)

> å›¾203ï¼šæŸ¥çœ‹ shell è¾“å‡ºä»¥æŸ¥çœ‹æ¯ä¸ªå·¥ä½œè¿›ç¨‹çš„è¿›åº¦ã€‚

ç«‹å³ç§»é™¤å·¥ä½œè€…æ„å‘³ç€è¿›åº¦ä¼šå€’é€€ã€‚å½“ä»»åŠ¡å®Œæˆæ—¶ï¼Œä»å¹³å‡å€¼è®¡ç®—ä¸­ç§»é™¤100ä¼šå¯¼è‡´å¹³å‡å€¼ä¸‹é™ã€‚æ‚¨å¯ä»¥æ¨è¿Ÿæ¸…ç†æ“ä½œï¼Œä¾‹å¦‚ä»¥ä¸‹ä»£ç ä»…åœ¨æ‰€æœ‰è¿›åº¦æ¡è¾¾åˆ°100%æ—¶ç§»é™¤æ¡ç›®ï¼š

*Listing 184. concurrent/qrunnable_progress_many_2.py*

```python
import random
import sys
import time
import uuid

from PyQt6.QtCore import (
    QObject,
    QRunnable,
    QThreadPool,
    QTimer,
    pyqtSignal,
    pyqtSlot,
)
from PyQt6.QtWidgets import (
    QApplication,
    QLabel,
    QMainWindow,
    QProgressBar,
    QPushButton,
    QVBoxLayout,
    QWidget,
)


class WorkerSignals(QObject):
    """
    å®šä¹‰è¿è¡Œä¸­çš„å·¥ä½œçº¿ç¨‹å¯ç”¨çš„ä¿¡å·
    progress
        int è¿›åº¦å®Œæˆåº¦ï¼ŒèŒƒå›´ä¸º0åˆ°100
    """
    progress = pyqtSignal(str, int)
    finished = pyqtSignal(str)
    
    
class Worker(QRunnable):
    """
    å·¥ä½œçº¿ç¨‹
    ä» QRunnable ç»§æ‰¿ï¼Œç”¨äºå¤„ç†å·¥ä½œçº¿ç¨‹çš„è®¾ç½®ã€ä¿¡å·å’Œæ”¶å°¾å·¥ä½œã€‚
    """
    def __init__(self):
        super().__init__()
        self.job_id = uuid.uuid4().hex #1
        self.signals = WorkerSignals()
        
    @pyqtSlot()
    def run(self):
        total_n = 1000
        delay = random.random() / 100 # éšæœºå»¶è¿Ÿå€¼.
        for n in range(total_n):
            progress_pc = int(100 * float(n + 1) / total_n) #2
            self.signals.progress.emit(self.job_id, progress_pc)
            time.sleep(delay)
        
        self.signals.finished.emit(self.job_id)
        
        
class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        
        layout = QVBoxLayout()
        
        self.progress = QProgressBar()
        
        button = QPushButton("START IT UP")
        button.pressed.connect(self.execute)
        
        self.status = QLabel("0 workers")
        
        layout.addWidget(self.progress)
        layout.addWidget(button)
        layout.addWidget(self.status)
        
        w = QWidget()
        w.setLayout(layout)
        
        # å­—å…¸è®°å½•äº†å½“å‰å·¥ä½œå™¨çš„å·¥ä½œè¿›åº¦ã€‚.
        self.worker_progress = {}
        
        self.setCentralWidget(w)
        
        self.show()
        
        self.threadpool = QThreadPool()
        print(
            "Multithreading with maximum %d threads"
            % self.threadpool.maxThreadCount()
        )
        
        self.timer = QTimer()
        self.timer.setInterval(100)
        self.timer.timeout.connect(self.refresh_progress)
        self.timer.start()
        
    def execute(self):
        worker = Worker()
        worker.signals.progress.connect(self.update_progress)
        worker.signals.finished.connect(self.cleanup) #3
        
        # æ‰§è¡Œ
        self.threadpool.start(worker)
        
    def cleanup(self, job_id):
        if all(v == 100 for v in self.worker_progress.values()):
            self.worker_progress.clear() # æ¸…ç©ºå­—å…¸
            
            # å¦‚æœæˆ‘ä»¬ç§»é™¤äº†æŸä¸ªå€¼ï¼Œè¯·æ›´æ–°è¿›åº¦æ¡
            self.refresh_progress()
            
    def update_progress(self, job_id, progress):
        self.worker_progress[job_id] = progress
        
    def calculate_progress(self):
        if not self.worker_progress:
            return 0
        
        return sum(v for v in self.worker_progress.values()) / len(
            self.worker_progress
        )
        
    def refresh_progress(self):
        # è®¡ç®—æ€»è¿›åº¦.
        progress = self.calculate_progress()
        print(self.worker_progress)
        self.progress.setValue(progress)
        self.status.setText("%d workers" % len(self.worker_progress))
        
        
app = QApplication(sys.argv)
window = MainWindow()
app.exec()
```

è™½ç„¶è¿™å¯ä»¥æ­£å¸¸å·¥ä½œï¼Œå¯¹äºç®€å•çš„ç”¨ä¾‹æ¥è¯´ä¹Ÿæ²¡é—®é¢˜ï¼Œä½†å¦‚æœè¿™ä¸ªå·¥ä½œçŠ¶æ€ï¼ˆå’Œæ§åˆ¶ï¼‰èƒ½å¤Ÿè¢«å°è£…åˆ°å®ƒè‡ªå·±çš„ç®¡ç†å™¨ç»„ä»¶ä¸­ï¼Œè€Œä¸æ˜¯é€šè¿‡ä¸»çª—å£æ¥æ§åˆ¶ï¼Œé‚£å°±æ›´å¥½äº†ã€‚è¯·å‚é˜…åé¢çš„â€œç®¡ç†å™¨â€éƒ¨åˆ†ï¼Œäº†è§£å¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹ã€‚

### è®¡ç®—å™¨

å½“æ‚¨éœ€è¦æ‰§è¡Œå¤æ‚çš„è®¡ç®—æ—¶ï¼Œå¤šçº¿ç¨‹æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯ Python numpyã€scipy æˆ– pandas åº“ï¼Œé‚£ä¹ˆè¿™äº›è®¡ç®—ä¹Ÿå¯èƒ½é‡Šæ”¾ Python å…¨å±€è§£é‡Šå™¨é” (GIL)ï¼Œè¿™æ„å‘³ç€æ‚¨çš„å›¾å½¢ç”¨æˆ·ç•Œé¢å’Œè®¡ç®—çº¿ç¨‹éƒ½å¯ä»¥å…¨é€Ÿè¿è¡Œã€‚

åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€äº›æ‰§è¡Œä¸€äº›ç®€å•è®¡ç®—çš„ä½œä¸šã€‚è¿™äº›è®¡ç®—çš„ç»“æœå°†è¿”å›å›¾å½¢ç”¨æˆ·ç•Œé¢çº¿ç¨‹ï¼Œå¹¶åœ¨å›¾è¡¨ä¸­æ˜¾ç¤ºã€‚

![information](information.png)

> æˆ‘ä»¬åœ¨åæ–‡çš„ ä½¿ç”¨PyQtGraphè¿›è¡Œç»˜å›¾ ä¸­å¯¹ PyQtGraph è¿›è¡Œè¯¦ç»†ä»‹ç»ï¼Œç›®å‰ä»…éœ€å…³æ³¨`QRunnable`ã€‚

*Listing 185. concurrent/qrunnable_calculator.py*

```python
import random
import sys
import time
import uuid

from PyQt6.QtCore import (
    QObject,
    QRunnable,
    QThreadPool,
    QTimer,
    pyqtSignal,
    pyqtSlot,
)
from PyQt6.QtWidgets import (
    QApplication,
    QMainWindow,
    QPushButton,
    QVBoxLayout,
    QWidget,
)
import pyqtgraph as pg


class WorkerSignals(QObject):
    """
    å®šä¹‰è¿è¡Œä¸­çš„å·¥ä½œçº¿ç¨‹å¯ç”¨çš„ä¿¡å·
    
    data
        å…ƒç»„æ•°æ®ç‚¹ (worker_id, x, y)
    """
    data = pyqtSignal(tuple) #1
    
    
class Worker(QRunnable):
    """
    å·¥ä½œçº¿ç¨‹
    ä» QRunnable ç»§æ‰¿ï¼Œç”¨äºå¤„ç†å·¥ä½œçº¿ç¨‹çš„è®¾ç½®ã€ä¿¡å·å’Œæ”¶å°¾å·¥ä½œã€‚
    """
    def __init__(self):
        super().__init__()
        self.worker_id = uuid.uuid4().hex # æ­¤é¡¹å·¥ä½œçš„å”¯ä¸€æ ‡è¯†ç¬¦
        self.signals = WorkerSignals()
        
    @pyqtSlot()
    def run(self):
        
        total_n = 1000
        y2 = random.randint(0, 10)
        delay = random.random() / 100 # éšæœºå»¶è¿Ÿå€¼.
        value = 0
        
        for n in range(total_n):
            # å‡è®¾è®¡ç®—ï¼Œæ¯ä¸ªå·¥ä½œå°†ç”Ÿäº§ä¸åŒçš„ç»“æœå€¼ã€‚
            # ç”±äºyå’Œy2çš„éšæœºå€¼.
            y = random.randint(0, 10)
            value += n * y2 - n * y
            
            self.signals.data.emit((self.worker_id, n, value)) #2
            time.sleep(delay)
            
            
class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        
        self.threadpool = QThreadPool()
        
        self.x = {} # ä¿æŒæ—¶é—´ç‚¹.
        self.y = {} # ä¿ç•™æ•°æ®.
        self.lines = {} # ä¿ç•™ç»˜åˆ¶çº¿çš„å¼•ç”¨ï¼Œä»¥ä¾¿æ›´æ–°.
        
        layout = QVBoxLayout()
        self.graphWidget = pg.PlotWidget()
        self.graphWidget.setBackground("w")
        layout.addWidget(self.graphWidget)
        
        button = QPushButton("Create New Worker")
        button.pressed.connect(self.execute)
        
        # layout.addWidget(self.progress)
        layout.addWidget(button)
        
        w = QWidget()
        w.setLayout(layout)
        
        self.setCentralWidget(w)
        
        self.show()
        
    def execute(self):
        worker = Worker()
        worker.signals.data.connect(self.receive_data)
        
        # æ‰§è¡Œ
        self.threadpool.start(worker)
        
    def receive_data(self, data):
        worker_id, x, y = data #3
        
        if worker_id not in self.lines:
            self.x[worker_id] = [x]
            self.y[worker_id] = [y]
            # ç”Ÿæˆä¸€ä¸ªéšæœºé¢œè‰².
            pen = pg.mkPen(
                width=2,
                color=(
                    random.randint(100, 255),
                    random.randint(100, 255),
                    random.randint(100, 255),
                ),
            )
            self.lines[worker_id] = self.graphWidget.plot(
                self.x[worker_id], self.y[worker_id], pen=pen
            )
            return
        
        # æ›´æ–°ç°æœ‰å›¾ä¾‹/æ•°æ®
        self.x[worker_id].append(x)
        self.y[worker_id].append(y)
        
        self.lines[worker_id].setData(
            self.x[worker_id], self.y[worker_id]
        )
        
        
app = QApplication(sys.argv)
window = MainWindow()
app.exec()
```

> 1. è®¾ç½®è‡ªå®šä¹‰ä¿¡å·ä»¥ä¼ é€’æ•°æ®ã€‚ä½¿ç”¨å…ƒç»„å¯ä»¥å‘é€ä»»ä½•æ•°é‡çš„å€¼ï¼Œè¿™äº›å€¼è¢«åŒ…è£…åœ¨å…ƒç»„ä¸­ã€‚
> 2. è¿™é‡Œï¼Œæˆ‘ä»¬å‘å‡º worker_idã€x å’Œ y å€¼ã€‚
> 3. æ¥æ”¶å™¨æ§½è§£åŒ…æ•°æ®ã€‚

ä¸€æ—¦æ‚¨ä»å·¥ä½œå¤„è·å–äº†æ•°æ®ï¼Œæ‚¨å¯ä»¥éšå¿ƒæ‰€æ¬²åœ°å¤„ç†å®ƒâ€”â€”ä¾‹å¦‚å°†å…¶æ·»åŠ åˆ°è¡¨æ ¼æˆ–æ¨¡å‹è§†å›¾ä¸­ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æ­£åœ¨å°† x å’Œ y å€¼å­˜å‚¨åœ¨ä»¥ `worker_id` ä¸ºé”®çš„å­—å…¸å¯¹è±¡ä¸­ã€‚è¿™æ ·å¯ä»¥å°†æ¯ä¸ªå·¥ä½œçš„æ•°æ®ä¿æŒç‹¬ç«‹ï¼Œå¹¶å…è®¸æˆ‘ä»¬å•ç‹¬ç»˜åˆ¶å®ƒä»¬ã€‚

å¦‚æœæ‚¨è¿è¡Œè¿™ä¸ªç¤ºä¾‹å¹¶æŒ‰ä¸‹æŒ‰é’®ï¼Œæ‚¨ä¼šåœ¨å›¾è¡¨ä¸Šçœ‹åˆ°ä¸€æ¡çº¿å‡ºç°å¹¶é€æ¸å»¶é•¿ã€‚å¦‚æœæ‚¨å†æ¬¡æŒ‰ä¸‹æŒ‰é’®ï¼Œå¦ä¸€ä¸ªå·¥ä½œå°†å¼€å§‹è¿è¡Œï¼Œè¿”å›æ›´å¤šæ•°æ®å¹¶åœ¨å›¾è¡¨ä¸Šæ·»åŠ å¦ä¸€æ¡çº¿ã€‚æ¯ä¸ªå·¥ä½œä»¥ä¸åŒçš„é€Ÿç‡ç”Ÿæˆæ•°æ®ï¼Œæ¯ä¸ªå·¥ä½œç”Ÿæˆ100ä¸ªå€¼ã€‚

![Figure204](Figure204.png)

> å›¾204ï¼šåœ¨ç»è¿‡å‡ æ¬¡è¿­ä»£åï¼Œä»å•ä¸ªè¿è¡Œå™¨ä¸­è¾“å‡ºç»“æœå›¾ã€‚

æ‚¨å¯ä»¥å¯åŠ¨æ–°ä»»åŠ¡ï¼Œæ•°é‡æœ€å¤šå¯è¾¾æœºå™¨ä¸Šå¯ç”¨çš„æœ€å¤§çº¿ç¨‹æ•°ã€‚ç”Ÿæˆ100ä¸ªå€¼åï¼Œä»»åŠ¡å°†å…³é—­ï¼Œæ¥ä¸‹æ¥æ’é˜Ÿçš„ä»»åŠ¡å°†å¯åŠ¨å¹¶å°†å…¶å€¼ä½œä¸ºæ–°è¡Œæ·»åŠ ã€‚

![Figure205](Figure205.png)

> å›¾205ï¼šæ¥è‡ªå¤šä¸ªè¿è¡Œå™¨çš„æ•°æ®

å½“ç„¶ï¼Œå…ƒç»„æ˜¯å¯é€‰çš„ï¼Œå¦‚æœæ‚¨åªæœ‰ä¸€ä¸ªè¿è¡Œå™¨ï¼Œæˆ–è€…ä¸éœ€è¦å°†è¾“å‡ºä¸æºå…³è”ï¼Œæ‚¨å¯ä»¥è¿”å›è£¸å­—ç¬¦ä¸²ã€‚é€šè¿‡é€‚å½“è®¾ç½®ä¿¡å·ï¼Œæ‚¨è¿˜å¯ä»¥å‘é€å­—èŠ‚å­—ç¬¦ä¸²æˆ–ä»»ä½•å…¶ä»–ç±»å‹çš„æ•°æ®ã€‚

### åœæ­¢æ­£åœ¨è¿è¡Œçš„QRunnable

ä¸€æ—¦å¯åŠ¨äº† QRunnableï¼Œé»˜è®¤æƒ…å†µä¸‹æ— æ³•åœæ­¢å®ƒã€‚ä»å¯ç”¨æ€§è§’åº¦æ¥çœ‹ï¼Œè¿™å¹¶ä¸ç†æƒ³â€”â€”å¦‚æœç”¨æˆ·è¯¯å¯åŠ¨äº†ä»»åŠ¡ï¼Œä»–ä»¬å°±åªèƒ½åç­‰ä»»åŠ¡å®Œæˆã€‚é—æ†¾çš„æ˜¯ï¼Œæ— æ³•ç›´æ¥ç»ˆæ­¢è¿è¡Œå™¨ï¼Œä½†æˆ‘ä»¬å¯ä»¥å˜ç›¸åœ°è¯·æ±‚å…¶åœæ­¢ã€‚åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†æ¢è®¨å¦‚ä½•é€šè¿‡è®¾ç½®æ ‡å¿—ä½æ¥æŒ‡ç¤ºè¿è¡Œå™¨éœ€è¦åœæ­¢ã€‚

![tips](tips.png)

> åœ¨è®¡ç®—ä¸­ï¼Œæ ‡å¿—æ˜¯ç”¨äºä¿¡å·å½“å‰çŠ¶æ€æˆ–çŠ¶æ€å˜åŒ–çš„å˜é‡ã€‚æƒ³æƒ³èˆ¹åªå¦‚ä½•ä½¿ç”¨æ——å¸œè¿›è¡Œé€šä¿¡ã€‚
>
> ![Figure206](Figure206.png)
>
> å›¾206ï¼šæ——è¯­ï¼Œâ€œä½ åº”è¯¥ç«‹å³åœæ­¢ä½ çš„èˆ¹åªã€‚â€

ä¸‹é¢çš„ä»£ç å®ç°äº†ä¸€ä¸ªç®€å•çš„è¿è¡Œå™¨ï¼Œå¸¦æœ‰è¿›åº¦æ¡ï¼Œè¯¥è¿›åº¦æ¡æ¯ 0.01 ç§’ä»å·¦å‘å³å¢åŠ ï¼Œä»¥åŠä¸€ä¸ª [åœæ­¢] æŒ‰é’®ã€‚å¦‚æœæ‚¨ç‚¹å‡» [åœæ­¢]ï¼Œè¯¥è¿›ç¨‹å°†é€€å‡ºï¼Œæ°¸ä¹…åœæ­¢è¿›åº¦æ¡ã€‚

*Listing 186. concurrent/qrunnable_stop.py*

```python
import sys
import time

from PyQt6.QtCore import (
    QObject,
    QRunnable,
    Qt,
    QThreadPool,
    pyqtSignal,
    pyqtSlot,
)
from PyQt6.QtWidgets import (
    QApplication,
    QHBoxLayout,
    QMainWindow,
    QProgressBar,
    QPushButton,
    QWidget,
)

class WorkerKilledException(Exception):
    pass


class WorkerSignals(QObject):
    progress = pyqtSignal(int)
    
    
class JobRunner(QRunnable):
    signals = WorkerSignals()
    def __init__(self):
        super().__init__()
        self.is_killed = False #1

    @pyqtSlot()
    def run(self):
        try:
            for n in range(100):
                self.signals.progress.emit(n + 1)
                time.sleep(0.1)
                
                if self.is_killed: #2
                    raise WorkerKilledException
                    
        except WorkerKilledException:
                pass #3
            
    def kill(self): #4
        self.is_killed = True
        
        
class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        
        # ä¸€äº›æŒ‰é’®
        w = QWidget()
        l = QHBoxLayout()
        w.setLayout(l)
        
        btn_stop = QPushButton("Stop")
        
        l.addWidget(btn_stop)
        
        self.setCentralWidget(w)
        
        # åˆ›å»ºçŠ¶æ€æ .
        self.status = self.statusBar()
        self.progress = QProgressBar()
        self.status.addPermanentWidget(self.progress)
        
        # çº¿ç¨‹è¿è¡Œå™¨
        self.threadpool = QThreadPool()
        
        # åˆ›å»ºä¸€ä¸ªè¿è¡Œå™¨
        self.runner = JobRunner()
        self.runner.signals.progress.connect(self.update_progress)
        self.threadpool.start(self.runner)
        
        btn_stop.pressed.connect(self.runner.kill)
        
        self.show()
        
    def update_progress(self, n):
        self.progress.setValue(n)
        
        
app = QApplication(sys.argv)
w = MainWindow()
app.exec()
```

> 1. ç”¨äºæŒ‡ç¤ºæ˜¯å¦åº”ç»ˆæ­¢è¿è¡Œå™¨çš„æ ‡å¿—ç§°ä¸º `.is_killed`ã€‚
> 2. åœ¨æ¯ä¸ªå¾ªç¯ä¸­ï¼Œæˆ‘ä»¬æµ‹è¯• `.is_killed` æ˜¯å¦ä¸º `True`ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚
> 3. æ•è·å¼‚å¸¸ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œå‘å‡ºå®Œæˆæˆ–é”™è¯¯ä¿¡å·ã€‚
> 4. `.kill()` æ˜¯ä¾¿åˆ©å‡½æ•°ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨ `worker.kill()` æ¥ç»ˆæ­¢å®ƒã€‚

å¦‚æœæ‚¨æƒ³åœ¨ä¸å¼•å‘å¼‚å¸¸çš„æƒ…å†µä¸‹åœæ­¢ `worker`ï¼Œåªéœ€ä» `run` æ–¹æ³•ä¸­ç›´æ¥è¿”å›ï¼Œä¾‹å¦‚ï¼š

```python
    def run(self):
        for n in range(100):
            self.signals.progress.emit(n + 1)
            time.sleep(0)
            
        if self.is_killed:
            return
```

åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åªæœ‰ä¸€ä¸ªå·¥ä½œã€‚ç„¶è€Œï¼Œåœ¨è®¸å¤šåº”ç”¨ç¨‹åºä¸­ï¼Œæ‚¨ä¼šæœ‰æ›´å¤šçš„å·¥ä½œã€‚å½“æ‚¨æœ‰å¤šä¸ªè¿è¡Œå™¨åœ¨è¿è¡Œæ—¶ï¼Œå¦‚ä½•åœæ­¢å·¥ä½œï¼Ÿ

å¦‚æœæ‚¨å¸Œæœ›åœæ­¢æ‰€æœ‰å·¥ä½œè¿›ç¨‹ï¼Œé‚£ä¹ˆæ— éœ€è¿›è¡Œä»»ä½•æ›´æ”¹ã€‚æ‚¨åªéœ€å°†æ‰€æœ‰å·¥ä½œè¿›ç¨‹è¿æ¥åˆ°ç›¸åŒçš„â€œåœæ­¢â€ä¿¡å·ï¼Œå½“è¯¥ä¿¡å·è¢«è§¦å‘æ—¶ï¼ˆä¾‹å¦‚æŒ‰ä¸‹ä¸€ä¸ªæŒ‰é’®ï¼‰ï¼Œæ‰€æœ‰å·¥ä½œè¿›ç¨‹éƒ½ä¼šåŒæ—¶åœæ­¢ã€‚

å¦‚æœæ‚¨æƒ³èƒ½å¤Ÿåœæ­¢å•ä¸ªå·¥ä½œï¼Œæ‚¨éœ€è¦åœ¨ç”¨æˆ·ç•Œé¢çš„æŸä¸ªä½ç½®ä¸ºæ¯ä¸ªå·¥ä½œåˆ›å»ºä¸€ä¸ªå•ç‹¬çš„æŒ‰é’®ï¼Œæˆ–è€…å®ç°ä¸€ä¸ªç®¡ç†å™¨æ¥è·Ÿè¸ªå·¥ä½œå¹¶æä¾›ä¸€ä¸ªæ›´å‹å¥½çš„ç•Œé¢æ¥ç»ˆæ­¢å®ƒä»¬ã€‚è¯·æŸ¥çœ‹åæ–‡çš„ ç®¡ç†å™¨ ä»¥è·å–ä¸€ä¸ªå¯å·¥ä½œçš„ç¤ºä¾‹ã€‚

### æš‚åœä¸€ä¸ªè¿è¡Œå™¨

æš‚åœä¸€ä¸ªè¿è¡Œå™¨æ˜¯ä¸€ç§è¾ƒå°‘è§çš„éœ€æ±‚â€”â€”é€šå¸¸æ‚¨å¸Œæœ›äº‹æƒ…èƒ½å°½å¯èƒ½å¿«åœ°è¿›è¡Œã€‚ä½†æœ‰æ—¶æ‚¨å¯èƒ½å¸Œæœ›è®©ä¸€ä¸ªå·¥ä½œè¿›å…¥â€œç¡çœ â€çŠ¶æ€ï¼Œä½¿å…¶æš‚æ—¶åœæ­¢ä»æ•°æ®æºè¯»å–æ•°æ®ã€‚æ‚¨å¯ä»¥é€šè¿‡å¯¹åœæ­¢è¿è¡Œå™¨çš„æ–¹æ³•è¿›è¡Œä¸€äº›å°ä¿®æ”¹æ¥å®ç°è¿™ä¸€ç‚¹ã€‚å®ç°è¿™ä¸€åŠŸèƒ½çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚

![caution](caution.png)

> æš‚åœçš„è¿è¡Œç¨‹åºä»ç„¶å ç”¨çº¿ç¨‹æ± ä¸­çš„ä¸€ä¸ªæ§½ï¼Œé™åˆ¶äº†å¯è¿è¡Œçš„å¹¶å‘ä»»åŠ¡çš„æ•°é‡ã€‚è¯·è°¨æ…ä½¿ç”¨ï¼

*Listing 187. concurrent/qrunnable_pause.py*

```python
import sys
import time

from PyQt6.QtCore import (
    QObject,
    QRunnable,
    Qt,
    QThreadPool,
    pyqtSignal,
    pyqtSlot,
)

from PyQt6.QtWidgets import (
    QApplication,
    QHBoxLayout,
    QMainWindow,
    QProgressBar,
    QPushButton,
    QWidget,
)


class WorkerKilledException(Exception):
    pass


class WorkerSignals(QObject):
    progress = pyqtSignal(int)
    
    
class JobRunner(QRunnable):
    
    signals = WorkerSignals()
    
    def __init__(self):
        super().__init__()
        self.is_paused = False
        self.is_killed = False
        
    @pyqtSlot()
    def run(self):
        for n in range(100):
            self.signals.progress.emit(n + 1)
            time.sleep(0.1)
            
            while self.is_paused:
                time.sleep(0) #1
                
            if self.is_killed:
                raise WorkerKilledException
                
    def pause(self):
        self.is_paused = True
        
    def resume(self):
        self.is_paused = False
        
    def kill(self):
        self.is_killed = True
        
        
class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        
        # ä¸€äº›æŒ‰é’®
        w = QWidget()
        l = QHBoxLayout()
        w.setLayout(l)
        
        btn_stop = QPushButton("Stop")
        btn_pause = QPushButton("Pause")
        btn_resume = QPushButton("Resume")
        
        l.addWidget(btn_stop)
        l.addWidget(btn_pause)
        l.addWidget(btn_resume)
        self.setCentralWidget(w)
        
        # åˆ›å»ºçŠ¶æ€æ .
        self.status = self.statusBar()
        self.progress = QProgressBar()
        self.status.addPermanentWidget(self.progress)
        
        # çº¿ç¨‹è¿è¡Œå™¨
        self.threadpool = QThreadPool()
        
        # åˆ›å»ºä¸€ä¸ªè¿è¡Œå™¨
        self.runner = JobRunner()
        self.runner.signals.progress.connect(self.update_progress)
        self.threadpool.start(self.runner)
        
        btn_stop.pressed.connect(self.runner.kill)
        btn_pause.pressed.connect(self.runner.pause)
        btn_resume.pressed.connect(self.runner.resume)
        
        self.show()
        
    def update_progress(self, n):
        self.progress.setValue(n)
        
        
app = QApplication(sys.argv)
w = MainWindow()
app.exec()
```

> 1. å¦‚æœæ‚¨ä¸æƒ³é¢‘ç¹æ£€æŸ¥æ˜¯å¦åˆ°äº†é†’æ¥çš„æ—¶é—´ï¼Œå¯ä»¥åœ¨ `sleep` è°ƒç”¨ä¸­è®¾ç½®ä¸€ä¸ªå¤§äº `0` çš„å€¼ã€‚

å¦‚æœæ‚¨è¿è¡Œè¿™ä¸ªç¤ºä¾‹ï¼Œæ‚¨ä¼šçœ‹åˆ°ä¸€ä¸ªè¿›åº¦æ¡ä»å·¦å‘å³ç§»åŠ¨ã€‚å¦‚æœæ‚¨ç‚¹å‡»[æš‚åœ]ï¼Œå·¥ä½œå°†æš‚åœã€‚å¦‚æœæ‚¨æ¥ä¸‹æ¥ç‚¹å‡»[ç»§ç»­]ï¼Œå·¥ä½œå°†ä»å®ƒå¼€å§‹çš„åœ°æ–¹ç»§ç»­ã€‚å¦‚æœæ‚¨ç‚¹å‡»[åœæ­¢]ï¼Œå·¥ä½œå°†æ°¸ä¹…åœæ­¢ï¼Œå°±åƒä»¥å‰ä¸€æ ·ã€‚

åœ¨æ”¶åˆ° `is_paused` ä¿¡å·æ—¶ï¼Œæˆ‘ä»¬ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œæ˜¯è¿›å…¥ä¸€ä¸ªæš‚åœå¾ªç¯ã€‚è¿™ä¼šåœæ­¢å·¥ä½œè¿›ç¨‹çš„æ‰§è¡Œï¼Œä½†ä¸ä¼šé€€å‡º `run` æ–¹æ³•æˆ–ç»ˆæ­¢å·¥ä½œè¿›ç¨‹ã€‚

é€šè¿‡ä½¿ç”¨ `while self.is_paused:` å¾ªç¯ï¼Œå½“ `worker` æ¢å¤è¿è¡Œæ—¶ï¼Œæˆ‘ä»¬å°†ç«‹å³é€€å‡ºå¾ªç¯ï¼Œå¹¶ç»§ç»­ä¹‹å‰çš„å·¥ä½œã€‚

![alert](alert.png)

> æ‚¨å¿…é¡»åŒ…å« `time.sleep()` è°ƒç”¨ã€‚è¿™ä¸ªé›¶ç§’æš‚åœå…è®¸ Python é‡Šæ”¾ GILï¼Œå› æ­¤è¯¥å¾ªç¯ä¸ä¼šé˜»å¡å…¶ä»–æ‰§è¡Œã€‚å¦‚æœæ²¡æœ‰è¿™ä¸ª `sleep`ï¼Œæ‚¨å°†æœ‰ä¸€ä¸ªå¿™å¾ªç¯ï¼Œå®ƒä¼šåœ¨ä¸åšä»»ä½•äº‹æƒ…çš„æƒ…å†µä¸‹æµªè´¹èµ„æºã€‚å¦‚æœæ‚¨æƒ³æ›´å°‘åœ°æ£€æŸ¥ï¼Œè¯·å¢åŠ  `sleep` å€¼ã€‚

### é€šä¿¡å™¨

åœ¨è¿è¡Œçº¿ç¨‹æ—¶ï¼Œæ‚¨ç»å¸¸å¸Œæœ›èƒ½å¤Ÿå®æ—¶è·å–çº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„å†…å®¹çš„è¾“å‡ºï¼Œå³åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­è·å–è¾“å‡ºã€‚  

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªåœ¨å•ç‹¬çº¿ç¨‹ä¸­å‘è¿œç¨‹æœåŠ¡å™¨å‘èµ·è¯·æ±‚çš„è¿è¡Œå™¨ï¼Œå¹¶å°†å…¶è¾“å‡ºè½¬å‘è‡³æ—¥å¿—è®°å½•å™¨ã€‚æˆ‘ä»¬è¿˜å°†æ¢è®¨å¦‚ä½•å°†è‡ªå®šä¹‰è§£æå™¨ä¼ é€’ç»™è¿è¡Œå™¨ï¼Œä»¥ä»è¯·æ±‚ä¸­æå–æˆ‘ä»¬æ„Ÿå…´è¶£çš„é¢å¤–æ•°æ®ã€‚

![tips](tips.png)

> å¦‚æœæ‚¨å¸Œæœ›ä»å¤–éƒ¨è¿›ç¨‹è€Œéçº¿ç¨‹ä¸­è®°å½•æ•°æ®ï¼Œè¯·å‚é˜… â€œè¿è¡Œå¤–éƒ¨è¿›ç¨‹â€ å’Œ â€œè¿è¡Œå¤–éƒ¨å‘½ä»¤å’Œè¿›ç¨‹â€ ã€‚

#### æ•°æ®å¯¼å‡º

åœ¨è¿™ä¸ªç¬¬ä¸€ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨è‡ªå®šä¹‰ä¿¡å·å°†æ¯ä¸ªè¯·æ±‚çš„åŸå§‹æ•°æ®ï¼ˆHTMLï¼‰è½¬å‚¨åˆ°è¾“å‡ºä¸­ã€‚

*Listing 188. concurrent/qrunnable_io.py*

```python
import sys
import requests

from PyQt6.QtCore import (
    QObject,
    QRunnable,
    QThreadPool,
    QTimer,
    pyqtSignal,
    pyqtSlot,
)
from PyQt6.QtWidgets import (
    QApplication,
    QLabel,
    QMainWindow,
    QPlainTextEdit,
    QPushButton,
    QVBoxLayout,
    QWidget,
)


class WorkerSignals(QObject):
    """
    å®šä¹‰è¿è¡Œä¸­çš„å·¥ä½œçº¿ç¨‹å¯ç”¨çš„ä¿¡å·ã€‚
    data
        å…ƒç»„ (identifier, data)
    """
    data = pyqtSignal(tuple)
    
    
class Worker(QRunnable):
    """
    å·¥ä½œçº¿ç¨‹
    ä» QRunnable ç»§æ‰¿ï¼Œç”¨äºå¤„ç†å·¥ä½œçº¿ç¨‹çš„è®¾ç½®ã€ä¿¡å·å’Œæ”¶å°¾å·¥ä½œã€‚
    
    :param id: è¯¥å·¥ä½œèŠ‚ç‚¹çš„ID
    :param url: ç”¨äºè·å–æ•°æ®çš„URL
    """
    
    def __init__(self, id, url):
        super().__init__()
        self.id = id
        self.url = url
        
        self.signals = WorkerSignals()
        
    @pyqtSlot()
    def run(self):
        r = requests.get(self.url)
        
        for line in r.text.splitlines():
            self.signals.data.emit((self.id, line))
            
            
class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.urls = [
            "https://www.pythonguis.com/",
            "https://www.mfitzp.com/",
            "https://www.google.com",
            "https://academy.pythonguis.com/",
        ]
        
        layout = QVBoxLayout()
        
        self.text = QPlainTextEdit()
        self.text.setReadOnly(True)
        
        button = QPushButton("GO GET EM!")
        button.pressed.connect(self.execute)
        
        layout.addWidget(self.text)
        layout.addWidget(button)
        
        w = QWidget()
        w.setLayout(layout)
        
        self.setCentralWidget(w)
        
        self.show()
        
        self.threadpool = QThreadPool()
        print(
            "Multithreading with maximum %d threads"
            % self.threadpool.maxThreadCount()
        )
        
    def execute(self):
        for n, url in enumerate(self.urls):
            worker = Worker(n, url)
            worker.signals.data.connect(self.display_output)
            
            # æ‰§è¡Œ
            self.threadpool.start(worker)
            
     def display_output(self, data):
        id, s = data
        self.text.appendPlainText("WORKER %d: %s" % (id, s))
        
        
app = QApplication(sys.argv)
window = MainWindow()
app.exec()
```

> è¯‘è€…æ³¨ï¼š`self.urls`ä¸­çš„ç½‘ç«™åœ¨å›½å†…è®¿é—®åŸºæœ¬éƒ½å¾ˆä¸ç¨³å®šï¼Œç”šè‡³æ‚¨è®¿é—®ä¸äº†Googleã€‚æ‚¨å¯ä»¥è¯•è¯•ç™¾åº¦ç­‰å›½å†…å…¬å…±ç½‘ç«™ï¼Œæˆ–è€…ä½¿ç”¨ç§‘å­¦ä¸Šç½‘

å¦‚æœæ‚¨è¿è¡Œè¿™ä¸ªç¤ºä¾‹å¹¶ç‚¹å‡»æŒ‰é’®ï¼Œæ‚¨ä¼šçœ‹åˆ°æ¥è‡ªå¤šä¸ªç½‘ç«™çš„HTMLè¾“å‡ºï¼Œè¿™äº›è¾“å‡ºå‰é¢ä¼šåŠ ä¸Šè·å–å®ƒä»¬çš„worker IDã€‚è¯·æ³¨æ„ï¼Œæ¥è‡ªä¸åŒå·¥ä½œçš„è¾“å‡ºæ˜¯äº¤é”™æ˜¾ç¤ºçš„ã€‚

![Figure207](Figure207.png)

> å›¾207ï¼šå°†å¤šä¸ªå·¥ä½œçº¿ç¨‹çš„è¾“å‡ºæ—¥å¿—æ˜¾ç¤ºåœ¨ä¸»çª—å£ä¸­

å½“ç„¶ï¼Œå…ƒç»„æ˜¯å¯é€‰çš„ï¼Œå¦‚æœæ‚¨åªæœ‰ä¸€ä¸ªè¿è¡Œå™¨ï¼Œæˆ–è€…ä¸éœ€è¦å°†è¾“å‡ºä¸æºå…³è”ï¼Œæ‚¨å¯ä»¥è¿”å›è£¸å­—ç¬¦ä¸²ã€‚é€šè¿‡é€‚å½“è®¾ç½®ä¿¡å·ï¼Œä¹Ÿå¯ä»¥å‘é€å­—èŠ‚å­—ç¬¦ä¸²æˆ–ä»»ä½•å…¶ä»–ç±»å‹çš„æ•°æ®ã€‚

#### æ•°æ®è§£æ

é€šå¸¸ï¼Œæ‚¨å¯¹çº¿ç¨‹ä¸­çš„åŸå§‹æ•°æ®ï¼ˆæ— è®ºæ˜¯æ¥è‡ªæœåŠ¡å™¨è¿˜æ˜¯å…¶ä»–å¤–éƒ¨è®¾å¤‡ï¼‰å¹¶ä¸æ„Ÿå…´è¶£ï¼Œè€Œæ˜¯å¸Œæœ›å…ˆå¯¹æ•°æ®è¿›è¡ŒæŸç§å¤„ç†ã€‚åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºè‡ªå®šä¹‰è§£æå™¨ï¼Œè¿™äº›è§£æå™¨å¯ä»¥ä»è¯·æ±‚çš„é¡µé¢ä¸­æå–ç‰¹å®šæ•°æ®ã€‚æˆ‘ä»¬å¯ä»¥åˆ›å»ºå¤šä¸ªå·¥ä½œè€…ï¼Œæ¯ä¸ªå·¥ä½œè€…æ¥æ”¶ä¸åŒçš„ç½‘ç«™åˆ—è¡¨å’Œè§£æå™¨ã€‚

*Listing 189. concurrent/qrunnable_io_parser.py*

```python
    self.parsers = { #1
                    # æ­£åˆ™è¡¨è¾¾å¼è§£æå™¨ï¼Œç”¨äºä»HTMLä¸­æå–æ•°æ®ã€‚
                    "title": re.compile(
                        r"<title.*?>(.*?)<\/title>", re.M | re.S
                    ),
                    "h1": re.compile(r"<h1.*?>(.*?)<\/h1>", re.M | re.S),
                    "h2": re.compile(r"<h2.*?>(.*?)<\/h2>", re.M | re.S),
                   }
```

> 1. è§£æå™¨è¢«å®šä¹‰ä¸ºä¸€ç³»åˆ—ç¼–è¯‘åçš„æ­£åˆ™è¡¨è¾¾å¼ã€‚ä½†æ‚¨å¯ä»¥æŒ‰ä»»ä½•æ–¹å¼å®šä¹‰è§£æå™¨

*Listing 190. concurrent/qrunnable_io_parser.py*

```python
    def execute(self):
        for n, url in enumerate(self.urls):
            worker = Worker(n, url, self.parsers) #1
            worker.signals.data.connect(self.display_output)
            # æ‰§è¡Œ
            self.threadpool.start(worker)
```

> 1. å°†è§£æå™¨åˆ—è¡¨ä¼ é€’ç»™æ¯ä¸ªå·¥ä½œè¿›ç¨‹ã€‚

*Listing 191. concurrent/qrunnable_io_parser.py*

```python
class Worker(QRunnable):
    """
    å·¥ä½œçº¿ç¨‹
    ä» QRunnable ç»§æ‰¿ï¼Œç”¨äºå¤„ç†å·¥ä½œçº¿ç¨‹çš„è®¾ç½®ã€ä¿¡å·å’Œæ”¶å°¾å·¥ä½œã€‚
    :param idï¼šè¯¥å·¥ä½œçº¿ç¨‹çš„ ID
    :param urlï¼šè¦æ£€ç´¢çš„ URL
    """
    def __init__(self, id, url, parsers):
        super().__init__()
        self.id = id
        self.url = url
        self.parsers = parsers
        
        self.signals = WorkerSignals()
        
    @pyqtSlot()
    def run(self):
        r = requests.get(self.url)
        
        data = {}
        for name, parser in self.parsers.items(): #1
        m = parser.search(r.text)
        if m: #2
            data[name] = m.group(1).strip()
            
    self.signals.data.emit((self.id, data))
```

> 1. éå†ä¼ é€’ç»™å·¥ä½œçº¿ç¨‹çš„è§£æå™¨åˆ—è¡¨ã€‚å¯¹è¯¥é¡µé¢çš„æ•°æ®è¿è¡Œæ¯ä¸ªè§£æå™¨ã€‚
> 2. å¦‚æœæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼Œå°†æ•°æ®æ·»åŠ åˆ°æˆ‘ä»¬çš„æ•°æ®å­—å…¸ä¸­

è¿è¡Œæ­¤ä»£ç åï¼Œæ‚¨å°†çœ‹åˆ°æ¯ä¸ªå·¥ä½œè¿›ç¨‹çš„è¾“å‡ºï¼Œå…¶ä¸­åŒ…å«æå–çš„H1ã€H2å’ŒTITLEæ ‡ç­¾ã€‚

![Figure208](Figure208.png)

> å›¾208ï¼šæ˜¾ç¤ºå¤šä¸ªå·¥ä½œè¿›ç¨‹è§£æåçš„è¾“å‡ºç»“æœ

![tips](tips.png)

> å¦‚æœæ‚¨æ­£åœ¨å¼€å‘ä»ç½‘ç«™æå–æ•°æ®çš„å·¥å…·ï¼Œå»ºè®®æ‚¨ä½¿ç”¨ [BeautifulSoup 4](https://www.crummy.com/software/BeautifulSoup/bs4/doc/)ï¼Œå®ƒæ¯”ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è¦å¼ºå¤§å¾—å¤šã€‚

### é€šç”¨åŒ–

æ‚¨å¹¶ä¸æ€»æ˜¯èƒ½æå‰çŸ¥é“éœ€è¦è®©å·¥ä½œè¿›ç¨‹æ‰§è¡Œå“ªäº›ä»»åŠ¡ã€‚æˆ–è€…ï¼Œæ‚¨å¯èƒ½éœ€è¦æ‰§è¡Œå¤šä¸ªç±»ä¼¼çš„å‡½æ•°ï¼Œå¹¶å¸Œæœ›æœ‰ä¸€ä¸ªç»Ÿä¸€çš„ API æ¥è¿è¡Œå®ƒä»¬ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥åˆ©ç”¨ Python ä¸­å‡½æ•°æ˜¯å¯¹è±¡è¿™ä¸€ç‰¹æ€§ï¼Œæ„å»ºä¸€ä¸ªé€šç”¨è¿è¡Œå™¨ï¼Œè¯¥è¿è¡Œå™¨ä¸ä»…æ¥å—å‚æ•°ï¼Œè¿˜æ¥å—è¦æ‰§è¡Œçš„å‡½æ•°ã€‚

åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå•ä¸€çš„ Worker ç±»ï¼Œç„¶åä½¿ç”¨å®ƒæ¥è¿è¡Œå¤šä¸ªä¸åŒçš„å‡½æ•°ã€‚é€šè¿‡è¿™ç§è®¾ç½®ï¼Œæ‚¨å¯ä»¥ä¼ å…¥ä»»ä½• Python å‡½æ•°ï¼Œå¹¶åœ¨å•ç‹¬çš„çº¿ç¨‹ä¸­æ‰§è¡Œå®ƒã€‚

ä»¥ä¸‹ç»™å‡ºäº†å®Œæ•´çš„å·¥ä½œç¤ºä¾‹ï¼Œå±•ç¤ºäº†è‡ªå®šä¹‰çš„ `QRunnable` å·¥ä½œä»¥åŠå·¥ä½œå’Œè¿›åº¦ä¿¡å·ã€‚æ‚¨åº”è¯¥èƒ½å¤Ÿå°†æ­¤ä»£ç åº”ç”¨äºæ‚¨å¼€å‘çš„ä»»ä½•åº”ç”¨ç¨‹åºã€‚

*Listing 192. concurrent/qrunnable_generic.py*

```python
import sys
import time
import traceback

from PyQt6.QtCore import (
    QObject,
    QRunnable,
    QThreadPool,
    QTimer,
    pyqtSignal,
    pyqtSlot,
)
from PyQt6.QtWidgets import (
    QApplication,
    QLabel,
    QMainWindow,
    QPushButton,
    QVBoxLayout,
    QWidget,
)

def execute_this_fn():
    for _ in range(0, 5):
        time.sleep(1)
    
    return "Done."


class WorkerSignals(QObject):
    """
    å®šä¹‰è¿è¡Œä¸­çš„å·¥ä½œçº¿ç¨‹å¯ç”¨çš„ä¿¡å·
    æ”¯æŒçš„ä¿¡å·ä¸ºï¼š
    finished
        æ— æ•°æ®
    error
        `å…ƒç»„` (å¼‚å¸¸ç±»å‹, å€¼, traceback.format_exc() )
    result
        `å¯¹è±¡` å¤„ç†åè¿”å›çš„æ•°æ®ï¼Œä»»ä½•ç±»å‹
    
    """
    finished = pyqtSignal()
    error = pyqtSignal(tuple)
    result = pyqtSignal(object)
    
    
class Worker(QRunnable):
    """
    å·¥ä½œçº¿ç¨‹
    ä» QRunnable ç»§æ‰¿ï¼Œç”¨äºå¤„ç†å·¥ä½œçº¿ç¨‹çš„è®¾ç½®ã€ä¿¡å·å’Œæ”¶å°¾å·¥ä½œã€‚
    :param callback: åœ¨æ­¤å·¥ä½œçº¿ç¨‹ä¸Šè¿è¡Œçš„å›è°ƒå‡½æ•°ã€‚  
    :thread. æä¾›çš„ args å’Œ kwargs å°†ä¼ é€’ç»™è¿è¡Œå™¨ã€‚  
    :type callback: å‡½æ•°  
    :param args: ä¼ é€’ç»™å›è°ƒå‡½æ•°çš„å‚æ•°  
    :param kwargs: ä¼ é€’ç»™å›è°ƒå‡½æ•°çš„å…³é”®å­—å‚æ•°
    :
    """
    def __init__(self, fn, *args, **kwargs):
        super().__init__()
        
        # æ‹†åˆ†æ„é€ å‡½æ•°å‚æ•°ï¼ˆç”¨äºåç»­å¤„ç†ï¼‰
        self.fn = fn
        self.args = args
        self.kwargs = kwargs
        self.signals = WorkerSignals()
        
    @pyqtSlot()
    def run(self):
        """
        ä½¿ç”¨ä¼ å…¥çš„å‚æ•°å’Œå…³é”®å­—å‚æ•°ï¼ˆargs/kwargsï¼‰åˆå§‹åŒ–è¿è¡Œå™¨å‡½æ•°ã€‚
        """
        
        # åœ¨æ­¤å¤„è·å–å‚æ•°ï¼ˆargs/kwargsï¼‰ï¼›å¹¶ä½¿ç”¨å®ƒä»¬è§¦å‘å¤„ç†æµç¨‹ã€‚
        try:
            result = self.fn(*self.args, **self.kwargs)
        except:
            traceback.print_exc()
            exctype, value = sys.exc_info()[:2]
            self.signals.error.emit(
                (exctype, value, traceback.format_exc())
            )
        else:
            self.signals.result.emit(
                result
            ) # è¿”å›å¤„ç†ç»“æœ
        finally:
            self.signals.finished.emit() # å®Œæˆ
            
            
class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        
        self.counter = 0
        
        layout = QVBoxLayout()
        
        self.l = QLabel("Start")
        b = QPushButton("DANGER!")
        b.pressed.connect(self.oh_no)
        
        layout.addWidget(self.l)
        layout.addWidget(b)
        
        w = QWidget()
        w.setLayout(layout)
        
        self.setCentralWidget(w)
        
        self.show()
        
        self.threadpool = QThreadPool()
        print(
            "Multithreading with maximum %d threads"
            % self.threadpool.maxThreadCount()
        )
        
        self.timer = QTimer()
        self.timer.setInterval(1000)
        self.timer.timeout.connect(self.recurring_timer)
        self.timer.start()
        
    def print_output(self, s):
        print(s)
        
    def thread_complete(self):
        print("THREAD COMPLETE!")
        
    def oh_no(self):
        # ä¼ é€’è¦æ‰§è¡Œçš„å‡½æ•°
        worker = Worker(
            execute_this_fn
        ) # ä»»ä½•å…¶ä»–å‚æ•°ï¼ˆargsï¼‰å’Œå…³é”®å­—å‚æ•°ï¼ˆkwargsï¼‰éƒ½ä¼šä¼ é€’ç»™runå‡½æ•°ã€‚
        worker.signals.result.connect(self.print_output)
        worker.signals.finished.connect(self.thread_complete)
        
        # æ‰§è¡Œ
        self.threadpool.start(worker)
        
    def recurring_timer(self):
        self.counter += 1
        self.l.setText("Counter: %d" % self.counter)
        
        
app = QApplication(sys.argv)
window = MainWindow()
app.exec()
```

é€šç”¨å‡½æ•°æ–¹æ³•å¢åŠ äº†ä¸€ä¸ªå¯èƒ½å¹¶ä¸æ˜æ˜¾çš„é™åˆ¶â€”â€”è¿è¡Œå‡½æ•°æ— æ³•è®¿é—®è¿è¡Œå™¨çš„ `self` å¯¹è±¡ï¼Œå› æ­¤æ— æ³•è®¿é—®ä¿¡å·æ¥å‘å‡ºæ•°æ®æœ¬èº«ã€‚æˆ‘ä»¬åªèƒ½åœ¨å‡½æ•°ç»“æŸæ—¶å‘å‡ºå‡½æ•°çš„è¿”å›å€¼ã€‚è™½ç„¶æ‚¨å¯ä»¥è¿”å›ä¸€ä¸ªå¤åˆç±»å‹ï¼ˆå¦‚å…ƒç»„ï¼‰æ¥è¿”å›å¤šä¸ªå€¼ï¼Œä½†æ‚¨æ— æ³•è·å¾—è¿›åº¦ä¿¡å·æˆ–æ­£åœ¨å¤„ç†çš„æ•°æ®ã€‚

ä½†æ˜¯ï¼Œæœ‰ä¸€ä¸ªè§£å†³æ–¹æ³•ã€‚ç”±äºæ‚¨å¯ä»¥å°†ä»»ä½•å†…å®¹ä¼ é€’åˆ°è‡ªå®šä¹‰å‡½æ•°ï¼Œå› æ­¤æ‚¨ä¹Ÿå¯ä»¥ä¼ é€’ `self` æˆ– `self.signals` å¯¹è±¡ï¼Œä»¥ä¾¿ä½¿ç”¨å®ƒä»¬ã€‚

*Listing 193. concurrent/qrunnable_generic_callback.py*

```python
import sys
import time
import traceback

from PyQt6.QtCore import (
    QObject,
    QRunnable,
    QThreadPool,
    QTimer,
    pyqtSignal,
    pyqtSlot,
)
from PyQt6.QtWidgets import (
    QApplication,
    QLabel,
    QMainWindow,
    QPushButton,
    QVBoxLayout,
    QWidget,
)


def execute_this_fn(signals):
    for n in range(0, 5):
        time.sleep(1)
        signals.progress.emit(n * 100 / 4)
        
    return "Done." 


class WorkerSignals(QObject):
    """
    å®šä¹‰è¿è¡Œä¸­çš„å·¥ä½œçº¿ç¨‹å¯ç”¨çš„ä¿¡å·
    æ”¯æŒçš„ä¿¡å·ä¸ºï¼š
    finished
        æ— æ•°æ®
    error
        `å…ƒç»„` (å¼‚å¸¸ç±»å‹, å€¼, traceback.format_exc() )
    result
        `å¯¹è±¡` å¤„ç†åè¿”å›çš„æ•°æ®ï¼Œä»»ä½•ç±»å‹
    progress
        `æ•´å½¢` indicating % progress
    
    """
    finished = pyqtSignal()
    error = pyqtSignal(tuple)
    result = pyqtSignal(object)
    progress = pyqtSignal(int)
    
    
class Worker(QRunnable):
    """
    å·¥ä½œçº¿ç¨‹
    ä» QRunnable ç»§æ‰¿ï¼Œç”¨äºå¤„ç†å·¥ä½œçº¿ç¨‹çš„è®¾ç½®ã€ä¿¡å·å’Œæ”¶å°¾å·¥ä½œã€‚
    :param callback: åœ¨æ­¤å·¥ä½œçº¿ç¨‹ä¸Šè¿è¡Œçš„å›è°ƒå‡½æ•°ã€‚  
    :thread. æä¾›çš„ args å’Œ kwargs å°†ä¼ é€’ç»™è¿è¡Œå™¨ã€‚  
    :type callback: å‡½æ•°  
    :param args: ä¼ é€’ç»™å›è°ƒå‡½æ•°çš„å‚æ•°  
    :param kwargs: ä¼ é€’ç»™å›è°ƒå‡½æ•°çš„å…³é”®å­—å‚æ•°
    :
    """
    def __init__(self, fn, *args, **kwargs):
        super().__init__()
        # æ‹†åˆ†æ„é€ å‡½æ•°å‚æ•°ï¼ˆç”¨äºåç»­å¤„ç†ï¼‰
        self.fn = fn
        self.args = args
        self.kwargs = kwargs
        self.signals = WorkerSignals()
        
        # å°†å›è°ƒå‡½æ•°æ·»åŠ åˆ°æˆ‘ä»¬çš„å…³é”®å­—å‚æ•°ä¸­
        kwargs["signals"] = self.signals
        
    @pyqtSlot()
     def run(self):
        """
        ä½¿ç”¨ä¼ å…¥çš„å‚æ•°å’Œå…³é”®å­—å‚æ•°ï¼ˆargs/kwargsï¼‰åˆå§‹åŒ–è¿è¡Œå™¨å‡½æ•°ã€‚
        """
        
        # åœ¨æ­¤å¤„è·å–å‚æ•°ï¼ˆargs/kwargsï¼‰ï¼›å¹¶ä½¿ç”¨å®ƒä»¬è§¦å‘å¤„ç†æµç¨‹ã€‚
        try:
            result = self.fn(*self.args, **self.kwargs)
        except:
            traceback.print_exc()
            exctype, value = sys.exc_info()[:2]
            self.signals.error.emit(
                (exctype, value, traceback.format_exc())
            )
        else:
            self.signals.result.emit(
                result
            ) # è¿”å›å¤„ç†ç»“æœ
        finally:
            self.signals.finished.emit() # å®Œæˆ
            
            
class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        
        self.counter = 0
        
        layout = QVBoxLayout()
        
        self.l = QLabel("Start")
        b = QPushButton("DANGER!")
        b.pressed.connect(self.oh_no)
        
        layout.addWidget(self.l)
        layout.addWidget(b)
        
        w = QWidget()
        w.setLayout(layout)
        
        self.setCentralWidget(w)
        
        self.show()
        
        self.threadpool = QThreadPool()
        print(
            "Multithreading with maximum %d threads"
            % self.threadpool.maxThreadCount()
        )
        
        self.timer = QTimer()
        self.timer.setInterval(1000)
        self.timer.timeout.connect(self.recurring_timer)
        self.timer.start()
        
    def progress_fn(self, n):
        print("%d%% done" % n)
        
    def print_output(self, s):
        print(s)
        
    def thread_complete(self):
        print("THREAD COMPLETE!")
        
    def oh_no(self):
        # ä¼ é€’è¦æ‰§è¡Œçš„å‡½æ•°
        worker = Worker(
            execute_this_fn
        ) # ä»»ä½•å…¶ä»–å‚æ•°ï¼ˆargsï¼‰å’Œå…³é”®å­—å‚æ•°ï¼ˆkwargsï¼‰éƒ½ä¼šä¼ é€’ç»™runå‡½æ•°ã€‚
        worker.signals.result.connect(self.print_output)
        worker.signals.finished.connect(self.thread_complete)
        worker.signals.progress.connect(self.progress_fn)
        
        # æ‰§è¡Œ
        self.threadpool.start(worker)
        
    def recurring_timer(self):
        self.counter += 1
        self.l.setText("Counter: %d" % self.counter)        
        
        
app = QApplication(sys.argv)
window = MainWindow()
app.exec()
```

è¯·æ³¨æ„ï¼Œè¦ä½¿æ­¤åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼Œæ‚¨çš„è‡ªå®šä¹‰å‡½æ•°å¿…é¡»èƒ½å¤Ÿæ¥å—é¢å¤–çš„å‚æ•°ã€‚æ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨ `**kwargs` å®šä¹‰å‡½æ•°æ¥å®ç°è¿™ä¸€ç‚¹ï¼Œè¿™æ ·å¦‚æœé¢å¤–å‚æ•°æœªè¢«ä½¿ç”¨ï¼Œå®ƒä»¬å°†è¢«é™é»˜åœ°å¿½ç•¥ã€‚

```python
def execute_this_fn(**kwargs): #1
    for _ in range(0, 5):
        time.sleep(1)

    return "Done."
```

> `signals` å…³é”®å­—å‚æ•°è¢« `**kwargs` åå™¬ï¼ˆæ©ç›–ï¼‰

### è¿è¡Œå¤–éƒ¨è¿›ç¨‹

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»æ¢è®¨äº†å¦‚ä½•åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­è¿è¡Œ Python ä»£ç ã€‚ç„¶è€Œï¼Œæœ‰æ—¶æ‚¨éœ€è¦åœ¨å¦ä¸€ä¸ªè¿›ç¨‹ä¸­è¿è¡Œå¤–éƒ¨ç¨‹åºâ€”â€”ä¾‹å¦‚å‘½ä»¤è¡Œç¨‹åºã€‚

åœ¨ä½¿ç”¨ PyQt6 å¯åŠ¨å¤–éƒ¨è¿›ç¨‹æ—¶ï¼Œæ‚¨å®é™…ä¸Šæœ‰å¤šç§é€‰æ‹©ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ Python çš„å†…ç½® `subprocess` æ¨¡å—æ¥å¯åŠ¨è¿›ç¨‹ï¼Œæˆ–è€…æ‚¨å¯ä»¥ä½¿ç”¨ Qt çš„ `QProcess`ã€‚

![tips](tips.png)

> æœ‰å…³ä½¿ç”¨ `QProcess` è¿è¡Œå¤–éƒ¨è¿›ç¨‹çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…â€œè¿è¡Œå¤–éƒ¨å‘½ä»¤å’Œè¿‡ç¨‹â€ç« èŠ‚ã€‚

å¯åŠ¨æ–°è¿›ç¨‹æ€»ä¼šå¸¦æ¥ä¸€äº›æ‰§è¡Œæˆæœ¬ï¼Œå¹¶ä¼šæš‚æ—¶é˜»å¡æ‚¨çš„å›¾å½¢ç”¨æˆ·ç•Œé¢ã€‚è¿™é€šå¸¸å¹¶ä¸æ˜æ˜¾ï¼Œä½†æ ¹æ®æ‚¨çš„ä½¿ç”¨æƒ…å†µï¼Œå¯èƒ½ä¼šç´¯ç§¯èµ·æ¥ï¼Œå¹¶å¯èƒ½å½±å“æ€§èƒ½ã€‚æ‚¨å¯ä»¥é€šè¿‡åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­å¯åŠ¨è¿›ç¨‹æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

å¦‚æœæ‚¨æƒ³ä¸è¿›ç¨‹è¿›è¡Œå®æ—¶é€šä¿¡ï¼Œåˆ™éœ€è¦ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹æ¥é¿å…é˜»å¡å›¾å½¢ç”¨æˆ·ç•Œé¢ã€‚ `QProcess` ä¼šåœ¨å†…éƒ¨ä¸ºæ‚¨å¤„ç†è¿™ä¸ªå•ç‹¬çš„çº¿ç¨‹ï¼Œä½†ä½¿ç”¨Pythonå­è¿›ç¨‹æ—¶ï¼Œæ‚¨éœ€è¦è‡ªå·±å®Œæˆè¿™é¡¹å·¥ä½œã€‚

åœ¨è¿™ä¸ª `QRunnable` ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ `worker` çš„å®ä¾‹æ¥é€šè¿‡ Python å­è¿›ç¨‹å¤„ç†å¯åŠ¨å¤–éƒ¨è¿›ç¨‹ã€‚è¿™ä½¿è¿›ç¨‹çš„å¯åŠ¨æˆæœ¬ä¸ä¼šå ç”¨å›¾å½¢ç”¨æˆ·ç•Œé¢çš„çº¿ç¨‹ï¼Œå¹¶ä¸”å…è®¸æˆ‘ä»¬é€šè¿‡ Python ç›´æ¥ä¸è¿›ç¨‹äº¤äº’ã€‚

*Listing 194. concurrent/qrunnable_process.py*

```python
import subprocess
import sys

from PyQt6.QtCore import (
    QObject,
    QRunnable,
    QThreadPool,
    pyqtSignal,
    pyqtSlot,
)
from PyQt6.QtWidgets import (
    QApplication,
    QMainWindow,
    QPlainTextEdit,
    QPushButton,
    QVBoxLayout,
    QWidget,
)


class WorkerSignals(QObject):
    """
    å®šä¹‰äº†è¿è¡Œä¸­çš„å·¥ä½œçº¿ç¨‹å¯ç”¨çš„ä¿¡å·ã€‚
    æ”¯æŒçš„ä¿¡å·åŒ…æ‹¬ï¼š
    
    finished: æ²¡æœ‰æ•°æ®
    result: str
    """
    result = pyqtSignal(
        str
    ) # å°†è¿›ç¨‹çš„è¾“å‡ºä½œä¸ºå­—ç¬¦ä¸²è¿”å›ã€‚.
    finished = pyqtSignal()
    
    
class SubProcessWorker(QRunnable):
    """
    ProcessWorker å·¥ä½œçº¿ç¨‹
    ä» QRunnable ç»§æ‰¿ï¼Œç”¨äºå¤„ç†å·¥ä½œçº¿ç¨‹çš„è®¾ç½®ã€ä¿¡å·å’Œæ”¶å°¾å·¥ä½œã€‚
    
    :param command: ä½¿ç”¨ `subprocess` æ‰§è¡Œçš„å‘½ä»¤.
    """
    
    def __init__(self, command):
        super().__init__()
        # å­˜å‚¨æ„é€ å‡½æ•°å‚æ•°ï¼ˆç”¨äºåç»­å¤„ç†ï¼‰ã€‚
        self.signals = WorkerSignals()
        # è¦æ‰§è¡Œçš„å‘½ä»¤.
        self.command = command
        
    @pyqtSlot()
    def run(self):
        """
        æ‰§è¡Œå‘½ä»¤ï¼Œè¿”å›ç»“æœ
        """
        output = subprocess.getoutput(self.command)
        self.signals.result.emit(output)
        self.signals.finished.emit()
        
        
class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        
        # ä¸€äº›æŒ‰é’®
        layout = QVBoxLayout()
        
        self.text = QPlainTextEdit()
        layout.addWidget(self.text)
        
        btn_run = QPushButton("Execute")
        btn_run.clicked.connect(self.start)
        layout.addWidget(btn_run)
        
        w = QWidget()
        w.setLayout(layout)
        self.setCentralWidget(w)
        
        # çº¿ç¨‹è¿è¡Œå™¨
        self.threadpool = QThreadPool()
        
        self.show()
        
    def start(self):
        # åˆ›å»ºä¸€ä¸ªè¿è¡Œå™¨
        self.runner = SubProcessWorker("python dummy_script.py")
        self.runner.signals.result.connect(self.result)
        self.threadpool.start(self.runner)
        
    def result(self, s):
        self.text.appendPlainText(s)
        
        
app = QApplication(sys.argv)
w = MainWindow()
app.exec()
```

![tips](tips.png)

> æœ¬ç¤ºä¾‹ä¸­çš„â€œå¤–éƒ¨ç¨‹åºâ€æ˜¯ä¸€ä¸ªç®€å•çš„ Python è„šæœ¬ `python dummy_script.py`ã€‚ä¸è¿‡ï¼Œæ‚¨å¯ä»¥å°†å…¶æ›¿æ¢ä¸ºä»»ä½•å…¶ä»–æ‚¨å–œæ¬¢çš„ç¨‹åºã€‚

è¿è¡Œä¸­çš„è¿›ç¨‹æœ‰ä¸¤ä¸ªè¾“å‡ºæµâ€”â€”æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯ã€‚æ ‡å‡†è¾“å‡ºè¿”å›æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å®é™…ç»“æœï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ï¼Œè€Œæ ‡å‡†é”™è¯¯è¿”å›ä»»ä½•é”™è¯¯æˆ–æ—¥å¿—ä¿¡æ¯ã€‚

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ `subprocess.getoutput` è¿è¡Œå¤–éƒ¨è„šæœ¬ã€‚  è¿™ä¼šè¿è¡Œå¤–éƒ¨ç¨‹åºï¼Œå¹¶åœ¨å…¶å®Œæˆåè¿”å›ã€‚ä¸€æ—¦ ç¨‹åºå®Œæˆï¼Œ`getoutput` ä¼šå°†æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯  ä¸€èµ·ä½œä¸ºä¸€ä¸ªå­—ç¬¦ä¸²è¿”å›ã€‚

#### è§£æç»“æœ

æ‚¨æ— éœ€ç›´æ¥ä¼ é€’è¾“å‡ºç»“æœã€‚å¦‚æœæ‚¨éœ€è¦å¯¹å‘½ä»¤çš„è¾“å‡ºç»“æœè¿›è¡Œåå¤„ç†ï¼Œåˆ™å¯ä»¥åœ¨å·¥ä½œçº¿ç¨‹ä¸­å¤„ç†è¯¥è¾“å‡ºç»“æœï¼Œä»¥ä¿æŒå…¶ç‹¬ç«‹æ€§ã€‚ç„¶åï¼Œå·¥ä½œçº¿ç¨‹å¯ä»¥ä»¥ç»“æ„åŒ–çš„æ ¼å¼å°†æ•°æ®è¿”å›ç»™å›¾å½¢ç”¨æˆ·ç•Œé¢çº¿ç¨‹ï¼Œä»¥ä¾¿ä½¿ç”¨ã€‚

åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä¼ é€’äº†ä¸€ä¸ªå‡½æ•°æ¥åå¤„ç†ç¤ºä¾‹è„šæœ¬çš„ç»“æœï¼Œå°†æ„Ÿå…´è¶£çš„å€¼æå–åˆ°å­—å…¸ä¸­ã€‚è¿™äº›æ•°æ®ç”¨äºæ›´æ–°å›¾å½¢ç”¨æˆ·ç•Œé¢çš„æ§ä»¶ã€‚

*Listing 195. concurrent/qrunnable_process_result.py*

```python
import subprocess
import sys
from collections import namedtuple

from PyQt6.QtCore import (
    QObject,
    QRunnable,
    QThreadPool,
    pyqtSignal,
    pyqtSlot,
)
from PyQt6.QtWidgets import (
    QApplication,
    QLineEdit,
    QMainWindow,
    QPushButton,
    QSpinBox,
    QVBoxLayout,
    QWidget,
)


def extract_vars(l):
    """
    ä»è¡Œä¸­æå–å˜é‡ï¼ŒæŸ¥æ‰¾åŒ…å«ç­‰å·çš„è¡Œï¼Œå¹¶å°†å…¶æ‹†åˆ†ä¸ºé”®å€¼å¯¹ã€‚
    """
    data = {}
    for s in l.splitlines():
        if "=" in s:
            name, value = s.split("=")
            data[name] = value
            
    data["number_of_lines"] = len(l)
    return data


class WorkerSignals(QObject):
    """
    å®šä¹‰è¿è¡Œä¸­çš„å·¥ä½œçº¿ç¨‹å¯ç”¨çš„ä¿¡å·
    æ”¯æŒçš„ä¿¡å·ä¸ºï¼š
    finished: æ²¡æœ‰æ•°æ®
    result: å­—å…¸
    """
    
    result = pyqtSignal(dict) # å°†è¾“å‡ºä½œä¸ºå­—å…¸è¿”å›.
    finished = pyqtSignal()
    
    
class SubProcessWorker(QRunnable):
    """
    ProcessWorker å·¥ä½œçº¿ç¨‹
    ä» QRunnable ç»§æ‰¿ï¼Œç”¨äºå¤„ç†å·¥ä½œçº¿ç¨‹çš„è®¾ç½®ã€ä¿¡å·å’Œæ”¶å°¾å·¥ä½œã€‚
    
    :param command: ä½¿ç”¨ `subprocess` æ‰§è¡Œçš„å‘½ä»¤.
    """
    
    def __init__(self, command):
        super().__init__()
        # å­˜å‚¨æ„é€ å‡½æ•°å‚æ•°ï¼ˆç”¨äºåç»­å¤„ç†ï¼‰ã€‚
        self.signals = WorkerSignals()
        # è¦æ‰§è¡Œçš„å‘½ä»¤.
        self.command = command
        
        # åå¤„ç†å‡½æ•°
        self.process_result = process_result
        
    @pyqtSlot()
    def run(self):
        """
        æ‰§è¡Œå‘½ä»¤ï¼Œè¿”å›ç»“æœ
        """
        output = subprocess.getoutput(self.command)
        
        if self.process_result:
            output = self.process_result(output)
            
        self.signals.result.emit(output)
        self.signals.finished.emit()
        
        
class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        
        # ä¸€äº›æŒ‰é’®
        layout = QVBoxLayout()
        
        self.name = QLineEdit()
        layout.addWidget(self.name)
        
        self.country = QLineEdit()
        layout.addWidget(self.country)
        
        self.website = QLineEdit()
        layout.addWidget(self.website)
        
        self.number_of_lines = QSpinBox()
        layout.addWidget(self.number_of_lines)
        
        btn_run = QPushButton("Execute")
        btn_run.clicked.connect(self.start)
        
        layout.addWidget(btn_run)
        
        w = QWidget()
        w.setLayout(layout)
        self.setCentralWidget(w)
        
        # çº¿ç¨‹è¿è¡Œå™¨
        self.threadpool = QThreadPool()
        
        self.show()
        
    def start(self):
        # åˆ›å»ºä¸€ä¸ªè¿è¡Œå™¨
        self.runner = SubProcessWorker(
            "python dummy_script.py", process_result=extract_vars
        )
        self.runner.signals.result.connect(self.result)
        self.threadpool.start(self.runner)
        
    def result(self, data):
        print(data)
        self.name.setText(data["name"])
        self.country.setText(data["country"])
        self.website.setText(data["website"])
        self.number_of_lines.setValue(data["number_of_lines"])
        
        
app = QApplication(sys.argv)
w = MainWindow()
app.exec()
```

åœ¨æ­¤æƒ…å†µä¸‹ï¼Œç®€å•çš„è§£æå™¨ä¼šæŸ¥æ‰¾åŒ…å«â€œ=â€çš„ä»»ä½•è¡Œï¼Œå¹¶ä»¥æ­¤ä¸ºåˆ†éš”ç¬¦åˆ†å‰²ï¼Œä»¥ç”Ÿæˆåç§°å’Œå€¼ï¼Œç„¶åå°†å®ƒä»¬å­˜å‚¨åœ¨å­—å…¸ä¸­ã€‚ç„¶è€Œï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»»ä½•æ‚¨å–œæ¬¢çš„å·¥å…·ä»å­—ç¬¦ä¸²è¾“å‡ºä¸­æå–æ•°æ®ã€‚

ç”±äº `getoutput` ä¼šé˜»å¡ç›´åˆ°ç¨‹åºå®Œæˆï¼Œæˆ‘ä»¬æ— æ³•çœ‹åˆ°ç¨‹åºçš„è¿è¡Œæƒ…å†µâ€”â€”ä¾‹å¦‚ï¼Œè·å–è¿›åº¦ä¿¡æ¯ã€‚åœ¨æ¥ä¸‹æ¥çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†å±•ç¤ºå¦‚ä½•ä»æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ä¸­è·å–å®æ—¶è¾“å‡ºã€‚

#### è·Ÿè¸ªè¿›åº¦

é€šå¸¸å¤–éƒ¨ç¨‹åºä¼šå°†è¿›åº¦ä¿¡æ¯è¾“å‡ºåˆ°æ§åˆ¶å°ã€‚æ‚¨å¯èƒ½å¸Œæœ›æ•è·è¿™äº›ä¿¡æ¯ï¼Œå¹¶å°†å…¶æ˜¾ç¤ºç»™ç”¨æˆ·ï¼Œæˆ–ç”¨äºç”Ÿæˆä¸€ä¸ªè¿›åº¦æ¡ã€‚

å¯¹äºæ‰§è¡Œç»“æœï¼Œæ‚¨é€šå¸¸éœ€è¦æ•è·æ ‡å‡†è¾“å‡ºï¼Œå¯¹äºè¿›åº¦ï¼Œåˆ™éœ€è¦æ•è·æ ‡å‡†é”™è¯¯ã€‚åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åŒæ—¶æ•è·ä¸¤è€…ã€‚é™¤äº†å‘½ä»¤å¤–ï¼Œæˆ‘ä»¬è¿˜å‘å·¥ä½œä¼ é€’ä¸€ä¸ªè‡ªå®šä¹‰è§£æå‡½æ•°ï¼Œä»¥æ•è·å½“å‰å·¥ä½œçš„è¿›åº¦å¹¶å°†å…¶ä½œä¸º 0-99 ä¹‹é—´çš„æ•°å­—è¾“å‡ºã€‚

è¿™ä¸ªç¤ºä¾‹ç›¸å½“å¤æ‚ã€‚å®Œæ•´çš„æºä»£ç å¯åœ¨éšä¹¦é™„å¸¦çš„æºä»£ç ä¸­æ‰¾åˆ°ï¼Œä½†è¿™é‡Œæˆ‘ä»¬å°†é‡ç‚¹ä»‹ç»ä¸è¾ƒç®€å•ç‰ˆæœ¬çš„å…³é”®å·®å¼‚ã€‚

*Listing 196. concurrent/qrunnable_process_parser.py*

```python
    @pyqtSlot()
    def run(self):
        """
        ä½¿ç”¨ä¼ å…¥çš„å‚æ•°å’Œå…³é”®å­—å‚æ•°ï¼ˆargs/kwargsï¼‰åˆå§‹åŒ–è¿è¡Œå™¨å‡½æ•°.
        """
        result = []
        
        with subprocess.Popen( #1
                              self.command,
                              bufsize=1,
                              stdout=subprocess.PIPE,
                              stderr=subprocess.STDOUT, #2
                              universal_newlines=True,
        ) as proc:
            while proc.poll() is None:
                data = proc.stdout.readline() #3
                result.append(data)
                if self.parser: #4
                    value = self.parser(data)
                    if value:
                        self.signals.progress.emit(value)
                        
        output = "".join(result)
        
        self.signals.result.emit(output)
```

> 1. ä½¿ç”¨ Popen è¿è¡Œä»¥è·å–è¾“å‡ºæµçš„è®¿é—®æƒé™ã€‚
> 2. æˆ‘ä»¬å°†æ ‡å‡†é”™è¯¯ä¸æ ‡å‡†è¾“å‡ºä¸€èµ·é‡å®šå‘ã€‚
> 3. ä»è¿›ç¨‹ä¸­è¯»å–ä¸€è¡Œï¼ˆæˆ–ç­‰å¾…ä¸€è¡Œï¼‰ã€‚
> 4. å°†ç›®å‰æ”¶é›†çš„æ‰€æœ‰æ•°æ®ä¼ é€’ç»™è§£æå™¨ã€‚

è§£æç”±è¿™ä¸ªç®€å•çš„è§£æå™¨å‡½æ•°æ¥å®Œæˆï¼Œå®ƒæ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¹¶åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼ Â·Total complete: (\d+)%Â·ã€‚

*Listing 197. concurrent/qrunnable_process_parser.py*

```python
progress_re = re.compile("Total complete: (\d+)%")

def simple_percent_parser(output):
    """
    ä½¿ç”¨ progress_re æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…è¡Œï¼Œ
    è¿”å›ä¸€ä¸ªæ•´æ•°è¡¨ç¤ºç™¾åˆ†æ¯”è¿›åº¦ã€‚
    """
    m = progress_re.search(output)
    if m:
        pc_complete = m.group(1)
        return int(pc_complete)
```

è§£æå™¨ä¸å‘½ä»¤ä¸€èµ·ä¼ é€’ç»™è¿è¡Œå™¨â€”â€”è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å¯¹æ‰€æœ‰å­è¿›ç¨‹ä½¿ç”¨é€šç”¨è¿è¡Œå™¨ï¼Œå¹¶é’ˆå¯¹ä¸åŒçš„å‘½ä»¤ä»¥ä¸åŒçš„æ–¹å¼å¤„ç†è¾“å‡ºã€‚

*Listing 198. concurrent/qrunnable_process_parser.py*

```python
    def start(self):
        # åˆ›å»ºä¸€ä¸ªè¿è¡Œå™¨
        self.runner = SubProcessWorker(
            command="python dummy_script.py",
            parser=simple_percent_parser,
        )
        self.runner.signals.result.connect(self.result)
        self.runner.signals.progress.connect(self.progress.setValue)
        self.threadpool.start(self.runner)
```

åœ¨è¿™ä¸ªç®€å•çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä»…ä¼ é€’è¿›ç¨‹ä¸­çš„æœ€æ–°ä¸€è¡Œï¼Œå› ä¸ºæˆ‘ä»¬çš„è‡ªå®šä¹‰è„šæœ¬ä¼šè¾“å‡ºç±»ä¼¼â€œæ€»å®Œæˆï¼š25%â€çš„è¡Œã€‚è¿™æ„å‘³ç€æˆ‘ä»¬åªéœ€æœ€æ–°ä¸€è¡Œå³å¯è®¡ç®—å½“å‰è¿›åº¦ã€‚

ç„¶è€Œï¼Œæœ‰æ—¶è„šæœ¬å¯èƒ½ä¸å¤ªå®ç”¨ã€‚ä¾‹å¦‚ï¼Œ`FFmpeg` çš„è§†é¢‘ç¼–ç å™¨ä¼šåœ¨å¤„ç†è§†é¢‘æ–‡ä»¶æ—¶ï¼Œåœ¨å¼€å§‹æ—¶è¾“å‡ºè§†é¢‘æ–‡ä»¶çš„æ€»æ—¶é•¿ï¼Œç„¶åè¾“å‡ºå½“å‰å·²å¤„ç†çš„æ—¶é•¿ã€‚è¦è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯”ï¼Œæ‚¨éœ€è¦è¿™ä¸¤ä¸ªå€¼ã€‚

è¦å®ç°è¿™ä¸€ç‚¹ï¼Œæ‚¨å¯ä»¥å°†æ”¶é›†åˆ°çš„è¾“å‡ºä¼ é€’ç»™è§£æå™¨ã€‚åœ¨éšä¹¦é™„å¸¦çš„æºä»£ç ä¸­ï¼Œæœ‰ä¸€ä¸ªåä¸º`concurrent/qrunnable_process_parser_elapsed.py` çš„ç¤ºä¾‹ï¼Œæ¼”ç¤ºäº†è¿™ä¸€è¿‡ç¨‹ã€‚

### ç®¡ç†å™¨

åœ¨ä¹‹å‰çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†å¤šä¸ªä¸åŒçš„ `QRunnable` å®ç°ï¼Œè¿™äº›å®ç°å¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¸­ç”¨äºä¸åŒç›®çš„ã€‚åœ¨æ‰€æœ‰æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥æ ¹æ®éœ€è¦åœ¨åŒä¸€ä¸ªæˆ–å¤šä¸ª `QThreadPool` çº¿ç¨‹æ± ä¸­è¿è¡Œä»»æ„æ•°é‡çš„è¿™äº›çº¿ç¨‹ã€‚ç„¶è€Œï¼Œæœ‰æ—¶æ‚¨å¯èƒ½éœ€è¦è·Ÿè¸ªæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ï¼Œä»¥ä¾¿å¤„ç†å®ƒä»¬çš„è¾“å‡ºï¼Œæˆ–ç›´æ¥ä¸ºç”¨æˆ·æä¾›å¯¹çº¿ç¨‹çš„æ§åˆ¶æƒã€‚

`QThreadPool` æœ¬èº«å¹¶ä¸æä¾›è®¿é—®å½“å‰æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹çš„æ¥å£ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦è‡ªè¡Œåˆ›å»ºä¸€ä¸ªç®¡ç†å™¨ï¼Œé€šè¿‡è¯¥ç®¡ç†å™¨æ¥å¯åŠ¨å’Œæ§åˆ¶æˆ‘ä»¬çš„çº¿ç¨‹ã€‚

ä¸‹é¢çš„ç¤ºä¾‹å°†ä¹‹å‰ä»‹ç»çš„ä¸€äº›å…¶ä»–çº¿ç¨‹åŠŸèƒ½â€”â€”è¿›åº¦ã€æš‚åœå’Œåœæ­¢æ§åˆ¶â€”â€”ä¸æ¨¡å‹è§†å›¾ç»“åˆèµ·æ¥ï¼Œä»¥æ˜¾ç¤ºä¸ªåˆ«è¿›åº¦æ¡ã€‚è¿™ä¸ªç®¡ç†å™¨å¾ˆå¯èƒ½é€‚ç”¨äºæ‚¨è¿è¡Œçº¿ç¨‹çš„å¤§å¤šæ•°ç”¨ä¾‹ã€‚

![tips](tips.png)

> è¿™æ˜¯ä¸€ä¸ªç›¸å½“å¤æ‚çš„ç¤ºä¾‹ï¼Œå®Œæ•´çš„æºä»£ç å¯åœ¨ä¹¦çš„èµ„æºä¸­æ‰¾åˆ°ã€‚è¿™é‡Œæˆ‘ä»¬å°†ä¾æ¬¡ä»‹ç» `QRunnable` ç®¡ç†å™¨çš„å…³é”®éƒ¨åˆ†ã€‚

#### å·¥ä½œè¿›ç¨‹ç®¡ç†å™¨

å·¥ä½œè¿›ç¨‹ç®¡ç†å™¨ç±»ä¿å­˜çº¿ç¨‹æ± ã€æˆ‘ä»¬çš„å·¥ä½œè¿›ç¨‹åŠå…¶è¿›åº¦å’ŒçŠ¶æ€ä¿¡æ¯ã€‚å®ƒä» `QAbstractListModel` æ´¾ç”Ÿè€Œæ¥ï¼Œè¿™æ„å‘³ç€å®ƒä¹Ÿæä¾›äº†ä¸€ä¸ªç±»ä¼¼äº Qt æ¨¡å‹çš„æ¥å£ï¼Œå¯ä»¥ä½œä¸º `QListView` çš„æ¨¡å‹ä½¿ç”¨ï¼Œä¸ºæ¯ä¸ªå·¥ä½œè¿›ç¨‹æä¾›è¿›åº¦æ¡å’ŒçŠ¶æ€æŒ‡ç¤ºå™¨ã€‚çŠ¶æ€è·Ÿè¸ªé€šè¿‡è®¸å¤šå†…éƒ¨ä¿¡å·æ¥å¤„ç†ï¼Œè¿™äº›ä¿¡å·ä¼šè‡ªåŠ¨é™„åŠ åˆ°æ¯ä¸ªæ·»åŠ çš„å·¥ä½œè¿›ç¨‹ä¸Šã€‚

*Listing 199. concurrent/qrunnable_manager.py*

```python
class WorkerManager(QAbstractListModel):
    """
    ç®¡ç†å™¨ï¼Œç”¨äºå¤„ç†æˆ‘ä»¬çš„å·¥ä½œé˜Ÿåˆ—å’ŒçŠ¶æ€ã€‚
    è¿˜ä½œä¸ºè§†å›¾çš„ Qt æ•°æ®æ¨¡å‹ï¼Œæ˜¾ç¤ºæ¯ä¸ªå·¥ä½œè¿›ç¨‹çš„è¿›åº¦ã€‚
    """
    _workers = {}
    _state = {}
    status = pyqtSignal(str)
    
    def __init__(self):
        super().__init__()
        
        # ä¸ºæˆ‘ä»¬çš„å·¥ä½œè¿›ç¨‹åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± .
        self.threadpool = QThreadPool()
        # self.threadpool.setMaxThreadCount(1)
        self.max_threads = self.threadpool.maxThreadCount()
        print(
            "Multithreading with maximum %d threads" % self
            .max_threads
        )
        
        self.status_timer = QTimer()
        self.status_timer.setInterval(100)
        self.status_timer.timeout.connect(self.notify_status)
        self.status_timer.start()
        
    def notify_status(self):
        n_workers = len(self._workers)
        running = min(n_workers, self.max_threads)
        waiting = max(0, n_workers - self.max_threads)
        self.status.emit(
            "{} running, {} waiting, {} threads".format(
                running, waiting, self.max_threads
            )
        )
        
    def enqueue(self, worker):
        """
        å°†ä¸€ä¸ªå·¥ä½œè¿›ç¨‹åŠ å…¥é˜Ÿåˆ—ï¼Œä»¥ä¾¿åœ¨æŸä¸ªæ—¶é—´ç‚¹è¿è¡Œï¼Œæ–¹æ³•æ˜¯å°†å…¶ä¼ é€’ç»™ QThreadPoolã€‚
        """
        worker.signals.error.connect(self.receive_error)
        worker.signals.status.connect(self.receive_status)
        worker.signals.progress.connect(self.receive_progress)
        worker.signals.finished.connect(self.done)
        
        self.threadpool.start(worker)
        self._workers[worker.job_id] = worker
        
        # å°†é»˜è®¤çŠ¶æ€è®¾ç½®ä¸ºç­‰å¾…ï¼Œè¿›åº¦ä¸º0.
        self._state[worker.job_id] = DEFAULT_STATE.copy()
        
        self.layoutChanged.emit()
        
    def receive_status(self, job_id, status):
        self._state[job_id]["status"] = status
        self.layoutChanged.emit()
        
    def receive_progress(self, job_id, progress):
        self._state[job_id]["progress"] = progress
        self.layoutChanged.emit()
        
    def receive_error(self, job_id, message):
        print(job_id, message)
        
    def done(self, job_id):
        """
        ä»»åŠ¡/å·¥ä½œè¿›ç¨‹å·²å®Œæˆã€‚å°†å…¶ä»æ´»åŠ¨å·¥ä½œè¿›ç¨‹å­—å…¸ä¸­ç§»é™¤ã€‚
        æˆ‘ä»¬å°†å…¶ä¿ç•™åœ¨å·¥ä½œè¿›ç¨‹çŠ¶æ€ä¸­ï¼Œå› ä¸ºè¿™ç”¨äºæ˜¾ç¤ºè¿‡å»/å·²å®Œæˆçš„å·¥ä½œè¿›ç¨‹ã€‚
        """
        del self._workers[job_id]
        self.layoutChanged.emit()
        
    def cleanup(self):
        """
        ä» worker_state ä¸­ç§»é™¤æ‰€æœ‰å·²å®Œæˆæˆ–å¤±è´¥çš„å·¥ä½œè¿›ç¨‹ã€‚
        """
        for job_id, s in list(self._state.items()):
            if s["status"] in (STATUS_COMPLETE, STATUS_ERROR):
                del self._state[job_id]
        self.layoutChanged.emit()
        
    # æ¨¡å‹æ¥å£
    def data(self, index, role):
        if role == Qt.ItemDataRole.DisplayRole:
            # è¯·å‚è§ä¸‹æ–‡çš„æ•°æ®ç»“æ„.
            job_ids = list(self._state.keys())
            job_id = job_ids[index.row()]
            return job_id, self._state[job_id]
        
    def rowCount(self, index):
        return len(self._state)
```

å·¥ä½œè¿›ç¨‹åœ¨ç®¡ç†å™¨ä¹‹å¤–æ„å»ºï¼Œå¹¶é€šè¿‡ `.enqueue()` ä¼ é€’è¿›æ¥ã€‚è¿™å°†è¿æ¥æ‰€æœ‰ä¿¡å·ï¼Œå¹¶å°†å·¥ä½œè¿›ç¨‹æ·»åŠ åˆ°çº¿ç¨‹æ± ä¸­ã€‚ä¸€æ—¦æœ‰çº¿ç¨‹å¯ç”¨ï¼Œå®ƒå°±ä¼šåƒæ­£å¸¸ä¸€æ ·è¢«æ‰§è¡Œã€‚

å·¥ä½œè¿›ç¨‹å­˜å‚¨åœ¨å†…éƒ¨å­—å…¸ `_workers`ä¸­ï¼Œè¯¥å­—å…¸ä»¥ä»»åŠ¡IDä¸ºé”®ã€‚æœ‰ä¸€ä¸ªç‹¬ç«‹çš„å­—å…¸ `_state`ï¼Œç”¨äºå­˜å‚¨å·¥ä½œè¿›ç¨‹çš„çŠ¶æ€å’Œè¿›åº¦ä¿¡æ¯ã€‚æˆ‘ä»¬å°†å…¶åˆ†ç¦»å­˜å‚¨ï¼Œä»¥ä¾¿åœ¨ä»»åŠ¡å®Œæˆååˆ é™¤ä»»åŠ¡ï¼Œä¿æŒå‡†ç¡®çš„è®¡æ•°ï¼ŒåŒæ—¶ç»§ç»­æ˜¾ç¤ºå·²å®Œæˆä»»åŠ¡çš„ä¿¡æ¯ï¼Œç›´åˆ°æ¸…é™¤

æ¯ä¸ªæäº¤çš„å·¥ä½œè€…çš„ä¿¡å·éƒ½è¿æ¥åˆ°ç®¡ç†å™¨çš„æ§½ä¸Šï¼Œè¿™äº›æ§½æ›´æ–° `_state` å­—å…¸ã€æ‰“å°é”™è¯¯æ¶ˆæ¯æˆ–åˆ é™¤å·²å®Œæˆçš„å·¥ä½œã€‚ä¸€æ—¦ä»»ä½•çŠ¶æ€è¢«æ›´æ–°ï¼Œæˆ‘ä»¬å¿…é¡»è°ƒç”¨ `.layoutChanged()` æ¥è§¦å‘æ¨¡å‹è§†å›¾çš„åˆ·æ–°ã€‚ `_clear_` æ–¹æ³•éå† `\_state` åˆ—è¡¨ï¼Œå¹¶åˆ é™¤ä»»ä½•å·²å®Œæˆæˆ–å¤±è´¥çš„é¡¹ç›®ã€‚

æœ€åï¼Œæˆ‘ä»¬è®¾ç½®äº†ä¸€ä¸ªå®šæ—¶å™¨ï¼Œå®šæœŸè§¦å‘ä¸€ä¸ªæ–¹æ³•ï¼Œå°†å½“å‰çº¿ç¨‹æ•°ä½œä¸ºçŠ¶æ€æ¶ˆæ¯è¾“å‡ºã€‚æ´»åŠ¨çº¿ç¨‹æ•°æ˜¯ `_workers` å’Œ `max_threads` ä¸­çš„è¾ƒå°å€¼ã€‚ç­‰å¾…çº¿ç¨‹æ•°æ˜¯ `_workers` å‡å» `max_threads`ï¼ˆåªè¦å¤§äºé›¶ï¼‰ã€‚è¯¥æ¶ˆæ¯æ˜¾ç¤ºåœ¨ä¸»çª—å£çš„çŠ¶æ€æ ä¸Šã€‚

#### å·¥ä½œè¿›ç¨‹

è¯¥å·¥ä½œè¿›ç¨‹æœ¬èº«ä¸æˆ‘ä»¬ä¹‹å‰çš„æ‰€æœ‰ç¤ºä¾‹éµå¾ªç›¸åŒçš„æ¨¡å¼ã€‚æˆ‘ä»¬ç®¡ç†å™¨çš„å”¯ä¸€è¦æ±‚æ˜¯æ·»åŠ ä¸€ä¸ª `.job_id` å±æ€§ï¼Œè¯¥å±æ€§åœ¨åˆ›å»ºå·¥ä½œè¿›ç¨‹æ—¶è®¾ç½®ã€‚

å·¥ä½œè¿›ç¨‹çš„ä¿¡å·å¿…é¡»åŒ…å«æ­¤å·¥ä½œ IDï¼Œä»¥ä¾¿ç®¡ç†å™¨çŸ¥é“å“ªä¸ªå·¥ä½œè¿›ç¨‹å‘é€äº†ä¿¡å·â€”â€”æ›´æ–°æ­£ç¡®çš„çŠ¶æ€ã€è¿›åº¦å’Œå®ŒæˆçŠ¶æ€ã€‚

è¯¥å·¥ä½œè¿›ç¨‹æœ¬èº«æ˜¯ä¸€ä¸ªç®€å•çš„å ä½ç¬¦å·¥ä½œè¿›ç¨‹ï¼Œå®ƒä¼šè¿­ä»£100æ¬¡ï¼ˆæ¯æ¬¡è¿­ä»£å¯¹åº”1%çš„è¿›åº¦ï¼‰ï¼Œå¹¶æ‰§è¡Œä¸€ä¸ªç®€å•çš„è®¡ç®—ã€‚è¯¥å·¥ä½œè¿›ç¨‹çš„è®¡ç®—ä¼šç”Ÿæˆä¸€ç³»åˆ—æ•°å­—ï¼Œä½†å…¶è®¾è®¡ä¼šå¶å°”æŠ›å‡ºé™¤ä»¥é›¶çš„é”™è¯¯ã€‚

*Listing 200. concurrent/qrunnable_manager.py*

```python
class WorkerSignals(QObject):
    """
    å®šä¹‰è¿è¡Œä¸­çš„å·¥ä½œçº¿ç¨‹å¯ç”¨çš„ä¿¡å·ã€‚
    æ”¯æŒçš„ä¿¡å·ä¸ºï¼š
    finished
        æ²¡æœ‰æ•°æ®
    
    error
        `å…ƒç»„` (exctype, value, traceback.format_exc() )
        
    result
        `object` data returned from processing, anything
        
    progress
        `int` indicating % progress
    """
    error = pyqtSignal(str, str)
    result = pyqtSignal(str, object) # æˆ‘ä»¬å¯ä»¥è¿”å›ä»»ä½•ä¸œè¥¿.
    
    finished = pyqtSignal(str)
    progress = pyqtSignal(str, int)
    status = pyqtSignal(str, str)
    
    
class Worker(QRunnable):
    """
    å·¥ä½œçº¿ç¨‹
    ä» QRunnable ç»§æ‰¿ï¼Œç”¨äºå¤„ç†å·¥ä½œçº¿ç¨‹çš„è®¾ç½®ã€ä¿¡å·å’Œæ”¶å°¾å·¥ä½œã€‚
    
    :param args: éœ€è¦ä¼ é€’ç»™å·¥ä½œè¿›ç¨‹çš„å‚æ•°
    :param kwargs: éœ€è¦ä¼ é€’ç»™å·¥ä½œè¿›ç¨‹çš„å…³é”®å­—
    
    """
    
    def __init__(self, *args, **kwargs):
        super().__init__()
        
        # å­˜å‚¨æ„é€ å‡½æ•°å‚æ•°ï¼ˆç”¨äºåç»­å¤„ç†ï¼‰.
        self.signals = WorkerSignals()
        
        # ä¸ºè¿™ä¸ªä»»åŠ¡åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†ç¬¦.
        self.job_id = str(uuid.uuid4())
        
        # å·¥ä½œè¿›ç¨‹çš„å‚æ•°
        self.args = args
        self.kwargs = kwargs
        
        self.signals.status.emit(self.job_id, STATUS_WAITING)
        
    @pyqtSlot()
    def run(self):
        """
        ä½¿ç”¨ä¼ å…¥çš„å‚æ•°å’Œå…³é”®å­—å‚æ•°åˆå§‹åŒ–è¿è¡Œå™¨å‡½æ•°ã€‚
        """
        
        self.signals.status.emit(self.job_id, STATUS_RUNNING)
        
        x, y = self.args
        
        try:
            value = random.randint(0, 100) * x
            delay = random.random() / 10
            result = []
            
            for n in range(100):
                # ç”Ÿæˆä¸€äº›æ•°å­—.
                value = value / y
                y -= 1
                
                # ä»¥ä¸‹æƒ…å†µæœ‰æ—¶ä¼šå¼•å‘é™¤ä»¥é›¶é”™è¯¯
                result.append(value)
                
                # åˆ†å‘å½“å‰è¿›å±•æƒ…å†µ.
                self.signals.progress.emit(self.job_id, n + 1)
                time.sleep(delay)
                
        except Exception as e:
            print(e)
            # æˆ‘ä»¬å¿½ç•¥äº†è¿™ä¸ªé”™è¯¯ï¼Œç»§ç»­å‰è¿›.
            self.signals.error.emit(self.job_id, str(e))
            self.signals.status.emit(self.job_id, STATUS_ERROR)
            
        else:
            self.signals.result.emit(self.job_id, result)
            self.signals.status.emit(self.job_id, STATUS_COMPLETE)
            
        self.signals.finished.emit(self.job_id)
```

é™¤äº†ä¹‹å‰çœ‹åˆ°çš„è¿›åº¦ä¿¡å·å¤–ï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªçŠ¶æ€ä¿¡å·ï¼Œå®ƒä¼šå‘å‡ºä»¥ä¸‹çŠ¶æ€ä¹‹ä¸€ã€‚å¼‚å¸¸è¢«æ•è·ï¼Œå¼‚å¸¸æ–‡æœ¬å’Œé”™è¯¯çŠ¶æ€éƒ½ä¼šé€šè¿‡é”™è¯¯å’ŒçŠ¶æ€å‘å‡ºã€‚

*Listing 201. concurrent/qrunnable_manager.py*

```python
STATUS_WAITING = "waiting"
STATUS_RUNNING = "running"
STATUS_ERROR = "error"
STATUS_COMPLETE = "complete"


STATUS_COLORS = {
    STATUS_RUNNING: "#33a02c",
    STATUS_ERROR: "#e31a1c",
    STATUS_COMPLETE: "#b2df8a",
}

DEFAULT_STATE = {"progress": 0, "status": STATUS_WAITING}
```

æ¯ä¸ªæ´»åŠ¨çŠ¶æ€éƒ½åˆ†é…äº†é¢œè‰²ï¼Œè¿™äº›é¢œè‰²å°†åœ¨ç»˜åˆ¶è¿›åº¦æ¡æ—¶ä½¿ç”¨ã€‚

#### è‡ªå®šä¹‰è¡Œæ˜¾ç¤º

æˆ‘ä»¬ä½¿ç”¨ `QListView` æ¥æ˜¾ç¤ºè¿›åº¦æ¡ã€‚é€šå¸¸ï¼Œåˆ—è¡¨è§†å›¾ä¼šæ˜¾ç¤ºæ¯è¡Œç®€å•çš„æ–‡æœ¬å€¼ã€‚ä¸ºäº†ä¿®æ”¹è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬ä½¿ç”¨ `QItemDelegate`ï¼Œå®ƒå…è®¸æˆ‘ä»¬ä¸ºæ¯è¡Œç»˜åˆ¶è‡ªå®šä¹‰æ§ä»¶ã€‚

*Listing 202. concurrent/qrunnable_manager.py*

```python
class ProgressBarDelegate(QStyledItemDelegate):
    def paint(self, painter, option, index):
        # data æ˜¯æˆ‘ä»¬çŠ¶æ€å­—å…¸ï¼ŒåŒ…å«è¿›åº¦ã€ID å’ŒçŠ¶æ€ã€‚
        job_id, data = index.model().data(
            index, Qt.ItemDataRole.DisplayRole
        )
        if data["progress"] > 0:
            color = QColor(STATUS_COLORS[data["status"]])
            
            brush = QBrush()
            brush.setColor(color)
            brush.setStyle(Qt.BrushStyle.SolidPattern)
            
            width = option.rect.width() * data["progress"] / 100
            
            rect = QRect(
                option.rect
            ) # rect çš„å‰¯æœ¬ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥è¿›è¡Œä¿®æ”¹ã€‚.
            rect.setWidth(width)
            
            painter.fillRect(rect, brush)
            
        pen = QPen()
        pen.setColor(Qt.GlobalColor.black)
        painter.drawText(
            option.rect, Qt.AlignmentFlag.AlignLeft, job_id
        )
```

æˆ‘ä»¬ä»æ¨¡å‹ä¸­è·å–å½“å‰è¡Œçš„æ•°æ®ï¼Œä½¿ç”¨ `index.model().data(index,Qt.ItemDataRole.DisplayRole)` ã€‚è¿™è°ƒç”¨äº† `.data()` æ–¹æ³•ï¼Œä¼ å…¥ç´¢å¼•å’Œè§’è‰²ã€‚åœ¨æˆ‘ä»¬çš„ `.data()` æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬è¿”å›ä¸¤éƒ¨åˆ†æ•°æ®â€”â€” `job_id` å’ŒçŠ¶æ€å­—å…¸ï¼Œå…¶ä¸­åŒ…å« `progress` å’Œ `status` é”®ã€‚

å¯¹äºæ´»è·ƒä»»åŠ¡ï¼ˆ`progress > 0`ï¼‰ï¼ŒçŠ¶æ€ç”¨äºä¸ºæ¡å½¢å›¾é€‰æ‹©é¢œè‰²ã€‚è¯¥æ¡å½¢å›¾ä»¥é¡¹è¡Œå¤§å° `option.rect()` ç»˜åˆ¶ä¸ºçŸ©å½¢ï¼Œå®½åº¦æ ¹æ®å®Œæˆç™¾åˆ†æ¯”è°ƒæ•´ã€‚æœ€åï¼Œæˆ‘ä»¬åœ¨æ¡å½¢å›¾é¡¶éƒ¨æ˜¾ç¤º `job_id` æ–‡æœ¬ã€‚

#### å¼€å§‹ä¸€ä¸ªä»»åŠ¡

ä¸€åˆ‡å°±ç»ªåï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥é€šè¿‡è°ƒç”¨`.self.worker.enqueue()` å¹¶å‘å·¥ä½œè¿›ç¨‹ä¼ é€’å‚æ•°æ¥æ’é˜Ÿä»»åŠ¡ã€‚

*Listing 203. concurrent/qrunnable_manager.py*

```python
    def start_worker(self):
        x = random.randint(0, 1000)
        y = random.randint(0, 1000)
        
        w = Worker(x, y)
        w.signals.result.connect(self.display_result)
        w.signals.error.connect(self.display_result)
        
        self.workers.enqueue(w)
```

`.enqueue()` æ–¹æ³•æ¥å—ä¸€ä¸ªæ„é€ çš„å·¥ä½œè¿›ç¨‹ï¼Œå¹¶å°†å†…éƒ¨ä¿¡å·é™„åŠ åˆ°å®ƒä»¥è·Ÿè¸ªè¿›åº¦ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬ä»ç„¶å¯ä»¥é™„åŠ ä»»ä½•å…¶ä»–æˆ‘ä»¬æƒ³è¦çš„å¤–éƒ¨ä¿¡å·ã€‚

![Figure209](Figure209.png)

> å›¾209ï¼šç®¡ç†å™¨ç•Œé¢ï¼Œæ‚¨å¯ä»¥åœ¨è¿™é‡Œå¯åŠ¨æ–°ä»»åŠ¡å¹¶æŸ¥çœ‹è¿›åº¦ã€‚

æ­¤å¤–ï¼Œè™½ç„¶æ­¤ç¤ºä¾‹åªæœ‰ä¸€ä¸ªå·¥ä½œè¿›ç¨‹ç±»ï¼Œä½†åªè¦å…¶ä»–ä» `QRunnable` æ´¾ç”Ÿçš„ç±»å…·æœ‰ç›¸åŒçš„ä¿¡å·ï¼Œæ‚¨å°±å¯ä»¥ä½¿ç”¨ç›¸åŒçš„ç®¡ç†å™¨ã€‚è¿™æ„å‘³ç€æ‚¨å¯ä»¥ä½¿ç”¨ä¸€ä¸ªå·¥ä½œè¿›ç¨‹ç®¡ç†å™¨æ¥ç®¡ç†åº”ç”¨ç¨‹åºä¸­çš„æ‰€æœ‰å·¥ä½œè¿›ç¨‹ã€‚

![tips](tips.png)

> æ‚¨å¯ä»¥æŸ¥çœ‹æœ¬ä¹¦ä¸­çš„æºæ–‡ä»¶ä»¥è·å–å®Œæ•´ä»£ç ï¼Œå¹¶å°è¯•æ ¹æ®éœ€è¦ä¿®æ”¹ç®¡ç†å™¨â€”â€”ä¾‹å¦‚ï¼Œé€šç”¨å‡½æ•°è¿è¡Œå™¨å°è¯•æ·»åŠ å¼ºåˆ¶ç»“æŸå’Œæš‚åœåŠŸèƒ½

#### ç»“æŸä»»åŠ¡

æˆ‘ä»¬å¯ä»¥å¯åŠ¨ä»»åŠ¡ï¼Œå…¶ä¸­ä¸€äº›ä»»åŠ¡å¯èƒ½ä¼šå› é”™è¯¯è€Œç»ˆæ­¢ã€‚ä½†å¦‚æœæˆ‘ä»¬æƒ³åœæ­¢é‚£äº›è€—æ—¶è¿‡é•¿çš„ä»»åŠ¡å‘¢ï¼Ÿ`QListView` å…è®¸æˆ‘ä»¬é€‰æ‹©è¡Œï¼Œå¹¶é€šè¿‡é€‰ä¸­çš„è¡Œç»ˆæ­¢ç‰¹å®šçš„å·¥ä½œè¿›ç¨‹ã€‚ä¸‹é¢çš„æ–¹æ³•ä¸ä¸€ä¸ªæŒ‰é’®å…³è”ï¼Œå¹¶ä»åˆ—è¡¨ä¸­å½“å‰é€‰ä¸­çš„é¡¹ä¸­æŸ¥æ‰¾å·¥ä½œè¿›ç¨‹ã€‚

*Listing 204. concurrent/qrunnable_manager_stop.py*

```python
    def stop_worker(self):
        selected = self.progress.selectedIndexes()
        for idx in selected:
            job_id, _ = self.workers.data(
                idx, Qt.ItemDataRole.DisplayRole
            )
            self.workers.kill(job_id)
```

é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¿®æ”¹å§”æ‰˜ä»¥ç»˜åˆ¶å½“å‰é€‰ä¸­çš„é¡¹ï¼Œå¹¶æ›´æ–°å·¥ä½œè¿›ç¨‹å’Œç®¡ç†å™¨ä»¥ä¼ é€’å¼ºåˆ¶ç»“æŸä¿¡å·ã€‚è¯·æŸ¥çœ‹æ­¤ç¤ºä¾‹çš„å®Œæ•´æºä»£ç ï¼Œäº†è§£å®ƒä»¬æ˜¯å¦‚ä½•é…åˆåœ¨ä¸€èµ·çš„ã€‚

![Figure210](Figure210.png)

> å›¾210ï¼šç®¡ç†å™¨ï¼Œæ‚¨å¯ä»¥é€‰æ‹©ä¸€ä¸ªä»»åŠ¡æ¥åœæ­¢å®ƒã€‚

## 27. é•¿æœŸè¿è¡Œçš„çº¿ç¨‹

åœ¨è¿„ä»Šä¸ºæ­¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä¸€ç›´ä½¿ç”¨ `QRunnable` å¯¹è±¡æ¥ä½¿ç”¨ `QThreadPool` æ‰§è¡Œä»»åŠ¡ã€‚æˆ‘ä»¬æäº¤çš„ä»»åŠ¡ç”±çº¿ç¨‹æ± æŒ‰é¡ºåºå¤„ç†ï¼Œæœ€å¤§å¹¶å‘æ•°ç”±çº¿ç¨‹æ± é™åˆ¶ã€‚

ä½†æ˜¯ï¼Œå¦‚æœæ‚¨å¸Œæœ›æŸä¸ªä»»åŠ¡ç«‹å³æ‰§è¡Œï¼Œè€Œä¸å—å…¶ä»–ä»»åŠ¡çš„å½±å“ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿæˆ–è€…ï¼Œæ‚¨å¯èƒ½å¸Œæœ›åœ¨åº”ç”¨ç¨‹åºè¿è¡ŒæœŸé—´å§‹ç»ˆåœ¨åå°ä¿æŒä¸€ä¸ªçº¿ç¨‹è¿è¡Œï¼Œä»¥ä¸æŸä¸ªè¿œç¨‹æœåŠ¡æˆ–ç¡¬ä»¶äº¤äº’ï¼Œæˆ–ä¼ è¾“æ•°æ®è¿›è¡Œå¤„ç†ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œçº¿ç¨‹æ± æ¶æ„å¯èƒ½å¹¶ä¸åˆé€‚ã€‚

åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ¢è®¨ PyQt6 çš„æŒä¹…çº¿ç¨‹æ¥å£ `QThread`ã€‚å®ƒä¸æ‚¨å·²ç»è§è¿‡çš„ `QRunnable` å¯¹è±¡æä¾›äº†éå¸¸ç›¸ä¼¼çš„æ¥å£ï¼Œä½†å…è®¸æ‚¨å®Œå…¨æ§åˆ¶çº¿ç¨‹çš„è¿è¡Œæ—¶é—´å’Œæ–¹å¼ã€‚

### ä½¿ç”¨ `QThread`

ä¸ `QRunnable` ç¤ºä¾‹ä¸€æ ·ï¼Œ`QThread` ç±»å……å½“äº†æ‚¨æƒ³è¦åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œçš„ä»£ç çš„åŒ…è£…å™¨ã€‚å®ƒè´Ÿè´£å¯åŠ¨å’Œå°†å·¥ä½œè½¬ç§»åˆ°å•ç‹¬çš„çº¿ç¨‹ï¼Œä»¥åŠåœ¨çº¿ç¨‹å®Œæˆåè¿›è¡Œç®¡ç†å’Œå…³é—­ã€‚æ‚¨åªéœ€æä¾›è¦æ‰§è¡Œçš„ä»£ç å³å¯ã€‚è¿™å¯ä»¥é€šè¿‡å­ç±»åŒ– `QThread` å¹¶å®ç° `run()` æ–¹æ³•æ¥å®Œæˆã€‚

#### ä¸€ä¸ªç®€å•çš„çº¿ç¨‹

è®©æˆ‘ä»¬ä»ä¸€ä¸ªç®€å•çš„ä¾‹å­å¼€å§‹ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œå®ƒå¯ä»¥ä¸ºæˆ‘ä»¬æ‰§è¡Œç®—æœ¯è¿ç®—ã€‚æˆ‘ä»¬ä¸ºè¯¥çº¿ç¨‹æ·»åŠ äº†ä¸€ä¸ªä¿¡å·ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒå°†æ•°æ®ä»çº¿ç¨‹ä¸­å‘é€å‡ºå»ã€‚

*Listing 205. concurrent/qthread_1.py*

```python
import sys
import time

from PyQt6.QtCore import QThread, pyqtSignal, pyqtSlot
from PyQt6.QtWidgets import QApplication, QLabel, QMainWindow


class Thread(QThread):
    """
    å·¥ä½œçº¿ç¨‹
    """
    
    result = pyqtSignal(str) #1
    
    @pyqtSlot()
    def run(self):
        """
        æ‚¨çš„ä»£ç åº”æ”¾ç½®åœ¨æ­¤æ–¹æ³•ä¸­
        """
        print("Thread start")
        counter = 0
        while True:
            time.sleep(0.1)
            # å°†æ•°å­—ä»¥æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„å½¢å¼è¾“å‡º.
            self.result.emit(f"The number is {counter}")
            counter += 1
        print("Thread complete")
        
        
class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        
        # åˆ›å»ºçº¿ç¨‹å¹¶å¯åŠ¨å®ƒ.
        self.thread = Thread()
        self.thread.start() #2
        
        label = QLabel("Output will appear here")
        
        # è¿æ¥ä¿¡å·ï¼Œè¿™æ ·è¾“å‡ºå°±ä¼šå‡ºç°åœ¨æ ‡ç­¾ä¸Š.
        self.thread.result.connect(label.setText)
        
        self.setCentralWidget(label)
        self.show()
        
        
app = QApplication(sys.argv)
window = MainWindow()
app.exec()
```

> 1. ä¸ `QRunnable` ä¸åŒï¼Œ`QThread` ç±»ç»§æ‰¿è‡ª `QObject`ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨çº¿ç¨‹å¯¹è±¡æœ¬èº«å®šä¹‰ä¿¡å·ã€‚
> 2. è°ƒç”¨ `.start()` è€Œä¸æ˜¯ `.run()` æ¥å¯åŠ¨çº¿ç¨‹ï¼

è¿è¡Œæ­¤ç¤ºä¾‹åï¼Œæ‚¨å°†åœ¨çª—å£ä¸­çœ‹åˆ°ä¸€ä¸ªå‘ä¸Šè®¡æ•°çš„æ•°å­—ã€‚è¿™çœ‹èµ·æ¥å¹¶ä¸

è¿™çœŸçš„å¤ªä»¤äººå…´å¥‹å•¦ï¼ä½†è®¡æ•°æ˜¯åœ¨ä¸å›¾å½¢ç”¨æˆ·ç•Œé¢ç‹¬ç«‹çš„çº¿ç¨‹ä¸­è¿›è¡Œçš„ï¼Œç»“æœæ˜¯é€šè¿‡ä¿¡å·è¾“å‡ºçš„ã€‚è¿™æ„å‘³ç€å›¾å½¢ç”¨æˆ·ç•Œé¢ä¸ä¼šè¢«æ­£åœ¨è¿›è¡Œçš„å·¥ä½œé˜»å¡ï¼ˆå°½ç®¡æ­£å¸¸çš„ Python GIL è§„åˆ™ä»ç„¶é€‚ç”¨ï¼‰ã€‚

![Figure211](Figure211.png)

> å›¾211ï¼šé€šè¿‡ä¿¡å·æ˜¾ç¤ºç»“æœçš„ QThread è®¡æ•°å™¨

æ‚¨å¯ä»¥å°è¯•å¢åŠ  `sleep()` è°ƒç”¨çš„æŒç»­æ—¶é—´ï¼Œæ‚¨åº”è¯¥ä¼šå‘ç°ï¼Œå³ä½¿çº¿ç¨‹è¢«é˜»å¡ï¼Œä¸»å›¾å½¢ç”¨æˆ·ç•Œé¢ä»ç„¶æ­£å¸¸è¿è¡Œã€‚

![tips](tips.png)

> å¦‚æœæ‚¨é€šå¸¸ä½¿ç”¨ `numpy` æˆ–å…¶ä»–åº“ï¼Œå¯ä»¥å°è¯•ä½¿ç”¨å®ƒä»¬åœ¨çº¿ç¨‹ä¸­è¿›è¡Œæ›´å¤æ‚çš„è®¡ç®—ã€‚

![information](information.png)

> é€šå¸¸æ‚¨ä¼šå¸Œæœ›åœ¨çº¿ç¨‹ä¸­æ·»åŠ æŸç§ä¿¡å·ä»¥å®ç°é€šä¿¡ã€‚

#### çº¿ç¨‹æ§åˆ¶

ç°åœ¨æˆ‘ä»¬å¯ä»¥å¯åŠ¨çº¿ç¨‹ï¼Œä½†æ— æ³•åœæ­¢å®ƒã€‚ä¸ `QRunnable` ä¸åŒï¼Œ`QThread` ç±»å†…ç½®äº† `.terminate()` æ–¹æ³•ï¼Œå¯ç”¨äºç«‹å³ç»ˆæ­¢æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ã€‚è¿™å¹¶éå¹²å‡€çš„å…³é—­æ“ä½œâ€”â€”çº¿ç¨‹å°†ç›´æ¥åœæ­¢å½“å‰æ‰§è¡Œä½ç½®ï¼Œä¸”ä¸ä¼šæŠ›å‡º Python å¼‚å¸¸ã€‚

*Listing 206. concurrent/qthread_2.py*

```python
class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        
        # åˆ›å»ºçº¿ç¨‹å¹¶å¯åŠ¨å®ƒ.
        self.thread = Thread()
        self.thread.start()
        
        label = QLabel("Output will appear here")
        button = QPushButton("Kill thread")
        # ç»ˆæ­¢ï¼ˆç«‹å³æ€æ­»ï¼‰çº¿ç¨‹.
        button.pressed.connect(self.thread.terminate)
        
        # è¿æ¥ä¿¡å·ï¼Œè¿™æ ·è¾“å‡ºå°±ä¼šå‡ºç°åœ¨æ ‡ç­¾ä¸Š.
        self.thread.result.connect(label.setText)
        container = QWidget()
        layout = QVBoxLayout()
        layout.addWidget(label)
        layout.addWidget(button)
        container.setLayout(layout)
        
        self.setCentralWidget(container)
        self.show()
```

å¦‚æœæ‚¨è¿è¡Œè¿™ä¸ªç¨‹åºï¼Œæ‚¨ä¼šå‘ç°æˆ‘ä»¬åœ¨çº¿ç¨‹ä¸»å¾ªç¯åæ·»åŠ çš„â€œçº¿ç¨‹å®Œæˆâ€æ¶ˆæ¯ä»æœªæ˜¾ç¤ºã€‚è¿™æ˜¯å› ä¸ºå½“æˆ‘ä»¬è°ƒç”¨ `.terminate()` æ—¶ï¼Œæ‰§è¡Œè¿‡ç¨‹ä¼šç«‹å³åœæ­¢ï¼Œå¹¶ä¸”æ°¸è¿œä¸ä¼šåˆ°è¾¾ä»£ç ä¸­çš„é‚£ä¸ªä½ç½®ã€‚

![Figure212](Figure212.png)

> å›¾212ï¼šå¯ä»¥é€šè¿‡æŒ‰é’®æ§åˆ¶æ¥ç»ˆæ­¢è¯¥çº¿ç¨‹ã€‚

ç„¶è€Œï¼Œ`QThread` æœ‰ä¸€ä¸ªå®Œæˆä¿¡å·ï¼Œå¯ç”¨äºåœ¨çº¿ç¨‹å®Œæˆåè§¦å‘æŸäº›åŠ¨ä½œã€‚æ— è®ºçº¿ç¨‹æ˜¯ç»ˆæ­¢è¿˜æ˜¯æ­£å¸¸å…³é—­ï¼Œè¯¥ä¿¡å·éƒ½ä¼šè¢«è§¦å‘ã€‚

çº¿ç¨‹å¯¹è±¡åœ¨çº¿ç¨‹å®Œæˆè¿è¡Œåä»ä¼šä¿ç•™ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®ƒæ¥æŸ¥è¯¢çº¿ç¨‹çŠ¶æ€ã€‚ç„¶è€Œï¼Œè¯·æ³¨æ„â€”â€”å¦‚æœçº¿ç¨‹è¢«ç»ˆæ­¢ï¼Œä¸çº¿ç¨‹å¯¹è±¡äº¤äº’å¯èƒ½ä¼šå¯¼è‡´æ‚¨çš„åº”ç”¨ç¨‹åºå´©æºƒã€‚ä¸‹é¢çš„ç¤ºä¾‹é€šè¿‡å°è¯•åœ¨çº¿ç¨‹è¢«ç»ˆæ­¢åæ‰“å°ä¸€äº›å…³äºçº¿ç¨‹å¯¹è±¡çš„ä¿¡æ¯æ¥æ¼”ç¤ºè¿™ä¸€ç‚¹ã€‚

*Listing 207. concurrent/qthread_2b.py*

```python
class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        
        # åˆ›å»ºçº¿ç¨‹å¹¶å¯åŠ¨å®ƒ.
        self.thread = Thread()
        self.thread.start()
        
        label = QLabel("Output will appear here")
        button = QPushButton("Kill thread")
        # ç»ˆæ­¢ï¼ˆç«‹å³æ€æ­»ï¼‰çº¿ç¨‹.
        button.pressed.connect(self.thread.terminate)
        
        # è¿æ¥ä¿¡å·ï¼Œè¿™æ ·è¾“å‡ºå°±ä¼šå‡ºç°åœ¨æ ‡ç­¾ä¸Š.
        self.thread.result.connect(label.setText)
        self.thread.finished.connect(self.thread_has_finished) #1
        
        container = QWidget()
        layout = QVBoxLayout()
        layout.addWidget(label)
        layout.addWidget(button)
        container.setLayout(layout)
        
        self.setCentralWidget(container)
        self.show()
        
    def thread_has_finished(self):
        print("Thread has finished.")
        print(
            self.thread,
            self.thread.isRunning(),
            self.thread.isFinished(),
        ) #2
```



> 1. å°†å®Œæˆçš„ä¿¡å·è¿æ¥åˆ°æˆ‘ä»¬çš„è‡ªå®šä¹‰æ§½ã€‚
> 2. å¦‚æœæ‚¨ç»ˆæ­¢çº¿ç¨‹ï¼Œæ‚¨çš„åº”ç”¨ç¨‹åºå¾ˆå¯èƒ½ä¼šåœ¨æ­¤å¤„å´©æºƒã€‚

è™½ç„¶æ‚¨å¯ä»¥ä»å†…éƒ¨ç»ˆæ­¢ä¸€ä¸ªçº¿ç¨‹ï¼Œä½†æ›´å¹²å‡€åˆ©è½çš„åšæ³•æ˜¯ä» `run()` æ–¹æ³•ä¸­è¿”å›ã€‚ä¸€æ—¦æ‚¨é€€å‡º `run()` æ–¹æ³•ï¼Œçº¿ç¨‹å°±ä¼šè‡ªåŠ¨ç»“æŸå¹¶è¢«å®‰å…¨åœ°æ¸…ç†ï¼Œå¹¶ä¸”å®Œæˆä¿¡å·ä¼šè§¦å‘ã€‚

*Listing 208. concurrent/qthread_2c.py*

```python
class Thread(QThread):
    """
    å·¥ä½œçº¿ç¨‹
    """
    
    result = pyqtSignal(str) #1
    
    @pyqtSlot()
    def run(self):
        """
        æ‚¨çš„ä»£ç åº”æ”¾ç½®åœ¨æ­¤æ–¹æ³•ä¸­
        """
        print("Thread start")
        counter = 0
        while True:
            time.sleep(0.1)
            # å°†æ•°å­—ä»¥æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„å½¢å¼è¾“å‡º.
            self.result.emit(f"The number is {counter}")
            counter += 1
            if counter > 50:
                return #1
```

> 1. åœ¨ `run()` æ–¹æ³•ä¸­è°ƒç”¨ `return` å°†é€€å‡ºå¹¶ç»ˆæ­¢çº¿ç¨‹ã€‚

å½“æ‚¨è¿è¡Œä¸Šè¿°ç¤ºä¾‹æ—¶ï¼Œè®¡æ•°å™¨å°†åœ¨ 50 å¤„åœæ­¢ï¼Œå› ä¸ºæˆ‘ä»¬ä» run() æ–¹æ³•è¿”å›ã€‚å¦‚æœåœ¨æ­¤ä¹‹åå°è¯•æŒ‰ä¸‹ç»ˆæ­¢æŒ‰é’®ï¼Œè¯·æ³¨æ„ï¼Œæ‚¨ä¸ä¼šå†æ¬¡æ”¶åˆ°çº¿ç¨‹å®Œæˆä¿¡å·â€”â€”çº¿ç¨‹å·²ç»å…³é—­ï¼Œå› æ­¤æ— æ³•ç»ˆæ­¢ã€‚

#### å‘é€æ•°æ®

åœ¨å‰ä¸€ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬çš„çº¿ç¨‹æ­£åœ¨è¿è¡Œï¼Œä½†æ— æ³•æ¥æ”¶ä»»ä½•æ¥è‡ªå¤–éƒ¨çš„æ•°æ®ã€‚é€šå¸¸ï¼Œå½“æ‚¨ä½¿ç”¨é•¿æ—¶é—´è¿è¡Œçš„çº¿ç¨‹æ—¶ï¼Œæ‚¨ä¼šå¸Œæœ›èƒ½å¤Ÿä¸å®ƒä»¬è¿›è¡Œé€šä¿¡ï¼Œæ— è®ºæ˜¯ä¸ºäº†ä¼ é€’å·¥ä½œï¼Œè¿˜æ˜¯ä»¥å…¶ä»–æ–¹å¼æ§åˆ¶å®ƒä»¬çš„è¡Œä¸ºã€‚

æˆ‘ä»¬ä¸€ç›´åœ¨è®¨è®ºå¦‚ä½•å¹²å‡€åœ°å…³é—­çº¿ç¨‹çš„é‡è¦æ€§ã€‚é‚£ä¹ˆï¼Œè®©æˆ‘ä»¬å…ˆçœ‹çœ‹å¦‚ä½•ä¸çº¿ç¨‹é€šä¿¡ï¼Œå‘Šè¯‰å®ƒæˆ‘ä»¬å¸Œæœ›å®ƒå…³é—­ã€‚ä¸ `QRunnable` ç¤ºä¾‹ç±»ä¼¼ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨çº¿ç¨‹ä¸­çš„ä¸€ä¸ªå†…éƒ¨æ ‡å¿—æ¥æ§åˆ¶ä¸»å¾ªç¯ï¼Œåªè¦è¯¥æ ‡å¿—ä¸º `True`ï¼Œå¾ªç¯å°±ä¼šç»§ç»­ã€‚

è¦å…³é—­çº¿ç¨‹ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹è¿™ä¸ªæ ‡å¿—çš„å€¼ã€‚ä¸‹é¢æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªåä¸º `is_running` çš„æ ‡å¿—å’Œè‡ªå®šä¹‰æ–¹æ³• `.stop()` æ¥å®ç°è¿™ä¸€ç‚¹ã€‚å½“è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ—¶ï¼Œå®ƒä¼šå°† `is_running` æ ‡å¿—è®¾ç½®ä¸º `False`ã€‚å½“æ ‡å¿—è®¾ç½®ä¸º `False` æ—¶ï¼Œä¸»å¾ªç¯å°†ç»“æŸï¼Œçº¿ç¨‹å°†é€€å‡º `run()` æ–¹æ³•ï¼Œå¹¶å…³é—­ã€‚

*Listing 209. concurrent/qthread_3.py*

```python
class Thread(QThread):
    """
    å·¥ä½œçº¿ç¨‹
    """
    result = pyqtSignal(str)
    
    @pyqtSlot()
    def run(self):
        """
        æ‚¨çš„ä»£ç åº”æ”¾ç½®åœ¨æ­¤æ–¹æ³•ä¸­ã€‚
        """
        self.data = None
        self.is_running = True
        print("Thread start")
        counter = 0
        while self.is_running:
            time.sleep(0.1)
            # å°†æ•°å­—ä»¥æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„å½¢å¼è¾“å‡º.
            self.result.emit(f"The number is {counter}")
            counter += 1
            
    def stop(self):
        self.is_running = False
```

ç„¶åæˆ‘ä»¬å¯ä»¥ä¿®æ”¹æŒ‰é’®ï¼Œä½¿å…¶è°ƒç”¨è‡ªå®šä¹‰çš„ `stop()` æ–¹æ³•ï¼Œè€Œä¸æ˜¯

*Listing 210. concurrent/qthread_3.py*

```python
        button = QPushButton("Shutdown thread")
        # ä¼˜é›…åœ°å…³é—­çº¿ç¨‹.
        button.pressed.connect(self.thread.stop)
```

ç”±äºçº¿ç¨‹å·²å¹²å‡€åœ°å…³é—­ï¼Œæˆ‘ä»¬å¯ä»¥å®‰å…¨åœ°è®¿é—®çº¿ç¨‹å¯¹è±¡ï¼Œè€Œæ— éœ€æ‹…å¿ƒå®ƒä¼šå´©æºƒã€‚è¯·æ‚¨å°†æ‰“å°è¯­å¥é‡æ–°æ·»åŠ åˆ° `thread_has_finished` æ–¹æ³•ä¸­ã€‚

*Listing 211. concurrent/qthread_3.py*

```python
    def thread_has_finished(self):
        print("Thread has finished.")
        print(
            self.thread,
            self.thread.isRunning(),
            self.thread.isFinished(),
        )
```

å¦‚æœæ‚¨è¿è¡Œè¿™ä¸ªç¨‹åºï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°æ•°å­—åƒä»¥å‰ä¸€æ ·ç»§ç»­è®¡æ•°ï¼Œä½†æŒ‰ä¸‹â€œåœæ­¢â€æŒ‰é’®ä¼šç«‹å³ç»ˆæ­¢çº¿ç¨‹ã€‚è¯·æ³¨æ„ï¼Œæˆ‘ä»¬åœ¨çº¿ç¨‹å…³é—­åä»ç„¶èƒ½å¤Ÿæ˜¾ç¤ºè¯¥çº¿ç¨‹çš„å…ƒæ•°æ®ï¼Œå› ä¸ºè¯¥çº¿ç¨‹å¹¶æœªå‘ç”Ÿå´©æºƒã€‚

![Figure213](Figure213.png)

> å›¾213ï¼šç°åœ¨å¯ä»¥ä½¿ç”¨æŒ‰é’®å¹²å‡€åœ°å…³é—­è¯¥çº¿ç¨‹ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç›¸åŒçš„åŸºæœ¬æ–¹æ³•å°†ä»»ä½•æ•°æ®å‘é€åˆ°æˆ‘ä»¬æƒ³è¦çš„çº¿ç¨‹ä¸­ã€‚ä¸‹é¢æˆ‘ä»¬æ‰©å±•äº†è‡ªå®šä¹‰çš„ `Thread` ç±»ï¼Œæ·»åŠ äº†ä¸€ä¸ª `send_data` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¥å—ä¸€ä¸ªå‚æ•°ï¼Œå¹¶é€šè¿‡ `self` å°†å…¶å†…éƒ¨å­˜å‚¨åœ¨çº¿ç¨‹ä¸­ã€‚

ä½¿ç”¨æ­¤æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥å‘çº¿ç¨‹çš„ `run()` æ–¹æ³•ä¸­å‘é€æ•°æ®ï¼Œå¹¶åœ¨è¯¥æ–¹æ³•ä¸­è®¿é—®è¿™äº›æ•°æ®ï¼Œä»è€Œä¿®æ”¹çº¿ç¨‹çš„è¡Œä¸ºã€‚

*Listing 212. concurrent/qthread_4.py*

```python
import sys
import time

from PyQt6.QtCore import QThread, pyqtSignal, pyqtSlot
from PyQt6.QtWidgets import (
    QApplication,
    QLabel,
    QMainWindow,
    QPushButton,
    QSpinBox,
    QVBoxLayout,
    QWidget,
)


class Thread(QThread):
    """
    å·¥ä½œçº¿ç¨‹
    """
    result = pyqtSignal(str)
    
    @pyqtSlot()
    def run(self):
        """
        æ‚¨çš„ä»£ç åº”æ”¾ç½®åœ¨æ­¤æ–¹æ³•ä¸­ã€‚
        """
        self.data = None
        self.is_running = True
        print("Thread start")
        counter = 0
        while self.is_running:
            while self.data is None:
                time.sleep(0.1) # ç­‰å¾…æ•°æ® <1>.
            # å°†æ•°å­—ä»¥æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„å½¢å¼è¾“å‡º.
            counter += self.data
            self.result.emit(f"The cumulative total is {counter}")
            self.data = None
            
    def send_data(self, data):
        """
        å°†æ•°æ®æ¥æ”¶è‡³å†…éƒ¨å˜é‡
        """
        self.data = data
            
    def stop(self):
        self.is_running = False
        
        
class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        # åˆ›å»ºçº¿ç¨‹å¹¶å¯åŠ¨å®ƒ.
        self.thread = Thread()
        self.thread.start()
        
        self.numeric_input = QSpinBox()
        button_input = QPushButton("Submit number")
        
        label = QLabel("Output will appear here")
        
        button_stop = QPushButton("Shutdown thread")
        # ä¼˜é›…åœ°å…³é—­çº¿ç¨‹.
        button_stop.pressed.connect(self.thread.stop)
        
        # è¿æ¥ä¿¡å·ï¼Œè¿™æ ·å®ƒçš„è¾“å‡ºå°±ä¼šå‡ºç°åœ¨æ ‡ç­¾ä¸Š.
        button_input.pressed.connect(self.submit_data)
        self.thread.result.connect(label.setText)
        self.thread.finished.connect(self.thread_has_finished)
        
        container = QWidget()
        layout = QVBoxLayout()
        layout.addWidget(self.numeric_input)
        layout.addWidget(button_input)
        layout.addWidget(label)
        layout.addWidget(button_stop)
        container.setLayout(layout)
        
        self.setCentralWidget(container)
        self.show()
        
    def submit_data(self):
        # å°†æ•°å­—è¾“å…¥æ§ä»¶ä¸­çš„å€¼æäº¤ç»™çº¿ç¨‹
        self.thread.send_data(self.numeric_input.value())
        
    def thread_has_finished(self):
        print("Thread has finished.")
        
    
app = QApplication(sys.argv)
window = MainWindow()
app.exec()
```

å¦‚æœæ‚¨è¿è¡Œè¿™ä¸ªç¤ºä¾‹ï¼Œæ‚¨ä¼šçœ‹åˆ°ä»¥ä¸‹çª—å£ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ `QSpinBox` é€‰æ‹©ä¸€ä¸ªæ•°å­—ï¼Œç„¶åç‚¹å‡»æŒ‰é’®å°†å…¶æäº¤ç»™çº¿ç¨‹ã€‚çº¿ç¨‹å°†æŠŠä¼ å…¥çš„æ•°å­—åŠ åˆ°å½“å‰è®¡æ•°å™¨ä¸Šå¹¶è¿”å›ç»“æœã€‚

![Figure214](Figure214.png)

> å›¾214ï¼šç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `QSpinBox` å’ŒæŒ‰é’®å‘æˆ‘ä»¬çš„çº¿ç¨‹æäº¤æ•°æ®ã€‚

å¦‚æœæ‚¨ä½¿ç”¨â€œå…³é—­çº¿ç¨‹â€æŒ‰é’®æ¥åœæ­¢çº¿ç¨‹ï¼Œæ‚¨å¯èƒ½ä¼šæ³¨æ„åˆ°ä¸€äº›å¥‡æ€ªçš„åœ°æ–¹ã€‚çº¿ç¨‹ç¡®å®ä¼šå…³é—­ï¼Œä½†ä½ å¯ä»¥åœ¨å®ƒå…³é—­ä¹‹å‰å†æäº¤ä¸€ä¸ªæ•°å­—ï¼Œè€Œè®¡ç®—ä»ç„¶ä¼šè¿›è¡Œâ€”â€”è¯•è¯•çœ‹ï¼è¿™æ˜¯å› ä¸º `is_running` æ£€æŸ¥æ˜¯åœ¨å¾ªç¯çš„é¡¶éƒ¨è¿›è¡Œçš„ï¼Œç„¶åçº¿ç¨‹ä¼šç­‰å¾…è¾“å…¥ã€‚

è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å°†å¯¹ `is_running` æ ‡å¿—çš„æ£€æŸ¥ç§»è‡³ç­‰å¾…å¾ªç¯ä¸­ã€‚

*Listing 213. concurrent/qthread_4b.py*

```python
    @pyqtSlot()
    def run(self):
        """
        æ‚¨çš„ä»£ç åº”æ”¾ç½®åœ¨æ­¤æ–¹æ³•ä¸­ã€‚
        """
        print("Thread start")
        self.data = None
        self.is_running = True
        counter = 0
        while True:
            while self.data is None:
                if not self.is_running:
                    return # Exit thread.
                time.sleep(0.1) # ç­‰å¾…æ•°æ® <1>.
                
                # å°†æ•°å­—ä»¥æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„å½¢å¼è¾“å‡º.
                counter += self.data
                self.result.emit(f"The cumulative total is {counter}")
                self.data = None
```

å¦‚æœæ‚¨ç°åœ¨è¿è¡Œè¿™ä¸ªç¤ºä¾‹ï¼Œæ‚¨ä¼šå‘ç°ï¼Œå¦‚æœåœ¨çº¿ç¨‹ç­‰å¾…æ—¶æŒ‰ä¸‹æŒ‰é’®ï¼Œå®ƒå°†ç«‹å³é€€å‡ºã€‚

![alert](alert.png)

> åœ¨æ‚¨çš„çº¿ç¨‹ä¸­è®¾ç½®çº¿ç¨‹é€€å‡ºæ§åˆ¶æ¡ä»¶æ—¶ï¼Œè¯·åŠ¡å¿…è°¨æ…ï¼Œä»¥é¿å…ä»»ä½•æ„å¤–çš„å‰¯ä½œç”¨ã€‚åœ¨æ‰§è¡Œä»»ä½•æ–°ä»»åŠ¡/è®¡ç®—ä¹‹å‰ï¼Œä»¥åŠåœ¨è¾“å‡ºä»»ä½•æ•°æ®ä¹‹å‰ï¼Œè¯·åŠ¡å¿…è¿›è¡Œæ£€æŸ¥ã€‚

é€šå¸¸ï¼Œæ‚¨è¿˜å¸Œæœ›ä¼ é€’ä¸€äº›åˆå§‹çŠ¶æ€æ•°æ®ï¼Œä¾‹å¦‚ç”¨äºæ§åˆ¶åç»­çº¿ç¨‹è¿è¡Œçš„é…ç½®é€‰é¡¹ã€‚æˆ‘ä»¬å¯ä»¥åƒå¤„ç† `QRunnable` ä¸€æ ·ï¼Œé€šè¿‡åœ¨ `__init__` å—ä¸­æ·»åŠ å‚æ•°æ¥ä¼ é€’è¿™äº›æ•°æ®ã€‚æä¾›çš„å‚æ•°å¿…é¡»å­˜å‚¨åœ¨ `self` å¯¹è±¡ä¸­ï¼Œä»¥ä¾¿åœ¨ `run()` æ–¹æ³•ä¸­ä½¿ç”¨ã€‚

*Listing 214. concurrent/qthread_5.py*

```python
class Thread(QThread):
    """
    å·¥ä½œçº¿ç¨‹
    """
    result = pyqtSignal(str)
    def __init__(self, initial_data):
        super().__init__()
        self.data = initial_data
        
        
class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        # åˆ›å»ºçº¿ç¨‹å¹¶å¯åŠ¨å®ƒ
        self.thread = Thread(500)
        self.thread.start()
        # ...
```

ä½¿ç”¨è¿™ä¸¤ç§æ–¹æ³•ï¼Œæ‚¨å¯ä»¥å‘çº¿ç¨‹æä¾›æ‰€éœ€çš„ä»»ä½•æ•°æ®ã€‚åœ¨çº¿ç¨‹ä¸­ç­‰å¾…æ•°æ®ï¼ˆä½¿ç”¨ `sleep` å¾ªç¯ï¼‰ã€å¤„ç†æ•°æ®å¹¶é€šè¿‡ä¿¡å·è¿”å›æ•°æ®çš„æ¨¡å¼æ˜¯ Qt åº”ç”¨ç¨‹åºä¸­å¤„ç†é•¿æœŸè¿è¡Œçš„çº¿ç¨‹æ—¶æœ€å¸¸è§çš„æ¨¡å¼ã€‚

è®©æˆ‘ä»¬å†æ‰©å±•ä¸€ä¸ªç¤ºä¾‹ï¼Œä»¥æ¼”ç¤ºä¼ é€’å¤šç§æ•°æ®ç±»å‹ã€‚åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä¿®æ”¹çº¿ç¨‹ä»¥ä½¿ç”¨ä¸€ä¸ªæ˜¾å¼é”ï¼Œåä¸º `waiting_for_data`ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶åœ¨ `True` å’Œ `False` ä¹‹é—´åˆ‡æ¢ã€‚æ‚¨å¯ä»¥ä½¿ç”¨è¿™ä¸ª

*Listing 215. concurrent/qthread_6.py*

```python
class Thread(QThread):
    """
    å·¥ä½œçº¿ç¨‹
    """
    result = pyqtSignal(str)
    def __init__(self, initial_counter):
        super().__init__()
        self.counter = initial_counter
        
    
    @pyqtSlot()
    def run(self):
        """
        æ‚¨çš„ä»£ç åº”æ”¾ç½®åœ¨æ­¤æ–¹æ³•ä¸­ã€‚
        """
        print("Thread start")
        self.is_running = True
        self.waiting_for_data = True
        while True:
            while self.waiting_for_data:
                if not self.is_running:
                    return # Exit thread.
                time.sleep(0.1) # ç­‰å¾…æ•°æ® <1>.
                
            # å°†æ•°å­—ä»¥æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„å½¢å¼è¾“å‡º.
            self.counter += self.input_add
            self.counter *= self.input_multiply
            self.result.emit(f"The cumulative total is {self.counter}
")
            self.waiting_for_data = True
            
    def send_data(self, add, multiply):
        """
        å°†æ•°æ®æ¥æ”¶è‡³å†…éƒ¨å˜é‡
        """
        self.input_add = add
        self.input_multiply = multiply
        self.waiting_for_data = False
        
    def stop(self):
        self.is_running = False
        
      
class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        # åˆ›å»ºçº¿ç¨‹å¹¶å¯åŠ¨å®ƒ.
        self.thread = Thread(500)
        self.thread.start()
        
        self.add_input = QSpinBox()
        self.mult_input = QSpinBox()
        button_input = QPushButton("Submit number")
        
        label = QLabel("Output will appear here")
        
        button_stop = QPushButton("Shutdown thread")
        # ä¼˜é›…åœ°å…³é—­çº¿ç¨‹.
        button_stop.pressed.connect(self.thread.stop)
        
        # è¿æ¥ä¿¡å·ï¼Œè¿™æ ·å®ƒçš„è¾“å‡ºå°±ä¼šå‡ºç°åœ¨æ ‡ç­¾ä¸Š.
        button_input.pressed.connect(self.submit_data)
        self.thread.result.connect(label.setText)
        self.thread.finished.connect(self.thread_has_finished)
        
        container = QWidget()
        layout = QVBoxLayout()
        layout.addWidget(self.add_input)
        layout.addWidget(self.mult_input)
        layout.addWidget(button_input)
        layout.addWidget(label)
        layout.addWidget(button_stop)
        container.setLayout(layout)
        
        self.setCentralWidget(container)
        self.show()
        
    def submit_data(self):
        # å°†æ•°å­—è¾“å…¥æ§ä»¶ä¸­çš„å€¼æäº¤ç»™çº¿ç¨‹
        self.thread.send_data(
            self.add_input.value(), self.mult_input.value()
        )
        
    def thread_has_finished(self):
        print("Thread has finished.")
        
    
app = QApplication(sys.argv)
window = MainWindow()
app.exec()
```

æ‚¨è¿˜å¯ä»¥å°†æäº¤æ•°æ®çš„æ–¹æ³•æ‹†åˆ†ä¸ºæ¯ä¸ªå€¼çš„ç‹¬ç«‹æ–¹æ³•ï¼Œå¹¶å®ç°ä¸€ä¸ªæ˜¾å¼çš„è®¡ç®—æ–¹æ³•æ¥é‡Šæ”¾é”ã€‚è¿™ç§æ–¹æ³•ç‰¹åˆ«é€‚åˆåœ¨æ‚¨ä¸éœ€è¦å§‹ç»ˆæ›´æ–°æ‰€æœ‰å€¼çš„æƒ…å†µä¸‹ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼Œå½“æ‚¨ä»å¤–éƒ¨æœåŠ¡æˆ–ç¡¬ä»¶è¯»å–æ•°æ®æ—¶ã€‚

*Listing 216. concurrent/qthread_6b.py*

```python
class Thread(QThread):
    def send_add(self, add):
        self.input_add = add
        
    def send_multiply(self, multiply):
        self.input_multiply = multiply
        
    def calculate(self):
        self.waiting_for_data = False # è§£é”å¹¶è®¡ç®—.
class MainWindow(QMainWindow):
    def submit_data(self):
        # å°†æ•°å­—è¾“å…¥æ§ä»¶ä¸­çš„å€¼æäº¤ç»™çº¿ç¨‹.
        self.thread.send_add(self.add_input.value())
        self.thread.send_multiply(self.mult_input.value())
        self.thread.calculate()
```

å¦‚æœæ‚¨è¿è¡Œè¿™ä¸ªç¤ºä¾‹ï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°ä¸ä¹‹å‰å®Œå…¨ç›¸åŒçš„è¡Œä¸ºã€‚å“ªç§æ–¹æ³•æ‚¨ä½ çš„åº”ç”¨ç¨‹åºä¸­æœ€æœ‰æ„ä¹‰ï¼Œå°†å–å†³äºè¯¥çº¿ç¨‹æ­£åœ¨åšä»€ä¹ˆã€‚

![tips](tips.png)

> ä¸è¦å®³æ€•æ··åˆä½¿ç”¨æ‚¨å­¦åˆ°çš„å„ç§çº¿ç¨‹æŠ€æœ¯ã€‚ä¾‹å¦‚ï¼Œåœ¨æŸäº›åº”ç”¨ç¨‹åºä¸­ï¼Œä½¿ç”¨æŒä¹…çº¿ç¨‹è¿è¡Œåº”ç”¨ç¨‹åºçš„æŸäº›éƒ¨åˆ†ï¼Œè€Œä½¿ç”¨çº¿ç¨‹æ± è¿è¡Œå…¶ä»–éƒ¨åˆ†æ˜¯æœ‰æ„ä¹‰çš„ã€‚

### ä½¿ç”¨è¿‡ç¨‹çš„æ„Ÿå—

å½“ç”¨æˆ·åœ¨åº”ç”¨ç¨‹åºä¸­æ‰§è¡ŒæŸé¡¹æ“ä½œæ—¶ï¼Œè¯¥æ“ä½œçš„åæœåº”ç«‹å³æ˜¾ç°â€”â€”æ— è®ºæ˜¯é€šè¿‡æ“ä½œæœ¬èº«çš„ç»“æœï¼Œè¿˜æ˜¯é€šè¿‡æŸç§æŒ‡ç¤ºï¼Œè¡¨æ˜æ­£åœ¨è¿›è¡Œçš„æ“ä½œå°†äº§ç”Ÿç›¸åº”ç»“æœã€‚è¿™ä¸€ç‚¹å¯¹äºè€—æ—¶è¾ƒé•¿çš„ä»»åŠ¡ï¼ˆå¦‚è®¡ç®—æˆ–ç½‘ç»œè¯·æ±‚ï¼‰å°¤ä¸ºé‡è¦ï¼Œå› ä¸ºç¼ºä¹åé¦ˆå¯èƒ½å¯¼è‡´ç”¨æˆ·åå¤ç‚¹å‡»æŒ‰é’®å´å¾—ä¸åˆ°ä»»ä½•å“åº”ã€‚

![Special14](Special14.png)

> æ—‹è½¬å›¾æ ‡æˆ–åŠ è½½å›¾æ ‡å¯ä»¥ç”¨äºä»¥ä¸‹æƒ…å†µï¼šå½“ä»»åŠ¡çš„æŒç»­æ—¶é—´æœªçŸ¥æˆ–éå¸¸çŸ­æ—¶ã€‚

ä¸€ç§ç®€å•çš„æ–¹æ³•æ˜¯åœ¨æ“ä½œè¢«è§¦å‘åç¦ç”¨æŒ‰é’®ã€‚ä½†æ²¡æœ‰å…¶ä»–æŒ‡ç¤ºå™¨æ—¶ï¼Œè¿™çœ‹èµ·æ¥å°±åƒæ˜¯æ•…éšœã€‚æ›´å¥½çš„æ›¿ä»£æ–¹æ¡ˆæ˜¯æ›´æ–°æŒ‰é’®ï¼Œæ˜¾ç¤ºâ€œæ­£åœ¨å¤„ç†â€çš„æç¤ºï¼Œå¹¶æ·»åŠ ä¸€ä¸ªæ´»è·ƒçš„è¿›åº¦æŒ‡ç¤ºå™¨ï¼Œå¦‚é™„è¿‘çš„æ—‹è½¬å›¾æ ‡ã€‚

è¿›åº¦æ¡æ˜¯ä¸€ç§å¸¸è§çš„æ–¹æ³•ï¼Œç”¨äºå‘ç”¨æˆ·æ˜¾ç¤ºå½“å‰æ­£åœ¨è¿›è¡Œçš„æ“ä½œï¼Œä»¥åŠé¢„è®¡éœ€è¦å¤šé•¿æ—¶é—´ã€‚ä½†ä¸è¦é™·å…¥è®¤ä¸ºè¿›åº¦æ¡æ€»æ˜¯æœ‰ç”¨çš„é™·é˜±ï¼å®ƒä»¬åªåº”åœ¨èƒ½å¤Ÿç›´è§‚å±•ç¤ºä»»åŠ¡çš„çº¿æ€§è¿›å±•æ—¶ä½¿ç”¨ã€‚

![Special15](Special15.png)

> ä¸€äº›å¤æ‚çš„åº”ç”¨ç¨‹åºå¯èƒ½åŒ…å«å¤šä¸ªå¹¶å‘ä»»åŠ¡

---

è¿›åº¦æ¡å¦‚æœå‡ºç°ä»¥ä¸‹æƒ…å†µåˆ™æ¯«æ— å¸®åŠ©ï¼š 

- è¿›åº¦æ¡ä¼šå€’é€€æˆ–å‰è¿›
- è¿›åº¦æ¡çš„å¢é•¿å¹¶éä¸è¿›åº¦æˆçº¿æ€§å…³ç³»
- è¿›åº¦æ¡å®Œæˆå¾—å¤ªå¿«

---

å¦‚æœæ²¡æœ‰è¿™äº›æç¤ºï¼Œå¯èƒ½ä¼šæ¯”å®Œå…¨æ²¡æœ‰ä¿¡æ¯æ›´ä»¤äººæ²®ä¸§ã€‚è¿™äº›è¡Œä¸ºå¯èƒ½ä¼šè®©ç”¨æˆ·æ„Ÿåˆ°äº‹æƒ…ä¸å¯¹åŠ²ï¼Œä»è€Œå¯¼è‡´æ²®ä¸§å’Œå›°æƒ‘â€”â€”â€œæˆ‘é”™è¿‡äº†å“ªä¸ªå¯¹è¯æ¡†ï¼Ÿï¼â€è¿™äº›éƒ½ä¸æ˜¯è®©ç”¨æˆ·æ„Ÿåˆ°æ„‰å¿«çš„ä½“éªŒï¼Œå› æ­¤åº”å°½å¯èƒ½é¿å…ã€‚

è¯·è®°ä½ï¼Œæ‚¨çš„ç”¨æˆ·å¹¶ä¸çŸ¥é“åº”ç”¨ç¨‹åºå†…éƒ¨å‘ç”Ÿäº†ä»€ä¹ˆâ€”â€”ä»–ä»¬å”¯ä¸€çš„äº†è§£æ¸ é“æ˜¯æ‚¨æä¾›çš„æ•°æ®ã€‚åˆ†äº«å¯¹ç”¨æˆ·æœ‰å¸®åŠ©çš„æ•°æ®ï¼Œå¹¶éšè—å…¶ä»–æ‰€æœ‰å†…å®¹ã€‚å¦‚æœæ‚¨éœ€è¦è°ƒè¯•è¾“å‡ºï¼Œå¯ä»¥å°†å…¶æ”¾åœ¨èœå•åé¢ã€‚

---

**è¯·åŠ¡å¿…**ä¸ºè€—æ—¶è¾ƒé•¿çš„ä»»åŠ¡æä¾›è¿›åº¦æ¡ã€‚

**è¯·åŠ¡å¿…**åœ¨é€‚å½“æƒ…å†µä¸‹æä¾›å­ä»»åŠ¡çš„è¯¦ç»†ä¿¡æ¯ã€‚

**è¯·åŠ¡å¿…**åœ¨å¯èƒ½çš„æƒ…å†µä¸‹ä¼°ç®—ä»»åŠ¡æ‰€éœ€æ—¶é—´ã€‚

**ä¸è¦**å‡è®¾ç”¨æˆ·çŸ¥é“å“ªäº›ä»»åŠ¡è€—æ—¶é•¿æˆ–çŸ­ã€‚

**ä¸è¦**ä½¿ç”¨ä¸Šä¸‹ç§»åŠ¨æˆ–ä¸è§„åˆ™ç§»åŠ¨çš„è¿›åº¦æ¡ã€‚

## 28. è¿è¡Œå¤–éƒ¨å‘½ä»¤åŠè¿›ç¨‹

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»æ¢è®¨äº†å¦‚ä½•åœ¨å•ç‹¬çš„çº¿ç¨‹ä¸­è¿è¡Œç¨‹åºï¼ŒåŒ…æ‹¬ä½¿ç”¨Pythonçš„ `subprocess` æ¨¡å—æ¥è¿è¡Œå¤–éƒ¨ç¨‹åºã€‚ä½†åœ¨PyQt6ä¸­ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åˆ©ç”¨åŸºäºQtçš„ç³»ç»Ÿæ¥è¿è¡Œå¤–éƒ¨ç¨‹åºï¼Œå³`QProcess`ã€‚ä½¿ç”¨ `QProcess` åˆ›å»ºå¹¶æ‰§è¡Œä»»åŠ¡ç›¸å¯¹ç®€å•ã€‚

æœ€ç®€å•çš„ç¤ºä¾‹å¦‚ä¸‹æ‰€ç¤ºâ€”â€”æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª `QProcess` å¯¹è±¡ï¼Œç„¶åè°ƒç”¨ `.start` æ–¹æ³•ï¼Œä¼ å…¥è¦æ‰§è¡Œçš„å‘½ä»¤å’Œä¸€ä¸ªå­—ç¬¦ä¸²å‚æ•°åˆ—è¡¨ã€‚åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬æ­£åœ¨è¿è¡Œè‡ªå®šä¹‰æ¼”ç¤ºè„šæœ¬ï¼Œä½¿ç”¨ Python å‘½ä»¤ï¼š`python dummy_script.py`ã€‚

```python
p = QProcess()
p.start("python", ["dummy_script.py"])
```

![tips](tips.png)

> æ ¹æ®æ‚¨çš„ç¯å¢ƒï¼Œæ‚¨å¯èƒ½éœ€è¦æŒ‡å®š `python3` è€Œä¸æ˜¯ `python`

![caution](caution.png)

> æ‚¨éœ€è¦åœ¨ `QProcess` å®ä¾‹è¿è¡ŒæœŸé—´ï¼Œå°†å…¶å¼•ç”¨ä¿å­˜åœ¨ `self` æˆ–å…¶ä»–ä½ç½®ã€‚

å¦‚æœæ‚¨åªæ˜¯æƒ³è¿è¡Œä¸€ä¸ªç¨‹åºï¼Œè€Œä¸å…³å¿ƒå®ƒä¼šå‘ç”Ÿä»€ä¹ˆï¼Œé‚£ä¹ˆè¿™ä¸ªç®€å•çš„ä¾‹å­å°±è¶³å¤Ÿäº†ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ‚¨æƒ³æ›´å¤šåœ°äº†è§£ç¨‹åºåœ¨åšä»€ä¹ˆï¼Œ`QProcess` æä¾›äº†ä¸€äº›ä¿¡å·ï¼Œå¯ä»¥ç”¨æ¥è·Ÿè¸ªè¿›ç¨‹çš„è¿›åº¦å’ŒçŠ¶æ€ã€‚

æœ€æœ‰ç”¨çš„äº‹ä»¶æ˜¯ `.readyReadStandardOutput` å’Œ `.readyReadStandardError`ï¼Œè¿™äº›äº‹ä»¶ä¼šåœ¨è¿›ç¨‹ä¸­æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯å‡†å¤‡å¥½è¢«è¯»å–æ—¶è§¦å‘ã€‚æ‰€æœ‰è¿è¡Œçš„è¿›ç¨‹éƒ½æœ‰ä¸¤ä¸ªè¾“å‡ºæµâ€”â€”æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯ã€‚æ ‡å‡†è¾“å‡ºè¿”å›æ‰§è¡Œç»“æœï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œè€Œæ ‡å‡†é”™è¯¯è¿”å›ä»»ä½•é”™è¯¯æˆ–å¼‚å¸¸ã€‚

```python
p = QProcess()
p.readyReadStandardOutput.connect(self.handle_stdout)
p.readyReadStandardError.connect(self.handle_stderr)
p.stateChanged.connect(self.handle_state)
p.finished.connect(self.cleanup)
p.start("python", ["dummy_script.py"])
```

æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªåœ¨è¿›ç¨‹å®Œæˆæ—¶è§¦å‘çš„ `.finished` ä¿¡å·ï¼Œä»¥åŠä¸€ä¸ªåœ¨è¿›ç¨‹çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶è§¦å‘çš„ `.stateChanged` ä¿¡å·ã€‚æœ‰æ•ˆå€¼ï¼ˆåœ¨ `QProcess.ProcessState` æšä¸¾ä¸­å®šä¹‰ï¼‰å¦‚ä¸‹æ‰€ç¤ºã€‚

| å¸¸é‡                | å€¼   | æè¿°                                   |
| ------------------- | ---- | -------------------------------------- |
| QProcess.NotRunning | 0    | è¯¥è¿›ç¨‹æœªè¿è¡Œ                           |
| QProcess.Starting   | 1    | è¿›ç¨‹å·²å¯åŠ¨ï¼Œä½†ç¨‹åºå°šæœªè¢«è°ƒç”¨           |
| QProcess.Running    | 2    | è¯¥è¿›ç¨‹æ­£åœ¨è¿è¡Œï¼Œå¹¶å·²å‡†å¤‡å¥½è¿›è¡Œè¯»å†™æ“ä½œ |

åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªåŸºæœ¬çš„ `QProcess` è®¾ç½®æ‰©å±•ï¼Œä¸ºæ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯æ·»åŠ å¤„ç†ç¨‹åºã€‚é€šçŸ¥æ•°æ®å¯ç”¨çš„ä¿¡å·è¿æ¥åˆ°è¿™äº›å¤„ç†ç¨‹åºï¼Œå¹¶ä½¿ç”¨ `.readAllStandardError()` å’Œ `.readAllStandardOutput()` è§¦å‘å¯¹è¿›ç¨‹æ•°æ®çš„è¯·æ±‚ã€‚

![information](information.png)

> è¿™äº›æ–¹æ³•è¾“å‡ºåŸå§‹å­—èŠ‚ï¼Œå› æ­¤æ‚¨éœ€è¦å…ˆå¯¹å…¶è¿›è¡Œè§£ç ã€‚

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬çš„æ¼”ç¤ºè„šæœ¬ `dummy_script.py` è¿”å›ä¸€ç³»åˆ—å­—ç¬¦ä¸²ï¼Œè¿™äº›å­—ç¬¦ä¸²ä¼šè¢«è§£æä»¥æä¾›è¿›åº¦ä¿¡æ¯å’Œç»“æ„åŒ–æ•°æ®ã€‚è¿‡ç¨‹çš„çŠ¶æ€ä¹Ÿä¼šæ˜¾ç¤ºåœ¨çŠ¶æ€æ ä¸Šã€‚

å®Œæ•´çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

*Listing 217. concurrent/qprocess.py*

```python
import re
import sys

from PyQt6.QtCore import QProcess
from PyQt6.QtWidgets import (
    QApplication,
    QMainWindow,
    QPlainTextEdit,
    QProgressBar,
    QPushButton,
    QVBoxLayout,
    QWidget,
)

STATES = {
    QProcess.ProcessState.NotRunning: "Not running",
    QProcess.ProcessState.Starting: "Starting...",
    QProcess.ProcessState.Running: "Running...",
}

progress_re = re.compile("Total complete: (\d+)%")


def simple_percent_parser(output):
    """
    ä½¿ç”¨ progress_re æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…è¡Œï¼Œ
    è¿”å›ä¸€ä¸ªæ•´æ•°è¡¨ç¤ºç™¾åˆ†æ¯”è¿›åº¦ã€‚
    """
    m = progress_re.search(output)
    if m:
        pc_complete = m.group(1)
        return int(pc_complete)
    
    
def extract_vars(l):
    """
    ä»è¡Œä¸­æå–å˜é‡ï¼ŒæŸ¥æ‰¾åŒ…å«ç­‰å·çš„è¡Œï¼Œå¹¶æ‹†åˆ†ä¸ºé”®å€¼å¯¹ã€‚
    """
    data = {}
    for s in l.splitlines():
        if "=" in s:
            name, value = s.split("=")
            data[name] = value
    return data


class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        
        # ä¿æŒè¿›ç¨‹å¼•ç”¨.
        self.p = None
        
        layout = QVBoxLayout()
        
        self.text = QPlainTextEdit()
        layout.addWidget(self.text)
        
        self.progress = QProgressBar()
        layout.addWidget(self.progress)
        
        btn_run = QPushButton("Execute")
        btn_run.clicked.connect(self.start)
        
        layout.addWidget(btn_run)
        
        w = QWidget()
        w.setLayout(layout)
        self.setCentralWidget(w)
        
        self.show()
        
    def start(self):
        if self.p is not None:
            return
        
        self.p = QProcess()
        self.p.readyReadStandardOutput.connect(self.handle_stdout)
        self.p.readyReadStandardError.connect(self.handle_stderr)
        self.p.stateChanged.connect(self.handle_state)
        self.p.finished.connect(self.cleanup)
        self.p.start("python", ["dummy_script.py"])
        
    def handle_stderr(self):
        result = bytes(self.p.readAllStandardError()).decode("utf8")
        progress = simple_percent_parser(result)
        
        self.progress.setValue(progress)
        
    def handle_stdout(self):
        result = bytes(self.p.readAllStandardOutput()).decode("utf8")
        data = extract_vars(result)
        
        self.text.appendPlainText(str(data))
        
    def handle_state(self, state):
        self.statusBar().showMessage(STATES[state])
        
    def cleanup(self):
        self.p = None
        
        
app = QApplication(sys.argv)
w = MainWindow()
app.exec()
```

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†è¿›ç¨‹çš„å¼•ç”¨å­˜å‚¨åœ¨ `self.p` ä¸­ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬ä¸€æ¬¡åªèƒ½è¿è¡Œä¸€ä¸ªè¿›ç¨‹ã€‚ä½†æ‚¨å¯ä»¥è‡ªç”±åœ°ä¸åº”ç”¨ç¨‹åºä¸€èµ·è¿è¡Œä»»æ„å¤šä¸ªè¿›ç¨‹ã€‚å¦‚æœæ‚¨ä¸éœ€è¦è·Ÿè¸ªæ¥è‡ªè¿™äº›è¿›ç¨‹çš„ä¿¡æ¯ï¼Œæ‚¨å¯ä»¥ç®€å•åœ°å°†è¿›ç¨‹çš„å¼•ç”¨å­˜å‚¨åœ¨åˆ—è¡¨ä¸­ã€‚

ä½†æ˜¯ï¼Œå¦‚æœæ‚¨æƒ³è·Ÿè¸ªè¿›åº¦å¹¶å•ç‹¬è§£æå·¥ä½œè¿›ç¨‹çš„è¾“å‡ºï¼Œæ‚¨å¯èƒ½éœ€è¦è€ƒè™‘åˆ›å»ºä¸€ä¸ªç®¡ç†ç±»æ¥æ»‘å—å’Œè·Ÿè¸ªæ‰€æœ‰è¿›ç¨‹ã€‚æœ¬ä¹¦çš„æºæ–‡ä»¶ä¸­æœ‰ä¸€ä¸ªç¤ºä¾‹ï¼Œåä¸º `qprocess_manager.py`ã€‚

ç¤ºä¾‹çš„å®Œæ•´æºä»£ç å¯åœ¨æœ¬ä¹¦çš„æºä»£ç ä¸­æ‰¾åˆ°ï¼Œä½†ä¸‹é¢æˆ‘ä»¬å°†é‡ç‚¹æ¢è®¨ `JobManager` ç±»æœ¬èº«ã€‚

*Listing 218. concurrent/qprocess_manager.py*

```python
class JobManager(QAbstractListModel):
    """
    ç®¡ç†å™¨ï¼Œç”¨äºå¤„ç†æ´»åŠ¨ä½œä¸šã€æ ‡å‡†è¾“å‡ºã€æ ‡å‡†é”™è¯¯å’Œè¿›åº¦è§£æå™¨ã€‚
    è¿˜ä½œä¸ºè§†å›¾çš„ Qt æ•°æ®æ¨¡å‹ï¼Œæ˜¾ç¤ºæ¯ä¸ªè¿›ç¨‹çš„è¿›åº¦ã€‚
    """
    _jobs = {}
    _state = {}
    _parsers = {}

    status = pyqtSignal(str)
    result = pyqtSignal(str, object)
    progress = pyqtSignal(str, int)

    def __init__(self):
        super().__init__()
        
        self.status_timer = QTimer()
        self.status_timer.setInterval(100)
        self.status_timer.timeout.connect(self.notify_status)
        self.status_timer.start()
        
        # å†…éƒ¨ä¿¡å·ï¼Œé€šè¿‡è§£æå™¨è§¦å‘è¿›åº¦æ›´æ–°.
        self.progress.connect(self.handle_progress)
        
    def notify_status(self):
        n_jobs = len(self._jobs)
        self.status.emit("{} jobs".format(n_jobs))
        
    def execute(self, command, arguments, parsers=None):
        """
        é€šè¿‡å¯åŠ¨ä¸€ä¸ªæ–°è¿›ç¨‹æ¥æ‰§è¡Œå‘½ä»¤
        """
        job_id = uuid.uuid4().hex
        
        # é»˜è®¤æƒ…å†µä¸‹ï¼Œä¿¡å·æ— æ³•è®¿é—®å‘é€å®ƒçš„è¿›ç¨‹çš„ä»»ä½•ä¿¡æ¯ã€‚å› æ­¤ï¼Œæˆ‘ä»¬ä½¿ç”¨æ­¤æ„é€ å‡½æ•°ä¸ºæ¯ä¸ªä¿¡å·æ·»åŠ  job_id æ³¨é‡Šã€‚
        
        def fwd_signal(target):
            return lambda *args: target(job_id, *args)
        
        self._parsers[job_id] = parsers or []
        
        # å°†é»˜è®¤çŠ¶æ€è®¾ç½®ä¸ºç­‰å¾…ï¼Œè¿›åº¦ä¸º0ã€‚
        self._state[job_id] = DEFAULT_STATE.copy()
        
        p = QProcess()
        p.readyReadStandardOutput.connect(
            fwd_signal(self.handle_output)
        )
        p.readyReadStandardError.connect(fwd_signal(self.
                                                    handle_output))
        p.stateChanged.connect(fwd_signal(self.handle_state))
        p.finished.connect(fwd_signal(self.done))
        
        self._jobs[job_id] = p
        
        p.start(command, arguments)
        
        self.layoutChanged.emit()
        
    def handle_output(self, job_id):
        p = self._jobs[job_id]
        stderr = bytes(p.readAllStandardError()).decode("utf8")
        stdout = bytes(p.readAllStandardOutput()).decode("utf8")
        output = stderr + stdout
        
        parsers = self._parsers.get(job_id)
        for parser, signal_name in parsers:
            # ä¾æ¬¡ä½¿ç”¨æ¯ä¸ªè§£æå™¨å¯¹æ•°æ®è¿›è¡Œè§£æ.
            result = parser(output)
            if result:
                # æŒ‰åç§°ï¼ˆä½¿ç”¨ signal_nameï¼‰æŸ¥æ‰¾ä¿¡å·ï¼Œå¹¶è¾“å‡ºè§£æç»“æœ.
                signal = getattr(self, signal_name)
                signal.emit(job_id, result)
                
    def handle_progress(self, job_id, progress):
        self._state[job_id]["progress"] = progress
        self.layoutChanged.emit()
        
    def handle_state(self, job_id, state):
        self._state[job_id]["status"] = state
        self.layoutChanged.emit()
        
    def done(self, job_id, exit_code, exit_status):
        """
        ä»»åŠ¡/å·¥ä½œè¿›ç¨‹å·²å®Œæˆã€‚å°†å…¶ä»æ´»åŠ¨å·¥ä½œè€…å­—å…¸ä¸­ç§»é™¤ã€‚
        æˆ‘ä»¬å°†å…¶ä¿ç•™åœ¨å·¥ä½œè¿›ç¨‹çŠ¶æ€ä¸­ï¼Œå› ä¸ºè¿™ç”¨äºæ˜¾ç¤ºè¿‡å»/å·²å®Œæˆçš„å·¥ä½œè¿›ç¨‹ã€‚
        """
        del self._jobs[job_id]
        self.layoutChanged.emit()
        
    def cleanup(self):
        """
        ä» worker_state ä¸­ç§»é™¤æ‰€æœ‰å·²å®Œæˆæˆ–å¤±è´¥çš„ä»»åŠ¡ã€‚
        """
        for job_id, s in list(self._state.items()):
            if s["status"] == QProcess.ProcessState.NotRunning:
                del self._state[job_id]
        self.layoutChanged.emit()
        
    # æ¨¡å‹æ¥å£
    def data(self, index, role):
        if role == Qt.ItemDataRole.DisplayRole:
            # è¯·å‚è§ä¸‹æ–‡çš„æ•°æ®ç»“æ„.
            job_ids = list(self._state.keys())
            job_id = job_ids[index.row()]
            return job_id, self._state[job_id]
        
    def rowCount(self, index):
        return len(self._state)
```

æœ¬ç±»æä¾›äº†ä¸€ä¸ªæ¨¡å‹è§†å›¾æ¥å£ï¼Œä½¿å…¶å¯ä½œä¸º `QListView` çš„åŸºç¡€ã€‚è‡ªå®šä¹‰å§”æ‰˜ `ProgressBarDelegate` å§”æ‰˜ä¸ºæ¯ä¸ªé¡¹ç»˜åˆ¶è¿›åº¦æ¡ï¼Œå¹¶æ˜¾ç¤ºä»»åŠ¡æ ‡è¯†ç¬¦ã€‚è¿›åº¦æ¡çš„é¢œè‰²ç”±è¿›ç¨‹çŠ¶æ€å†³å®šâ€”â€”è‹¥å¤„äºæ´»åŠ¨çŠ¶æ€åˆ™ä¸ºæ·±ç»¿è‰²ï¼Œè‹¥å·²å®Œæˆåˆ™ä¸ºæµ…ç»¿è‰²ã€‚

åœ¨æ­¤è®¾ç½®ä¸­ï¼Œè§£ææ¥è‡ªå·¥ä½œè¿›ç¨‹çš„è¿›åº¦ä¿¡æ¯æ¯”è¾ƒæ£˜æ‰‹ï¼Œå› ä¸º `.readyReadStandardError` å’Œ `.readyReadStandardOutput` ä¿¡å·ä¸ä¼šä¼ é€’æ•°æ®æˆ–å…³äºå·²å‡†å¤‡å°±ç»ªçš„å·¥ä½œçš„ä¿¡æ¯ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å®šä¹‰äº†è‡ªå®šä¹‰çš„ `job_id`ï¼Œå¹¶æ‹¦æˆªä¿¡å·ä»¥å°†æ­¤æ•°æ®æ·»åŠ åˆ°å®ƒä»¬ä¸­ã€‚

è§£æå™¨åœ¨æ‰§è¡Œå‘½ä»¤æ—¶è¢«ä¼ é€’è¿›æ¥å¹¶å­˜å‚¨åœ¨ `_parsers` ä¸­ã€‚æ¯ä¸ªä»»åŠ¡æ¥æ”¶çš„è¾“å‡ºä¼šé€šè¿‡ç›¸åº”çš„è§£æå™¨å¤„ç†ï¼Œç”¨äºè¾“å‡ºæ•°æ®æˆ–æ›´æ–°ä»»åŠ¡çš„è¿›åº¦ã€‚æˆ‘ä»¬å®šä¹‰äº†ä¸¤ä¸ªç®€å•çš„è§£æå™¨ï¼šä¸€ä¸ªç”¨äºæå–å½“å‰è¿›åº¦ï¼Œå¦ä¸€ä¸ªç”¨äºè·å–è¾“å‡ºæ•°æ®ã€‚

*Listing 219. concurrent/qprocess_manager.py*

```python
progress_re = re.compile("Total complete: (\d+)%", re.M)

def simple_percent_parser(output):
    """
    ä½¿ç”¨ progress_re æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…è¡Œï¼Œ
    è¿”å›ä¸€ä¸ªæ•´æ•°è¡¨ç¤ºç™¾åˆ†æ¯”è¿›åº¦ã€‚
    """
    m = progress_re.search(output)
    if m:
        pc_complete = m.group(1)
        return int(pc_complete)
    
def extract_vars(l):
    """
    ä»è¡Œä¸­æå–å˜é‡ï¼ŒæŸ¥æ‰¾åŒ…å«ç­‰å·çš„è¡Œï¼Œå¹¶æ‹†åˆ†ä¸ºé”®å€¼å¯¹ã€‚
    """
    data = {}
    for s in l.splitlines():
        if "=" in s:
            name, value = s.split("=")
            data[name] = value
    return data
```

è§£æå™¨ä½œä¸ºä¸€ä¸ªç®€å•çš„å…ƒç»„åˆ—è¡¨ä¼ é€’ï¼Œè¯¥åˆ—è¡¨åŒ…å«ç”¨ä½œè§£æå™¨çš„å‡½æ•°å’Œè¦å‘å‡ºçš„ä¿¡å·çš„åç§°ã€‚ä¿¡å·é€šè¿‡åœ¨ `JobManager` ä¸Šä½¿ç”¨ `getattr` æ ¹æ®åç§°è¿›è¡ŒæŸ¥æ‰¾ã€‚åœ¨ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åªå®šä¹‰äº† 2 ä¸ªä¿¡å·ï¼Œä¸€ä¸ªç”¨äºæ•°æ®/ç»“æœè¾“å‡ºï¼Œå¦ä¸€ä¸ªç”¨äºè¿›åº¦ã€‚ä½†æ‚¨å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ ä»»æ„æ•°é‡çš„ä¿¡å·å’Œè§£æå™¨ã€‚ä½¿ç”¨è¿™ç§æ–¹æ³•ï¼Œæ‚¨å¯ä»¥æ ¹æ®éœ€è¦é€‰æ‹©çœç•¥æŸäº›ä»»åŠ¡çš„æŸäº›è§£æå™¨ï¼ˆä¾‹å¦‚ï¼Œæ²¡æœ‰è¿›åº¦ä¿¡æ¯çš„æƒ…å†µä¸‹ï¼‰ã€‚

æ‚¨å¯ä»¥è¿è¡Œç¤ºä¾‹ä»£ç ï¼Œå¹¶åœ¨å¦ä¸€ä¸ªè¿›ç¨‹ä¸­è¿è¡Œä»»åŠ¡ã€‚æ‚¨å¯ä»¥å¯åŠ¨å¤šä¸ªä»»åŠ¡ï¼Œå¹¶è§‚å¯Ÿå®ƒä»¬çš„å®Œæˆæƒ…å†µï¼ŒåŒæ—¶å®æ—¶æ›´æ–°å…¶å½“å‰è¿›åº¦ã€‚å°è¯•ä¸ºè‡ªå·±çš„ä»»åŠ¡æ·»åŠ é¢å¤–çš„å‘½ä»¤å’Œè§£æå™¨ã€‚

![Figure215](Figure215.png)

> å›¾215ï¼šè¿›ç¨‹ç®¡ç†å™¨ï¼Œæ˜¾ç¤ºæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹å’Œè¿›åº¦
